<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ç™ºå±•25 ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½</title>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="../promptpg-step/style.css" />
        <style>
  :root {
    --primary: #AF52DE;
    --primary-dark: #9333EA;
    --primary-light: #FAF5FF;
    --primary-lighter: #E9D5FF;
  }
  .nav-category-links { display: none; }
</style>
        <style>
            .download-btn { background: #22c55e; color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-left: auto; }
            .code-header { display: flex; align-items: center; justify-content: space-between; }
            .level-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #fce7f3; color: #be185d; margin-right: 8px; }
        </style>
    </head>
    <body>
        <nav class="global-nav">
            <div class="nav-container">
                <a href="01_extends-todo.html" class="nav-logo"><span class="nav-logo-icon">ğŸŒ±</span><span>æ©Ÿèƒ½è¿½åŠ </span></a>
                <button class="nav-toggle" onclick="toggleMenu()"><span></span><span></span><span></span></button>
                <div class="nav-menu">
                    <div class="nav-menu-title">ğŸ“˜ åˆç´šãƒ¬ãƒ™ãƒ«</div>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="01_extends-todo.html" class="nav-link"><span class="nav-chapter-num">1</span><span>æ©Ÿèƒ½è¿½åŠ ææ¡ˆ</span></a></li>
                        <li class="nav-item"><a href="02_validation.html" class="nav-link"><span class="nav-chapter-num">2</span><span>å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</span></a></li>
                        <li class="nav-item"><a href="03_status.html" class="nav-link"><span class="nav-chapter-num">3</span><span>å®Œäº†/æœªå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span></a></li>
                        <li class="nav-item"><a href="04_search.html" class="nav-link"><span class="nav-chapter-num">4</span><span>æ¤œç´¢æ©Ÿèƒ½</span></a></li>
                        <li class="nav-item"><a href="05_sort.html" class="nav-link"><span class="nav-chapter-num">5</span><span>ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½</span></a></li>
                        <li class="nav-item"><a href="06_delete_dialog.html" class="nav-link"><span class="nav-chapter-num">6</span><span>å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°</span></a></li>
                    </ul>
                    <div class="nav-menu-title" style="margin-top: 1rem;">ğŸ“— ä¸­ç´šãƒ¬ãƒ™ãƒ«</div>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="07_pagination.html" class="nav-link"><span class="nav-chapter-num">7</span><span>ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³</span></a></li>
                        <li class="nav-item"><a href="08_priority.html" class="nav-link"><span class="nav-chapter-num">8</span><span>å„ªå…ˆåº¦è¨­å®š</span></a></li>
                        <li class="nav-item"><a href="09_category.html" class="nav-link"><span class="nav-chapter-num">9</span><span>ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</span></a></li>
                        <li class="nav-item"><a href="10_deadline.html" class="nav-link"><span class="nav-chapter-num">10</span><span>æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</span></a></li>
                        <li class="nav-item"><a href="11_bulk_delete.html" class="nav-link"><span class="nav-chapter-num">11</span><span>ä¸€æ‹¬å‰Šé™¤</span></a></li>
                        <li class="nav-item"><a href="12_csv_export.html" class="nav-link"><span class="nav-chapter-num">12</span><span>CSVå‡ºåŠ›</span></a></li>
                    </ul>
                    <div class="nav-menu-title" style="margin-top: 1rem;">ğŸ“• ä¸Šç´šãƒ¬ãƒ™ãƒ«</div>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="13_login.html" class="nav-link"><span class="nav-chapter-num">13</span><span>ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼</span></a></li>
                        <li class="nav-item"><a href="14_user_todo.html" class="nav-link"><span class="nav-chapter-num">14</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ToDo</span></a></li>
                        <li class="nav-item"><a href="15_role.html" class="nav-link"><span class="nav-chapter-num">15</span><span>ãƒ­ãƒ¼ãƒ«åˆ¥æ¨©é™</span></a></li>
                        <li class="nav-item"><a href="16_rest_api.html" class="nav-link"><span class="nav-chapter-num">16</span><span>REST API</span></a></li>
                        <li class="nav-item"><a href="17_exception.html" class="nav-link"><span class="nav-chapter-num">17</span><span>ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</span></a></li>
                        <li class="nav-item"><a href="18_aop.html" class="nav-link"><span class="nav-chapter-num">18</span><span>AOP</span></a></li>
                        <li class="nav-item"><a href="19_transaction.html" class="nav-link"><span class="nav-chapter-num">19</span><span>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</span></a></li>
                    </ul>
                    <div class="nav-menu-title" style="margin-top: 1rem;">ğŸ“™ ç™ºå±•ãƒ¬ãƒ™ãƒ«</div>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="20_file_upload.html" class="nav-link"><span class="nav-chapter-num">20</span><span>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</span></a></li>
                        <li class="nav-item"><a href="21_i18n.html" class="nav-link"><span class="nav-chapter-num">21</span><span>å›½éš›åŒ–</span></a></li>
                        <li class="nav-item"><a href="22_unit_test.html" class="nav-link"><span class="nav-chapter-num">22</span><span>å˜ä½“ãƒ†ã‚¹ãƒˆ</span></a></li>
                        <li class="nav-item"><a href="23_async.html" class="nav-link"><span class="nav-chapter-num">23</span><span>éåŒæœŸå‡¦ç†</span></a></li>
                        <li class="nav-item"><a href="24_mail.html" class="nav-link"><span class="nav-chapter-num">24</span><span>ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</span></a></li>
                        <li class="nav-item"><a href="25_audit_log.html" class="nav-link active"><span class="nav-chapter-num">25</span><span>ç›£æŸ»ãƒ­ã‚°</span></a></li>
                        <li class="nav-item"><a href="26_javadoc.html" class="nav-link"><span class="nav-chapter-num">26</span><span>Javadoc</span></a></li>
                    </ul>
                    <div class="nav-menu-title" style="margin-top: 1rem;">ğŸ”— é–¢é€£æ•™æ</div>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../../java_tutorials_unified/1java-overview.html" class="nav-link"><span>JavaåŸºç¤</span></a></li>
                        <li class="nav-item"><a href="../../spring_tutorials_unified/1spring-framework-tutorial.html" class="nav-link"><span>Springå…¥é–€</span></a></li>
                        <li class="nav-item"><a href="../../ai/promptpg-all/index.html" class="nav-link"><span>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆPG</span></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <header class="chapter-header">
                <div class="chapter-badge"><span class="level-badge">ç™ºå±•</span>ğŸ“— Expert</div>
                <div class="chapter-number">25</div>
                <h1 class="chapter-title">ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½</h1>
            </header>

            <nav class="toc">
                <h2 class="toc-title"><span class="material-icons">list_alt</span> ã“ã®ç« ã®å†…å®¹</h2>
                <ul class="toc-list">
                    <li class="toc-item"><span class="toc-number">24-1</span><span>ç›£æŸ»ãƒ­ã‚°ã®è¨­è¨ˆ</span></li>
                    <li class="toc-item"><span class="toc-number">24-2</span><span>AOPã§è‡ªå‹•è¨˜éŒ²</span></li>
                    <li class="toc-item"><span class="toc-number">24-3</span><span>ç›£æŸ»ãƒ­ã‚°ã®æ¤œç´¢ãƒ»è¡¨ç¤º</span></li>
                </ul>
            </nav>

            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 24-1</span>
                    <h2 class="section-title">ç›£æŸ»ãƒ­ã‚°ã®è¨­è¨ˆ</h2>
                </div>
                <div class="intro-text">
                    <p><strong>èª°ãŒã€ã„ã¤ã€ä½•ã‚’å¤‰æ›´ã—ãŸã‹</strong>ã‚’è¨˜éŒ²ã™ã‚‹ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                </div>

                <div class="module-list">
                    <div class="module-item"><div class="module-icon">ğŸ“</div><div class="module-content"><h4>ç›£æŸ»ãƒ­ã‚°</h4><p>æ“ä½œå±¥æ­´ã‚’è¨˜éŒ²ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿</p></div></div>
                    <div class="module-item"><div class="module-icon">ğŸ”</div><div class="module-content"><h4>AOP</h4><p>æ¨ªæ–­çš„ã«ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²</p></div></div>
                </div>

                <div class="code-block" id="sql">
                    <div class="code-header">
                        <span class="code-title">schema.sqlï¼ˆç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('sql', 'audit_log.sql')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>-- ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE audit_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    action VARCHAR(50) NOT NULL,           -- æ“ä½œç¨®åˆ¥ï¼ˆCREATE, UPDATE, DELETEï¼‰
    entity_type VARCHAR(50) NOT NULL,      -- å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆTODO, USERç­‰ï¼‰
    entity_id INT,                          -- å¯¾è±¡ã®ID
    user_id INT,                            -- æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    username VARCHAR(100),                  -- æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å
    old_value TEXT,                         -- å¤‰æ›´å‰ã®å€¤ï¼ˆJSONï¼‰
    new_value TEXT,                         -- å¤‰æ›´å¾Œã®å€¤ï¼ˆJSONï¼‰
    ip_address VARCHAR(45),                 -- IPã‚¢ãƒ‰ãƒ¬ã‚¹
    user_agent VARCHAR(500),                -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_user (user_id),
    INDEX idx_created_at (created_at)
);

-- ä¾‹: æ“ä½œãƒ­ã‚°ã®æ¤œç´¢ç”¨ãƒ“ãƒ¥ãƒ¼
CREATE VIEW v_audit_logs AS
SELECT
    a.id,
    a.action,
    a.entity_type,
    a.entity_id,
    u.username,
    a.created_at,
    CASE a.action
        WHEN 'CREATE' THEN CONCAT(a.entity_type, 'ã‚’ä½œæˆ')
        WHEN 'UPDATE' THEN CONCAT(a.entity_type, 'ã‚’æ›´æ–°')
        WHEN 'DELETE' THEN CONCAT(a.entity_type, 'ã‚’å‰Šé™¤')
    END as action_description
FROM audit_logs a
LEFT JOIN users u ON a.user_id = u.id;</code></pre>
                    </div>
                </div>

                <div class="code-block" id="entity">
                    <div class="code-header">
                        <span class="code-title">AuditLog.javaï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('entity', 'AuditLog.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>public class AuditLog {
    private Integer id;
    private String action;        // CREATE, UPDATE, DELETE
    private String entityType;    // TODO, USER ãªã©
    private Integer entityId;
    private Integer userId;
    private String username;
    private String oldValue;      // JSONå½¢å¼
    private String newValue;      // JSONå½¢å¼
    private String ipAddress;
    private String userAgent;
    private LocalDateTime createdAt;

    // Enum for action types
    public enum Action {
        CREATE, READ, UPDATE, DELETE
    }

    // getter/setterçœç•¥
}</code></pre>
                    </div>
                </div>

                <div class="code-block" id="service">
                    <div class="code-header">
                        <span class="code-title">AuditLogService.java</span>
                        <button class="download-btn" onclick="downloadCode('service', 'AuditLogService.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

@Service
public class AuditLogService {

    private final AuditLogMapper auditLogMapper;
    private final ObjectMapper objectMapper;

    /**
     * ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
     * REQUIRES_NEW: æœ¬ä½“ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã‚‚ç›£æŸ»ãƒ­ã‚°ã¯æ®‹ã™
     */
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void log(AuditLog.Action action, String entityType,
                    Integer entityId, Object oldValue, Object newValue) {

        AuditLog log = new AuditLog();
        log.setAction(action.name());
        log.setEntityType(entityType);
        log.setEntityId(entityId);

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        SecurityContext context = SecurityContextHolder.getContext();
        if (context.getAuthentication() != null) {
            log.setUserId(getCurrentUserId());
            log.setUsername(context.getAuthentication().getName());
        }

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
        try {
            if (oldValue != null) {
                log.setOldValue(objectMapper.writeValueAsString(oldValue));
            }
            if (newValue != null) {
                log.setNewValue(objectMapper.writeValueAsString(newValue));
            }
        } catch (Exception e) {
            log.setOldValue(String.valueOf(oldValue));
            log.setNewValue(String.valueOf(newValue));
        }

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
        HttpServletRequest request = getCurrentRequest();
        if (request != null) {
            log.setIpAddress(getClientIp(request));
            log.setUserAgent(request.getHeader("User-Agent"));
        }

        log.setCreatedAt(LocalDateTime.now());

        auditLogMapper.insert(log);
    }

    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty()) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}</code></pre>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 24-2</span>
                    <h2 class="section-title">AOPã§è‡ªå‹•è¨˜éŒ²</h2>
                </div>

                <div class="code-block" id="annotation">
                    <div class="code-header">
                        <span class="code-title">Auditable.javaï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('annotation', 'Auditable.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>import java.lang.annotation.*;

/**
 * ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã«ä»˜ä¸ã™ã‚‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface Auditable {
    /**
     * æ“ä½œç¨®åˆ¥
     */
    AuditLog.Action action();

    /**
     * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç¨®åˆ¥
     */
    String entityType();
}</code></pre>
                    </div>
                </div>

                <div class="code-block" id="aspect">
                    <div class="code-header">
                        <span class="code-title">AuditAspect.javaï¼ˆAOPã§è‡ªå‹•è¨˜éŒ²ï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('aspect', 'AuditAspect.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class AuditAspect {

    private final AuditLogService auditLogService;

    @Around("@annotation(auditable)")
    public Object audit(ProceedingJoinPoint joinPoint, Auditable auditable) throws Throwable {

        // ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œå‰ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆUPDATE/DELETEã®å ´åˆï¼‰
        Object oldValue = null;
        Integer entityId = extractEntityId(joinPoint);

        if (auditable.action() == AuditLog.Action.UPDATE ||
            auditable.action() == AuditLog.Action.DELETE) {
            oldValue = findExistingEntity(auditable.entityType(), entityId);
        }

        // ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œ
        Object result = joinPoint.proceed();

        // ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
        Object newValue = null;
        if (auditable.action() == AuditLog.Action.CREATE ||
            auditable.action() == AuditLog.Action.UPDATE) {
            newValue = result;  // æˆ»ã‚Šå€¤ã‚’æ–°ã—ã„å€¤ã¨ã—ã¦è¨˜éŒ²
        }

        auditLogService.log(
            auditable.action(),
            auditable.entityType(),
            extractEntityIdFromResult(result, entityId),
            oldValue,
            newValue
        );

        return result;
    }

    /**
     * å¼•æ•°ã‹ã‚‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£IDã‚’æŠ½å‡º
     */
    private Integer extractEntityId(ProceedingJoinPoint joinPoint) {
        Object[] args = joinPoint.getArgs();
        for (Object arg : args) {
            if (arg instanceof Integer) {
                return (Integer) arg;
            }
            // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å ´åˆã¯getId()ã‚’å‘¼ã³å‡ºã—
            try {
                return (Integer) arg.getClass().getMethod("getId").invoke(arg);
            } catch (Exception e) {
                // ignore
            }
        }
        return null;
    }
}</code></pre>
                    </div>
                </div>

                <div class="code-block" id="usage">
                    <div class="code-header">
                        <span class="code-title">TodoService.javaï¼ˆã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨ï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('usage', 'TodoService_audit.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>@Service
public class TodoService {

    private final TodoMapper todoMapper;

    /**
     * @Auditableã‚’ä»˜ä¸ã™ã‚‹ã¨è‡ªå‹•çš„ã«ç›£æŸ»ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹
     */
    @Auditable(action = AuditLog.Action.CREATE, entityType = "TODO")
    @Transactional
    public Todo create(TodoForm form) {
        Todo todo = new Todo();
        todo.setTitle(form.getTitle());
        todo.setDescription(form.getDescription());
        todoMapper.insert(todo);
        return todo;
    }

    @Auditable(action = AuditLog.Action.UPDATE, entityType = "TODO")
    @Transactional
    public Todo update(Integer id, TodoForm form) {
        Todo todo = todoMapper.findById(id);
        todo.setTitle(form.getTitle());
        todo.setDescription(form.getDescription());
        todoMapper.update(todo);
        return todo;
    }

    @Auditable(action = AuditLog.Action.DELETE, entityType = "TODO")
    @Transactional
    public void delete(Integer id) {
        todoMapper.delete(id);
    }
}</code></pre>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-header"><span class="info-box-icon"><span class="material-icons">lightbulb</span></span><span class="info-box-title">AOPã§ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ</span></div>
                    <ul>
                        <li>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ç›£æŸ»ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã§ãã‚‹</li>
                        <li>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã ã‘ã§è‡ªå‹•è¨˜éŒ²</li>
                        <li>æ¼ã‚Œãªãä¸€è²«ã—ãŸå½¢å¼ã§è¨˜éŒ²</li>
                        <li>å¾Œã‹ã‚‰ç›£æŸ»å¯¾è±¡ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã—ã‚„ã™ã„</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 24-3</span>
                    <h2 class="section-title">ç›£æŸ»ãƒ­ã‚°ã®æ¤œç´¢ãƒ»è¡¨ç¤º</h2>
                </div>

                <div class="code-block" id="mapper">
                    <div class="code-header">
                        <span class="code-title">AuditLogMapper.xml</span>
                        <button class="download-btn" onclick="downloadCode('mapper', 'AuditLogMapper.xml')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;
&lt;mapper namespace="com.example.mapper.AuditLogMapper"&gt;

    &lt;insert id="insert" useGeneratedKeys="true" keyProperty="id"&gt;
        INSERT INTO audit_logs
            (action, entity_type, entity_id, user_id, username,
             old_value, new_value, ip_address, user_agent, created_at)
        VALUES
            (#{action}, #{entityType}, #{entityId}, #{userId}, #{username},
             #{oldValue}, #{newValue}, #{ipAddress}, #{userAgent}, #{createdAt})
    &lt;/insert&gt;

    &lt;!-- æ¤œç´¢ï¼ˆæ¡ä»¶ä»˜ãï¼‰--&gt;
    &lt;select id="search" resultType="AuditLog"&gt;
        SELECT * FROM audit_logs
        &lt;where&gt;
            &lt;if test="entityType != null"&gt;
                AND entity_type = #{entityType}
            &lt;/if&gt;
            &lt;if test="entityId != null"&gt;
                AND entity_id = #{entityId}
            &lt;/if&gt;
            &lt;if test="userId != null"&gt;
                AND user_id = #{userId}
            &lt;/if&gt;
            &lt;if test="action != null"&gt;
                AND action = #{action}
            &lt;/if&gt;
            &lt;if test="fromDate != null"&gt;
                AND created_at &gt;= #{fromDate}
            &lt;/if&gt;
            &lt;if test="toDate != null"&gt;
                AND created_at &lt;= #{toDate}
            &lt;/if&gt;
        &lt;/where&gt;
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    &lt;/select&gt;

    &lt;!-- ç‰¹å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å±¥æ­´ --&gt;
    &lt;select id="findByEntity" resultType="AuditLog"&gt;
        SELECT * FROM audit_logs
        WHERE entity_type = #{entityType} AND entity_id = #{entityId}
        ORDER BY created_at DESC
    &lt;/select&gt;

&lt;/mapper&gt;</code></pre>
                    </div>
                </div>

                <div class="code-block" id="controller">
                    <div class="code-header">
                        <span class="code-title">AuditLogController.java</span>
                        <button class="download-btn" onclick="downloadCode('controller', 'AuditLogController.java')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>@Controller
@RequestMapping("/admin/audit-logs")
@PreAuthorize("hasRole('ADMIN')")  // ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
public class AuditLogController {

    private final AuditLogService auditLogService;

    @GetMapping
    public String list(
            @RequestParam(required = false) String entityType,
            @RequestParam(required = false) Integer userId,
            @RequestParam(required = false) String action,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate fromDate,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate toDate,
            @RequestParam(defaultValue = "0") int page,
            Model model) {

        AuditSearchCriteria criteria = new AuditSearchCriteria();
        criteria.setEntityType(entityType);
        criteria.setUserId(userId);
        criteria.setAction(action);
        criteria.setFromDate(fromDate);
        criteria.setToDate(toDate);
        criteria.setPage(page);

        Page&lt;AuditLog&gt; logs = auditLogService.search(criteria);

        model.addAttribute("logs", logs);
        model.addAttribute("criteria", criteria);

        return "admin/audit-logs";
    }

    /**
     * ç‰¹å®šToDoã®å¤‰æ›´å±¥æ­´
     */
    @GetMapping("/entity/{type}/{id}")
    public String entityHistory(
            @PathVariable String type,
            @PathVariable Integer id,
            Model model) {

        List&lt;AuditLog&gt; history = auditLogService.findByEntity(type, id);
        model.addAttribute("history", history);
        model.addAttribute("entityType", type);
        model.addAttribute("entityId", id);

        return "admin/entity-history";
    }
}</code></pre>
                    </div>
                </div>

                <div class="code-block" id="view">
                    <div class="code-header">
                        <span class="code-title">audit-logs.htmlï¼ˆä¸€è¦§è¡¨ç¤ºï¼‰</span>
                        <button class="download-btn" onclick="downloadCode('view', 'audit-logs.html')">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    <div class="code-content">
                        <pre><code>&lt;table class="data-table"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;æ—¥æ™‚&lt;/th&gt;
            &lt;th&gt;æ“ä½œ&lt;/th&gt;
            &lt;th&gt;å¯¾è±¡&lt;/th&gt;
            &lt;th&gt;ãƒ¦ãƒ¼ã‚¶ãƒ¼&lt;/th&gt;
            &lt;th&gt;è©³ç´°&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;tr th:each="log : ${logs.content}"&gt;
            &lt;td th:text="${#temporals.format(log.createdAt, 'yyyy/MM/dd HH:mm:ss')}"&gt;&lt;/td&gt;
            &lt;td&gt;
                &lt;span th:class="${'badge badge-' + log.action.toLowerCase()}"
                      th:text="${log.action}"&gt;&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span th:text="${log.entityType}"&gt;&lt;/span&gt;
                &lt;span th:text="'#' + ${log.entityId}"&gt;&lt;/span&gt;
            &lt;/td&gt;
            &lt;td th:text="${log.username}"&gt;&lt;/td&gt;
            &lt;td&gt;
                &lt;button onclick="showDetail(this)"
                        th:data-old="${log.oldValue}"
                        th:data-new="${log.newValue}"&gt;
                    è©³ç´°
                &lt;/button&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« --&gt;
&lt;div id="detailModal" class="modal"&gt;
    &lt;div class="modal-content"&gt;
        &lt;h3&gt;å¤‰æ›´å†…å®¹&lt;/h3&gt;
        &lt;div class="diff-view"&gt;
            &lt;div class="old-value"&gt;
                &lt;h4&gt;å¤‰æ›´å‰&lt;/h4&gt;
                &lt;pre id="oldValue"&gt;&lt;/pre&gt;
            &lt;/div&gt;
            &lt;div class="new-value"&gt;
                &lt;h4&gt;å¤‰æ›´å¾Œ&lt;/h4&gt;
                &lt;pre id="newValue"&gt;&lt;/pre&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </div>
                </div>

                <h3>ç›£æŸ»ãƒ­ã‚°ã®æ´»ç”¨ã‚·ãƒ¼ãƒ³</h3>
                <table class="data-table">
                    <thead><tr><th>ã‚·ãƒ¼ãƒ³</th><th>ç”¨é€”</th></tr></thead>
                    <tbody>
                        <tr><td>å•é¡Œèª¿æŸ»</td><td>ã„ã¤èª°ãŒãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãŸã‹è¿½è·¡</td></tr>
                        <tr><td>ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹</td><td>æ³•è¦åˆ¶å¯¾å¿œã®ãŸã‚ã®è¨˜éŒ²ä¿æŒ</td></tr>
                        <tr><td>ä¸æ­£æ¤œçŸ¥</td><td>ç•°å¸¸ãªæ“ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º</td></tr>
                        <tr><td>å¤‰æ›´å±¥æ­´</td><td>ãƒ‡ãƒ¼ã‚¿ã®å¤‰é·ã‚’ç¢ºèª</td></tr>
                    </tbody>
                </table>

                <div class="column">
                    <div class="column-header"><span class="column-badge">Column</span><span class="column-title">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</span></div>
                    <p>ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã¯<strong>Javadocä½œæˆ</strong>ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                    <p>APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆã‚’å­¦ã³ã€ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§ã‚’é«˜ã‚ã¾ã™ã€‚</p>
                </div>
            </section>

            <!-- AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ -->
            <section class="section" style="background: linear-gradient(135deg, #4285F4 0%, #9B72CB 50%, #D96570 100%); border-radius: 12px; color: white; margin-top: 2rem;">
                <div class="section-header" style="border-color: rgba(255,255,255,0.3);">
                    <span class="section-number" style="background: rgba(0,0,0,0.2); color: white;"><span class="material-icons" style="font-size: 1rem; vertical-align: middle;">smart_toy</span> AI</span>
                    <h2 class="section-title" style="color: white;">AIãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</h2>
                </div>

                <div class="intro-text">
                    <p style="color: rgba(0,0,0,0.9);">
                        ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆClaudeã€ChatGPTç­‰ï¼‰ã«å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€ã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚
                    </p>
                </div>

                <div class="code-block" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
                    <div class="code-header">
                        <span class="code-title" style="color: #a5f3fc;">ğŸ“ åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</span>
                    </div>
                    <div class="code-content">
                        <pre style="color: #e2e8f0; background: transparent;"><code>Spring Boot 3.xã®ToDoã‚¢ãƒ—ãƒªã«ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

ã€è¦ä»¶ã€‘
- audit_logsãƒ†ãƒ¼ãƒ–ãƒ«ã§æ“ä½œå±¥æ­´ã‚’è¨˜éŒ²ï¼ˆaction, entity_type, entity_id, user_id, old_value, new_value, ip_addressç­‰ï¼‰
- AuditLogã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨AuditLogServiceã‚’ä½œæˆ
- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³@Auditableã‚’ä½œæˆã—ã€ç›£æŸ»å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã«ä»˜ä¸
- @Aspectï¼ˆAuditAspectï¼‰ã§@Auditableä»˜ããƒ¡ã‚½ãƒƒãƒ‰ã®å‰å¾Œã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
- å¤‰æ›´å‰ãƒ»å¤‰æ›´å¾Œã®å€¤ã‚’JSONå½¢å¼ã§è¨˜éŒ²
- Propagation.REQUIRES_NEWã§æœ¬ä½“ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã‚‚ç›£æŸ»ãƒ­ã‚°ã¯æ®‹ã™
- ç®¡ç†è€…å‘ã‘ã®ç›£æŸ»ãƒ­ã‚°æ¤œç´¢ãƒ»è¡¨ç¤ºç”»é¢

ã€æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€‘
- Spring Boot 3.x
- Spring AOP
- MyBatis
- Jacksonï¼ˆJSONå¤‰æ›ï¼‰
- Spring Securityï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼‰</code></pre>
                    </div>
                </div>

                <div class="code-block" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); margin-top: 1rem;">
                    <div class="code-header">
                        <span class="code-title" style="color: #a5f3fc;">ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</span>
                    </div>
                    <div class="code-content">
                        <pre style="color: #e2e8f0; background: transparent;"><code># Step 1: ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
audit_logsãƒ†ãƒ¼ãƒ–ãƒ«ã®DDLã‚’ä½œæˆã—ã€
AuditLogã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨Mapperã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

# Step 2: AuditLogServiceã®ä½œæˆ
ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹AuditLogServiceã‚’ä½œæˆã—ã€
REQUIRES_NEWã§ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚

# Step 3: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨Aspect
@Auditableã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€AuditAspectã§
@Aroundå‡¦ç†ã‚’å®Ÿè£…ã—ã¦å¤‰æ›´å‰å¾Œã®å€¤ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚

# Step 4: ç®¡ç†ç”»é¢ã®ä½œæˆ
@PreAuthorize("hasRole('ADMIN')")ã§ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª
ç›£æŸ»ãƒ­ã‚°æ¤œç´¢ãƒ»è¡¨ç¤ºç”»é¢ã‚’Controllerã¨Thymeleafã§ä½œæˆã—ã¦ãã ã•ã„ã€‚</code></pre>
                    </div>
                </div>

                <div class="info-box" style="background: rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.3);">
                    <div class="info-box-header">
                        <span class="info-box-icon"><span class="material-icons">lightbulb</span></span>
                        <span class="info-box-title" style="color: white;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚³ãƒ„</span>
                    </div>
                    <p style="color: rgba(255,255,255,0.9);">
                        ã€Œç›£æŸ»ãƒ­ã‚°ã§å¤‰æ›´å‰å¾Œã®å·®åˆ†ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã¦ã€ã®ã‚ˆã†ã«ã€<br>
                        UIã®æ”¹å–„ã«ã¤ã„ã¦ã‚‚è³ªå•ã™ã‚‹ã¨ã€ã‚ˆã‚Šä½¿ã„ã‚„ã™ã„æ©Ÿèƒ½ãŒå®Ÿè£…ã§ãã¾ã™ã€‚
                    </p>
                </div>
            </section>
        </div>

        <footer class="footer"><p>Spring Framework å…¥é–€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« - ç™ºå±•ãƒ¬ãƒ™ãƒ«</p></footer>

        <div class="page-nav">
            <a href="24_mail.html" class="page-nav-btn prev"><span>â†</span><div><div class="page-nav-label">å‰ã®æ©Ÿèƒ½</div><div class="page-nav-title">ãƒ¡ãƒ¼ãƒ«é€ä¿¡é€šçŸ¥</div></div></a>
            <a href="26_javadoc.html" class="page-nav-btn next"><div><div class="page-nav-label">æ¬¡ã®æ©Ÿèƒ½</div><div class="page-nav-title">Javadocä½œæˆ</div></div><span>â†’</span></a>
        </div>

        <script>
            function toggleMenu() { document.querySelector(".nav-toggle").classList.toggle("active"); document.querySelector(".nav-menu").classList.toggle("active"); }
            function downloadCode(id, filename) { const el = document.getElementById(id); const code = el.querySelector('code') || el.querySelector('pre'); const blob = new Blob([code.textContent], {type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }
            function showDetail(btn) {
                const modal = document.getElementById('detailModal');
                document.getElementById('oldValue').textContent = JSON.stringify(JSON.parse(btn.dataset.old || '{}'), null, 2);
                document.getElementById('newValue').textContent = JSON.stringify(JSON.parse(btn.dataset.new || '{}'), null, 2);
                modal.style.display = 'block';
            }
        </script>
    </body>
</html>
