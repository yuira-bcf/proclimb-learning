<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第8章 API認証とセキュリティ - REST API & JSON入門</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../shared/common.css">
    <style>
      :root {
        --primary: #0097A7;
        --primary-dark: #00838F;
        --primary-light: #E0F7FA;
        --primary-lighter: #B2EBF2;
      }
      body { padding-top: 48px; }
      .nav-category-links { display: none; }
      /* 図解用スタイル */
      .visual-diagram {
        margin: 28px 0;
        padding: 28px 20px;
        background: linear-gradient(135deg, #f8fdfe 0%, #e6f7f9 100%);
        border-radius: 16px;
        border: 1px solid #b2ebf2;
      }
      .visual-diagram-title {
        text-align: center;
        font-size: 0.82rem;
        font-weight: 700;
        color: #0097A7;
        margin-bottom: 20px;
        letter-spacing: 0.05em;
      }
      .auth-compare {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 480px) {
        .auth-compare { grid-template-columns: 1fr; }
      }
      .auth-box {
        background: white;
        border-radius: 14px;
        padding: 22px 16px;
        text-align: center;
        border: 2px solid #b2ebf2;
      }
      .auth-box.authn { border-color: #0097A7; }
      .auth-box.authz { border-color: #FF6B35; }
      .auth-box .auth-icon { font-size: 2.4rem; display: block; margin-bottom: 8px; }
      .auth-box .auth-label { font-size: 0.85rem; font-weight: 700; display: block; }
      .auth-box .auth-en { font-size: 0.7rem; color: #888; display: block; margin: 2px 0 8px; }
      .auth-box .auth-q { font-size: 0.78rem; font-weight: 600; padding: 8px; background: #f8f8f8; border-radius: 8px; }
      .auth-box .auth-example { font-size: 0.68rem; color: #666; margin-top: 8px; line-height: 1.6; }
      .jwt-visual {
        display: flex;
        align-items: stretch;
        justify-content: center;
        gap: 4px;
        flex-wrap: wrap;
      }
      .jwt-part {
        border-radius: 12px;
        padding: 16px 14px;
        text-align: center;
        min-width: 120px;
        flex: 1;
        color: white;
      }
      .jwt-part.header { background: #E53935; }
      .jwt-part.payload { background: #7B1FA2; }
      .jwt-part.signature { background: #0097A7; }
      .jwt-part .jwt-label { font-size: 0.82rem; font-weight: 700; display: block; }
      .jwt-part .jwt-desc { font-size: 0.65rem; opacity: 0.9; display: block; margin-top: 4px; line-height: 1.5; }
      .jwt-dot {
        display: flex;
        align-items: center;
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
      }
      .oauth-flow {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        max-width: 380px;
        margin: 0 auto;
      }
      .oauth-step {
        background: white;
        border: 2px solid #b2ebf2;
        border-radius: 12px;
        padding: 12px 18px;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .oauth-step.highlight {
        border-color: #0097A7;
        background: #E0F7FA;
      }
      .oauth-step .os-num {
        background: #0097A7;
        color: white;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.72rem;
        font-weight: 700;
        flex-shrink: 0;
      }
      .oauth-step .os-text { font-size: 0.75rem; font-weight: 600; color: #333; }
      .oauth-connector {
        width: 2px;
        height: 12px;
        background: #b2ebf2;
      }
    </style>
</head>
<body>
    <nav class="global-nav"></nav>
    <script src="../../shared/js/nav-rest-api.js"></script>

    <div class="container">
        <header class="chapter-header">
            <div class="chapter-badge"><span class="material-icons">menu_book</span> Chapter</div>
            <div class="chapter-number">8</div>
            <h1 class="chapter-title">API認証とセキュリティ</h1>
        </header>

        <nav class="toc">
            <h2 class="toc-title"><span class="material-icons">list_alt</span> この章の内容</h2>
            <ul class="toc-list">
                <li class="toc-item"><span class="toc-number">8-1</span><span>認証と認可の違い</span></li>
                <li class="toc-item"><span class="toc-number">8-2</span><span>APIキー認証</span></li>
                <li class="toc-item"><span class="toc-number">8-3</span><span>JWT (JSON Web Token)</span></li>
                <li class="toc-item"><span class="toc-number">8-4</span><span>OAuth 2.0の概要</span></li>
                <li class="toc-item"><span class="toc-number">8-5</span><span>APIセキュリティの実践</span></li>
            </ul>
        </nav>

        <!-- セクション 8-1 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Section 8-1</span>
                <h2 class="section-title">認証と認可の違い</h2>
            </div>

            <div class="intro-text">
                <p>APIを安全に利用するためには、「認証（Authentication）」と「認可（Authorization）」の2つの概念を理解することが重要です。似ているようで全く異なる役割を持っています。</p>
            </div>

            <!-- 図解: 認証 vs 認可 -->
            <div class="visual-diagram">
                <div class="visual-diagram-title">認証（Authentication）と認可（Authorization）の違い</div>
                <div class="auth-compare">
                    <div class="auth-box authn">
                        <span class="auth-icon">&#128100;</span>
                        <span class="auth-label">認証</span>
                        <span class="auth-en">Authentication</span>
                        <div class="auth-q">「あなたは誰ですか？」</div>
                        <div class="auth-example">
                            例: ログイン、パスワード確認<br>
                            失敗 → 401 Unauthorized
                        </div>
                    </div>
                    <div class="auth-box authz">
                        <span class="auth-icon">&#128272;</span>
                        <span class="auth-label">認可</span>
                        <span class="auth-en">Authorization</span>
                        <div class="auth-q">「あなたは何ができる？」</div>
                        <div class="auth-example">
                            例: 管理者のみ削除可能<br>
                            失敗 → 403 Forbidden
                        </div>
                    </div>
                </div>
                <p style="text-align:center;font-size:0.7rem;color:#666;margin-top:14px;">まず<strong>認証</strong>（誰か確認）→ 次に<strong>認可</strong>（権限確認）の順で実行される</p>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">1.1 Authentication vs Authorization</h3>
                <div class="content-block">
                    <p>認証と認可は、セキュリティの2つの柱です。認証は「あなたは誰ですか？」を確認するプロセスであり、認可は「あなたに何が許可されていますか？」を確認するプロセスです。</p>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>項目</th>
                                <th>認証（Authentication）</th>
                                <th>認可（Authorization）</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>目的</strong></td>
                                <td>ユーザーの身元を確認する</td>
                                <td>ユーザーの権限を確認する</td>
                            </tr>
                            <tr>
                                <td><strong>質問</strong></td>
                                <td>「あなたは誰？」</td>
                                <td>「あなたは何ができる？」</td>
                            </tr>
                            <tr>
                                <td><strong>例え</strong></td>
                                <td>身分証明書の提示</td>
                                <td>入室許可証の確認</td>
                            </tr>
                            <tr>
                                <td><strong>実行順序</strong></td>
                                <td>先に実行される</td>
                                <td>認証の後に実行される</td>
                            </tr>
                            <tr>
                                <td><strong>失敗時</strong></td>
                                <td>401 Unauthorized</td>
                                <td>403 Forbidden</td>
                            </tr>
                            <tr>
                                <td><strong>API例</strong></td>
                                <td>ログイン、APIキー検証</td>
                                <td>管理者のみ削除可能</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">1.2 なぜAPIセキュリティが必要か</h3>
                <div class="content-block">
                    <div class="feature-list">
                        <div class="feature-item">
                            <div class="feature-icon">&#128274;</div>
                            <div class="feature-content">
                                <h4>データの保護</h4>
                                <p>ユーザーの個人情報や機密データへの不正アクセスを防ぎます。認証なしのAPIは誰でもデータにアクセスできてしまいます。</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">&#128737;</div>
                            <div class="feature-content">
                                <h4>不正利用の防止</h4>
                                <p>APIの悪用（大量リクエスト、データ改ざん）を防ぎ、サービスの安定性を維持します。</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">&#128200;</div>
                            <div class="feature-content">
                                <h4>利用状況の追跡</h4>
                                <p>誰がいつどのAPIを使ったかを記録し、監査やトラブルシューティングに活用できます。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- セクション 8-2 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Section 8-2</span>
                <h2 class="section-title">APIキー認証</h2>
            </div>

            <div class="intro-text">
                <p>APIキーは、最もシンプルな認証方法の一つです。APIプロバイダーから発行される一意の文字列（キー）を使って、リクエストの送信者を識別します。</p>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">2.1 ヘッダーでAPIキーを送信</h3>
                <div class="content-block">
                    <p>最も一般的な方法は、HTTPヘッダーにAPIキーを含めて送信する方法です。セキュリティ面でもこちらが推奨されます。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">ヘッダーでAPIキーを送信（fetch）</span>
                            <span class="code-lang">JavaScript</span>
                        </div>
                        <pre class="code-content"><code>// ヘッダーにAPIキーを含めてリクエスト
const response = await fetch('https://api.example.com/data', {
  headers: {
    'X-API-Key': 'あなたのAPIキー',
    'Content-Type': 'application/json'
  }
});
const data = await response.json();
console.log(data);</code></pre>
                    </div>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">curlでヘッダー送信</span>
                            <span class="code-lang">Terminal</span>
                        </div>
                        <pre class="code-content"><code># ヘッダーにAPIキーを含める
curl -H "X-API-Key: your_api_key_here" \
  https://api.example.com/data</code></pre>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">2.2 クエリパラメータでAPIキーを送信</h3>
                <div class="content-block">
                    <p>一部のAPIでは、URLのクエリパラメータとしてAPIキーを送信します。簡単ですが、URLにキーが露出するためセキュリティ上の注意が必要です。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">クエリパラメータでAPIキーを送信</span>
                            <span class="code-lang">JavaScript</span>
                        </div>
                        <pre class="code-content"><code>// URLにAPIキーをクエリパラメータとして含める
const apiKey = 'あなたのAPIキー';
const city = 'Tokyo';
const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&lang=ja`;

const response = await fetch(url);
const data = await response.json();
console.log(data);</code></pre>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">2.3 APIキーの管理方法</h3>
                <div class="content-block">
                    <div class="feature-list">
                        <div class="feature-item">
                            <div class="feature-icon">&#128273;</div>
                            <div class="feature-content">
                                <h4>キーを公開しない</h4>
                                <p>APIキーをGitHubなどの公開リポジトリにコミットしてはいけません。環境変数や設定ファイル（.env）で管理しましょう。</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">&#128260;</div>
                            <div class="feature-content">
                                <h4>定期的なローテーション</h4>
                                <p>APIキーは定期的に再発行し、古いキーを無効化します。万が一漏洩した場合もすぐに無効化できるようにしておきましょう。</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">&#128736;</div>
                            <div class="feature-content">
                                <h4>権限の最小化</h4>
                                <p>APIキーに付与する権限は必要最小限にします（読み取りのみ、特定エンドポイントのみなど）。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- セクション 8-3 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Section 8-3</span>
                <h2 class="section-title">JWT (JSON Web Token)</h2>
            </div>

            <div class="intro-text">
                <p>JWT（ジョット）は、JSON形式で情報を安全にやり取りするためのトークン規格です。ユーザー認証やAPI認証で広く使われており、トークン自体にユーザー情報を含むのが特徴です。</p>
            </div>

            <!-- 図解: JWT構造 -->
            <div class="visual-diagram">
                <div class="visual-diagram-title">JWT（JSON Web Token）の3つの構造</div>
                <div class="jwt-visual">
                    <div class="jwt-part header">
                        <span class="jwt-label">Header</span>
                        <span class="jwt-desc">アルゴリズム<br>トークンタイプ</span>
                    </div>
                    <div class="jwt-dot">.</div>
                    <div class="jwt-part payload">
                        <span class="jwt-label">Payload</span>
                        <span class="jwt-desc">ユーザー情報<br>有効期限</span>
                    </div>
                    <div class="jwt-dot">.</div>
                    <div class="jwt-part signature">
                        <span class="jwt-label">Signature</span>
                        <span class="jwt-desc">改ざん検知<br>秘密鍵で署名</span>
                    </div>
                </div>
                <p style="text-align:center;font-size:0.7rem;color:#666;margin-top:14px;">3つのパートをBase64でエンコードし、ドット（.）で連結した文字列がJWT</p>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">3.1 JWTの構造</h3>
                <div class="content-block">
                    <p>JWTは3つのパートで構成され、それぞれドット（.）で区切られています。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">JWTの構造</span>
                            <span class="code-lang">JWT</span>
                        </div>
                        <pre class="code-content"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRhcm8gWWFtYWRhIiwiaWF0IjoxNjE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   Header    │.│   Payload   │.│  Signature  │
│  (ヘッダー)  │ │ (ペイロード) │ │   (署名)     │
└─────────────┘ └─────────────┘ └─────────────┘</code></pre>
                    </div>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">デコードしたJWTの中身</span>
                            <span class="code-lang">JSON</span>
                        </div>
                        <pre class="code-content"><code>// Header（ヘッダー）: アルゴリズムとトークンタイプ
{
  "alg": "HS256",
  "typ": "JWT"
}

// Payload（ペイロード）: ユーザー情報や有効期限
{
  "sub": "1234567890",
  "name": "Taro Yamada",
  "role": "admin",
  "iat": 1616239022,
  "exp": 1616242622
}

// Signature（署名）: 改ざん検知のための署名
// HMACSHA256(base64(header) + "." + base64(payload), secret)</code></pre>
                    </div>

                    <div class="info-box">
                        <div class="info-box-header">
                            <span class="info-box-icon"><span class="material-icons">lightbulb</span></span>
                            <span class="info-box-title">jwt.io でJWTを確認しよう</span>
                        </div>
                        <p><a href="https://jwt.io" target="_blank">jwt.io</a> では、JWTをデコードして中身を確認したり、署名の検証ができます。学習用としてJWTの構造を理解するのに最適なツールです。</p>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">3.2 Bearer Tokenの仕組み</h3>
                <div class="content-block">
                    <p>JWTは通常、HTTPリクエストのAuthorizationヘッダーに「Bearer トークン」として含めて送信します。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Bearer Tokenを使ったAPI呼び出し</span>
                            <span class="code-lang">JavaScript</span>
                        </div>
                        <pre class="code-content"><code>// 1. ログインしてJWTを取得
const loginResponse = await fetch('https://api.example.com/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123'
  })
});
const { token } = await loginResponse.json();

// 2. 取得したJWTをBearer Tokenとして使う
const dataResponse = await fetch('https://api.example.com/users/me', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
const userData = await dataResponse.json();
console.log(userData);</code></pre>
                    </div>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">curlでBearer Tokenを送信</span>
                            <span class="code-lang">Terminal</span>
                        </div>
                        <pre class="code-content"><code># Bearer Tokenをヘッダーに含めてリクエスト
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..." \
  https://api.example.com/users/me</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- セクション 8-4 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Section 8-4</span>
                <h2 class="section-title">OAuth 2.0の概要</h2>
            </div>

            <div class="intro-text">
                <p>OAuth 2.0は、サードパーティアプリケーションにユーザーのリソースへのアクセスを安全に委任するための認可フレームワークです。「Googleでログイン」「GitHubでログイン」などの機能で使われています。</p>
            </div>

            <!-- 図解: OAuth 2.0 認可コードフロー -->
            <div class="visual-diagram">
                <div class="visual-diagram-title">OAuth 2.0 認可コードフロー</div>
                <div class="oauth-flow">
                    <div class="oauth-step">
                        <div class="os-num">1</div>
                        <span class="os-text">ユーザーが「Googleでログイン」をクリック</span>
                    </div>
                    <div class="oauth-connector"></div>
                    <div class="oauth-step">
                        <div class="os-num">2</div>
                        <span class="os-text">Google認可画面でアクセス許可に同意</span>
                    </div>
                    <div class="oauth-connector"></div>
                    <div class="oauth-step highlight">
                        <div class="os-num">3</div>
                        <span class="os-text">認可コードがアプリに返される</span>
                    </div>
                    <div class="oauth-connector"></div>
                    <div class="oauth-step highlight">
                        <div class="os-num">4</div>
                        <span class="os-text">認可コード → アクセストークンに交換</span>
                    </div>
                    <div class="oauth-connector"></div>
                    <div class="oauth-step">
                        <div class="os-num">5</div>
                        <span class="os-text">トークンでユーザー情報にアクセス</span>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">4.1 認可コードフロー</h3>
                <div class="content-block">
                    <p>最も一般的なOAuth 2.0の認可フローです。Webアプリケーションでよく使われます。</p>

                    <div class="step-list">
                        <div class="step-item">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>認可リクエスト</h4>
                                <p>ユーザーがアプリの「Googleでログイン」ボタンをクリックすると、Googleの認可画面にリダイレクトされます。</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>ユーザーの同意</h4>
                                <p>ユーザーがアクセス許可（メール読み取り、プロフィール参照など）に同意します。</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>認可コードの取得</h4>
                                <p>同意後、認可サーバーから一時的な認可コードがアプリに返されます。</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>アクセストークンの交換</h4>
                                <p>アプリはサーバー側で認可コードをアクセストークンに交換します。</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>APIアクセス</h4>
                                <p>取得したアクセストークンを使って、ユーザーのリソース（プロフィール情報等）にアクセスします。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">4.2 アクセストークンとリフレッシュトークン</h3>
                <div class="content-block">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>項目</th>
                                <th>アクセストークン</th>
                                <th>リフレッシュトークン</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>用途</strong></td>
                                <td>APIへのアクセスに使用</td>
                                <td>新しいアクセストークンの取得に使用</td>
                            </tr>
                            <tr>
                                <td><strong>有効期限</strong></td>
                                <td>短い（数分〜数時間）</td>
                                <td>長い（数日〜数ヶ月）</td>
                            </tr>
                            <tr>
                                <td><strong>送信先</strong></td>
                                <td>リソースサーバー（API）</td>
                                <td>認可サーバーのみ</td>
                            </tr>
                            <tr>
                                <td><strong>漏洩リスク</strong></td>
                                <td>短い有効期限で被害を最小化</td>
                                <td>厳重に保管する必要がある</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">4.3 代表的なOAuthプロバイダーとグラントタイプ</h3>
                <div class="content-block">
                    <p>Google、GitHub、Twitter（X）、Facebookなど多くのサービスがOAuth 2.0に対応しています。</p>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>グラントタイプ</th>
                                <th>用途</th>
                                <th>特徴</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Authorization Code</strong></td>
                                <td>Webアプリ（サーバーサイド）</td>
                                <td>最も安全。サーバー間でトークン交換</td>
                            </tr>
                            <tr>
                                <td><strong>Authorization Code + PKCE</strong></td>
                                <td>SPA・モバイルアプリ</td>
                                <td>公開クライアント向けのセキュリティ強化版</td>
                            </tr>
                            <tr>
                                <td><strong>Client Credentials</strong></td>
                                <td>サーバー間通信（M2M）</td>
                                <td>ユーザー不在。アプリ自身の認証</td>
                            </tr>
                            <tr>
                                <td><strong>Implicit（非推奨）</strong></td>
                                <td>旧SPA向け</td>
                                <td>セキュリティ上の問題があり非推奨</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- セクション 8-5 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Section 8-5</span>
                <h2 class="section-title">APIセキュリティの実践</h2>
            </div>

            <div class="intro-text">
                <p>認証方式に加えて、APIを安全に運用するためのセキュリティ対策を学びましょう。CORS設定、レート制限、入力バリデーションなどが重要です。</p>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">5.1 CORS設定の詳細</h3>
                <div class="content-block">
                    <p>CORS（Cross-Origin Resource Sharing）は、異なるオリジン（ドメイン）からのAPIアクセスを制御する仕組みです。ブラウザからのAPI呼び出しで特に重要です。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">CORSレスポンスヘッダーの例</span>
                            <span class="code-lang">HTTP Header</span>
                        </div>
                        <pre class="code-content"><code># 特定のオリジンのみ許可
Access-Control-Allow-Origin: https://myapp.example.com

# 許可するHTTPメソッド
Access-Control-Allow-Methods: GET, POST, PUT, DELETE

# 許可するリクエストヘッダー
Access-Control-Allow-Headers: Content-Type, Authorization

# プリフライトリクエストのキャッシュ時間（秒）
Access-Control-Max-Age: 86400</code></pre>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">5.2 レート制限（Rate Limiting）</h3>
                <div class="content-block">
                    <p>レート制限は、一定時間内のAPIリクエスト数を制限する仕組みです。DDoS攻撃や過剰利用からAPIを保護します。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">レート制限のレスポンスヘッダー</span>
                            <span class="code-lang">HTTP Header</span>
                        </div>
                        <pre class="code-content"><code># 1時間あたりのリクエスト上限
X-RateLimit-Limit: 1000

# 残りのリクエスト数
X-RateLimit-Remaining: 995

# 制限がリセットされる時刻（Unix timestamp）
X-RateLimit-Reset: 1616245200

# 制限超過時のレスポンス（HTTP 429）
HTTP/1.1 429 Too Many Requests
Retry-After: 3600</code></pre>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">5.3 入力バリデーションとHTTPS</h3>
                <div class="content-block">
                    <p>APIに送信されるデータは必ず検証（バリデーション）する必要があります。また、通信は常にHTTPSで暗号化しましょう。</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">入力バリデーションの例</span>
                            <span class="code-lang">JavaScript</span>
                        </div>
                        <pre class="code-content"><code>// クライアント側でもバリデーションを行う
function validateUserInput(data) {
  // 必須フィールドのチェック
  if (!data.name || data.name.trim() === '') {
    throw new Error('名前は必須です');
  }

  // 文字数制限
  if (data.name.length > 100) {
    throw new Error('名前は100文字以内にしてください');
  }

  // メールアドレスの形式チェック
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(data.email)) {
    throw new Error('有効なメールアドレスを入力してください');
  }

  return true;
}</code></pre>
                    </div>

                    <div class="warning-box">
                        <div class="info-box-header">
                            <span class="info-box-icon"><span class="material-icons">warning</span></span>
                            <span class="info-box-title">セキュリティに関する重要な注意</span>
                        </div>
                        <p>APIキーやトークンをフロントエンドのJavaScriptに直接埋め込むと、誰でも閲覧できてしまいます。機密性の高い認証情報は必ずサーバーサイドで管理してください。また、HTTPSを使わないAPI通信は盗聴のリスクがあるため、本番環境では必ずHTTPSを使用しましょう。</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 練習問題 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Exercise</span>
                <h2 class="section-title">8章 練習問題</h2>
            </div>

            <div class="exercise-list">
                <div class="exercise-item">
                    <div class="exercise-number">Q1</div>
                    <div class="exercise-content">
                        <p>認証（Authentication）と認可（Authorization）について正しい説明はどれですか？</p>
                        <ol type="A">
                            <li>認証は「何ができるか」を確認し、認可は「誰であるか」を確認する</li>
                            <li>認証は「誰であるか」を確認し、認可は「何ができるか」を確認する</li>
                            <li>認証と認可は同じ意味で、どちらもパスワード確認を指す</li>
                            <li>認可は認証の前に実行される</li>
                        </ol>
                    </div>
                </div>

                <div class="exercise-item">
                    <div class="exercise-number">Q2</div>
                    <div class="exercise-content">
                        <p>JWTの構造として正しいものはどれですか？</p>
                        <ol type="A">
                            <li>Username.Password.Token</li>
                            <li>Header.Payload.Signature</li>
                            <li>Key.Value.Hash</li>
                            <li>Request.Response.Status</li>
                        </ol>
                    </div>
                </div>

                <div class="exercise-item">
                    <div class="exercise-number">Q3</div>
                    <div class="exercise-content">
                        <p>APIのレート制限を超過した場合に返されるHTTPステータスコードはどれですか？</p>
                        <ol type="A">
                            <li>401 Unauthorized</li>
                            <li>403 Forbidden</li>
                            <li>404 Not Found</li>
                            <li>429 Too Many Requests</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- 解答 -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">Answer</span>
                <h2 class="section-title">8章 解説・解答</h2>
            </div>

            <div class="answer-list">
                <div class="answer-item">
                    <div class="answer-header">Q1の解答: B</div>
                    <div class="answer-content">
                        <p>認証（Authentication）は「あなたは誰ですか？」とユーザーの身元を確認するプロセスです。認可（Authorization）は「あなたは何ができますか？」とアクセス権限を確認するプロセスです。認証が先に実行され、その後に認可が行われます。</p>
                    </div>
                </div>

                <div class="answer-item">
                    <div class="answer-header">Q2の解答: B</div>
                    <div class="answer-content">
                        <p>JWTは「Header（ヘッダー）.Payload（ペイロード）.Signature（署名）」の3つのパートで構成されています。それぞれBase64URLでエンコードされ、ドット（.）で区切られています。Headerにはアルゴリズム情報、Payloadにはユーザー情報や有効期限、Signatureには改ざん検知のための署名が含まれます。</p>
                    </div>
                </div>

                <div class="answer-item">
                    <div class="answer-header">Q3の解答: D</div>
                    <div class="answer-content">
                        <p>レート制限を超過した場合、サーバーは「429 Too Many Requests」を返します。レスポンスには通常、<code>Retry-After</code>ヘッダーが含まれ、次にリクエストを送信できるまでの待機時間が示されます。401は認証エラー、403は認可エラー、404はリソース未発見を示します。</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="page-nav">
        <a href="7api-testing.html" class="page-nav-btn prev">
            <span>&#8592;</span>
            <div>
                <div class="page-nav-label">前の章</div>
                <div class="page-nav-title">第7章 APIテストツール</div>
            </div>
        </a>
        <a href="9api-documentation.html" class="page-nav-btn next">
            <div>
                <div class="page-nav-label">次の章</div>
                <div class="page-nav-title">第9章 APIドキュメントの読み方と作り方</div>
            </div>
            <span>&#8594;</span>
        </a>
    </div>

    <footer class="global-footer"></footer>
    <script src="../../shared/footer.js"></script>
    <script>
        document.addEventListener('click', function(e) {
            const header = document.querySelector('.global-header');
            const nav = document.querySelector('.tutorial-nav');
            const toggle = document.querySelector('.header-nav-toggle');
            if (header && nav && toggle && !header.contains(e.target) && !nav.contains(e.target) && nav.classList.contains('active')) {
                toggle.classList.remove('active');
                nav.classList.remove('active');
            }
        });
    </script>
    <script src="../../shared/demo.js"></script>
</body>
</html>
