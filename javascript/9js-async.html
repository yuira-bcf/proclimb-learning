<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 9: 非同期処理とAPI連携 - JavaScript入門</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../shared/common.css">
  <style>
    :root {
      --primary: #007AFF;
      --primary-dark: #0062CC;
      --primary-light: #EFF6FF;
      --primary-lighter: #BFDBFE;
    }
    .nav-category-links { display: none; }
  </style>
</head>
<body>
  <nav class="global-nav"></nav>
  <script src="../shared/js/nav-javascript.js"></script>

  <div class="container">
    <!-- チャプターヘッダー -->
    <header class="chapter-header">
      <div class="chapter-badge">Chapter</div>
      <div class="chapter-number">9</div>
      <h1 class="chapter-title">非同期処理とAPI連携</h1>
      <p class="chapter-subtitle">外部データを取得してWebアプリを作ろう</p>
    </header>

    <!-- 目次 -->
    <nav class="toc">
      <h2 class="toc-title">この章の内容</h2>
      <ul class="toc-list">
        <li class="toc-item"><span class="toc-number">9-1</span>同期処理と非同期処理</li>
        <li class="toc-item"><span class="toc-number">9-2</span>Promise</li>
        <li class="toc-item"><span class="toc-number">9-3</span>async/await</li>
        <li class="toc-item"><span class="toc-number">9-4</span>Fetch API</li>
        <li class="toc-item"><span class="toc-number">9-5</span>エラーハンドリング</li>
        <li class="toc-item"><span class="toc-number">9-6</span>実習：天気予報アプリ</li>
        <li class="toc-item"><span class="toc-number">練習</span>練習問題</li>
      </ul>
    </nav>

    <!-- Section 9-1 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-1</span>
        <h2 class="section-title">同期処理と非同期処理</h2>
      </div>

      <div class="intro-text">
        <p>JavaScriptは<strong>シングルスレッド</strong>で動作しますが、非同期処理を使うことで、時間のかかる処理（API通信など）を待つ間も他の処理を実行できます。</p>
      </div>

      <div class="subsection">
        <h3>同期処理 vs 非同期処理</h3>

        <!-- SVG図解 -->
        <div class="demo-area" style="padding: 20px; overflow-x: auto;">
          <svg viewBox="0 0 700 250" style="min-width: 600px; width: 100%; height: auto;">
            <!-- 同期処理 -->
            <text x="150" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e293b">同期処理</text>

            <rect x="50" y="40" width="200" height="30" rx="4" fill="#3b82f6"/>
            <text x="150" y="60" text-anchor="middle" font-size="11" fill="white">処理A（実行中）</text>

            <rect x="50" y="75" width="200" height="30" rx="4" fill="#e2e8f0"/>
            <text x="150" y="95" text-anchor="middle" font-size="11" fill="#64748b">待機...</text>

            <rect x="50" y="110" width="200" height="30" rx="4" fill="#22c55e"/>
            <text x="150" y="130" text-anchor="middle" font-size="11" fill="white">処理B（Aが終わってから）</text>

            <rect x="50" y="145" width="200" height="30" rx="4" fill="#f97316"/>
            <text x="150" y="165" text-anchor="middle" font-size="11" fill="white">処理C（Bが終わってから）</text>

            <text x="150" y="200" text-anchor="middle" font-size="11" fill="#ef4444">→ 順番に実行（遅い）</text>

            <!-- 非同期処理 -->
            <text x="550" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e293b">非同期処理</text>

            <rect x="400" y="40" width="80" height="30" rx="4" fill="#3b82f6"/>
            <text x="440" y="60" text-anchor="middle" font-size="11" fill="white">処理A開始</text>

            <rect x="400" y="75" width="120" height="30" rx="4" fill="#22c55e"/>
            <text x="460" y="95" text-anchor="middle" font-size="11" fill="white">処理B（並行）</text>

            <rect x="400" y="110" width="150" height="30" rx="4" fill="#f97316"/>
            <text x="475" y="130" text-anchor="middle" font-size="11" fill="white">処理C（並行）</text>

            <rect x="560" y="40" width="100" height="100" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4"/>
            <text x="610" y="85" text-anchor="middle" font-size="10" fill="#1e40af">Aの結果待ち</text>
            <text x="610" y="100" text-anchor="middle" font-size="10" fill="#1e40af">(バックグラウンド)</text>

            <rect x="485" y="145" width="100" height="30" rx="4" fill="#3b82f6"/>
            <text x="535" y="165" text-anchor="middle" font-size="11" fill="white">A完了→コールバック</text>

            <text x="550" y="200" text-anchor="middle" font-size="11" fill="#22c55e">→ 効率的に実行（速い）</text>
          </svg>
        </div>
      </div>

      <div class="subsection">
        <h3>setTimeout と setInterval</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
時間差で順番にメッセージを表示

## 実装要件
- `setTimeout()`で「開始」「1秒後」「2秒後」「完了」を順番に表示
- `setInterval()`で定期実行する例を追加
- `clearInterval()`でタイマーを停止

## 使用するAPI
- setTimeout()
- setInterval()
- clearInterval()
- console.log()</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">非同期処理の基本</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="variable">console</span>.<span class="method">log</span>(<span class="string">"1. 開始"</span>);

<span class="comment">// 2秒後に実行（非同期）</span>
<span class="method">setTimeout</span>(() => {
  <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"3. 2秒後に実行"</span>);
}, <span class="number">2000</span>);

<span class="variable">console</span>.<span class="method">log</span>(<span class="string">"2. 終了（すぐ実行）"</span>);

<span class="comment">// 出力順序：</span>
<span class="comment">// 1. 開始</span>
<span class="comment">// 2. 終了（すぐ実行）</span>
<span class="comment">// 3. 2秒後に実行</span>

<span class="comment">// 定期実行</span>
<span class="keyword">const</span> <span class="variable">intervalId</span> = <span class="method">setInterval</span>(() => {
  <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"1秒ごとに実行"</span>);
}, <span class="number">1000</span>);

<span class="comment">// 停止</span>
<span class="method">clearInterval</span>(<span class="variable">intervalId</span>);</pre>
              </div>
            </div>
            <div class="demo-preview-section">
              <div class="demo-preview-header">
                <span class="demo-preview-label">デモ</span>
              </div>
              <div class="demo-preview-content" style="text-align: center;">
                <button id="timer-btn" style="padding: 12px 24px; font-size: 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">タイマー開始</button>
                <p id="timer-output" style="margin-top: 12px; font-family: 'JetBrains Mono', monospace;">--</p>
              </div>
            </div>
          </div>
        </div>

        <script>
          document.getElementById('timer-btn').addEventListener('click', function() {
            const output = document.getElementById('timer-output');
            output.textContent = '開始！';
            this.disabled = true;

            setTimeout(() => {
              output.textContent = '1秒経過...';
            }, 1000);

            setTimeout(() => {
              output.textContent = '2秒経過...';
            }, 2000);

            setTimeout(() => {
              output.textContent = '完了！';
              document.getElementById('timer-btn').disabled = false;
            }, 3000);
          });
        </script>
      </div>

      <div class="subsection">
        <h3>コールバック地獄</h3>
        <p>非同期処理をネストすると、コードが読みにくくなります。これを「コールバック地獄」と呼びます。</p>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
コールバック地獄のアンチパターンを示す

## 実装要件
- ネストが深くなるコールバックの例を作成
- ユーザー情報→注文一覧→注文詳細→商品情報の順で取得
- 可読性の問題点を示す

## 取得順序
1. `getUser()` - ユーザー情報
2. `getOrders()` - 注文一覧
3. `getOrderDetails()` - 注文詳細
4. `getProduct()` - 商品情報</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">コールバック地獄の例</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="comment">// ❌ コールバック地獄</span>
<span class="method">getUser</span>(<span class="variable">userId</span>, (<span class="variable">user</span>) => {
  <span class="method">getOrders</span>(<span class="variable">user</span>.<span class="variable">id</span>, (<span class="variable">orders</span>) => {
    <span class="method">getOrderDetails</span>(<span class="variable">orders</span>[<span class="number">0</span>].<span class="variable">id</span>, (<span class="variable">details</span>) => {
      <span class="method">getProduct</span>(<span class="variable">details</span>.<span class="variable">productId</span>, (<span class="variable">product</span>) => {
        <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">product</span>);
        <span class="comment">// ネストが深すぎる...</span>
      });
    });
  });
});

<span class="comment">// → Promiseやasync/awaitで解決！</span></pre>
              </div>
            </div>
          </div>
        </div>

        <div class="info-box warning">
          <div class="info-box-title"><span class="material-icons">warning</span> コールバック地獄の問題点</div>
          <div class="info-box-content">
            <ul>
              <li>コードが読みにくい</li>
              <li>エラーハンドリングが難しい</li>
              <li>デバッグが困難</li>
            </ul>
            <p>→ <strong>Promise</strong>と<strong>async/await</strong>で解決できます。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 9-2 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-2</span>
        <h2 class="section-title">Promise</h2>
      </div>

      <div class="intro-text">
        <p>Promiseは、非同期処理の結果を表すオブジェクトです。成功（resolve）または失敗（reject）のいずれかの状態になります。</p>
      </div>

      <div class="subsection">
        <h3>Promiseの基本</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
Promiseを使った非同期処理の基本

## 実装要件
- `new Promise()`でPromiseを作成
- `resolve()`で成功時の値を返す
- `reject()`で失敗時のエラーを返す
- `then()`で成功時の処理
- `catch()`で失敗時の処理
- `finally()`で完了時の処理

## 使用するAPI
- Promise
- resolve / reject
- then() / catch() / finally()</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">Promiseの作成と使用</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="comment">// Promiseの作成</span>
<span class="keyword">const</span> <span class="variable">promise</span> = <span class="keyword">new</span> <span class="class-name">Promise</span>((<span class="variable">resolve</span>, <span class="variable">reject</span>) => {
  <span class="comment">// 非同期処理をシミュレート</span>
  <span class="method">setTimeout</span>(() => {
    <span class="keyword">const</span> <span class="variable">success</span> = <span class="keyword">true</span>;

    <span class="keyword">if</span> (<span class="variable">success</span>) {
      <span class="method">resolve</span>(<span class="string">"成功しました！"</span>);  <span class="comment">// 成功時</span>
    } <span class="keyword">else</span> {
      <span class="method">reject</span>(<span class="string">"失敗しました..."</span>);  <span class="comment">// 失敗時</span>
    }
  }, <span class="number">1000</span>);
});

<span class="comment">// Promiseの結果を受け取る</span>
<span class="variable">promise</span>
  .<span class="method">then</span>((<span class="variable">result</span>) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">result</span>);  <span class="comment">// "成功しました！"</span>
  })
  .<span class="method">catch</span>((<span class="variable">error</span>) => {
    <span class="variable">console</span>.<span class="method">error</span>(<span class="variable">error</span>);  <span class="comment">// "失敗しました..."</span>
  })
  .<span class="method">finally</span>(() => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"処理完了"</span>);  <span class="comment">// 成功/失敗どちらでも実行</span>
  });</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="syntax-box">
          <div class="syntax-box-header">
            <span class="syntax-box-icon"><span class="material-icons">menu_book</span></span>
            <span class="syntax-box-title">構文説明</span>
          </div>
          <div class="syntax-box-content">
            <div class="syntax-item">
              <h4>new Promise()</h4>
              <div class="syntax-pattern">new Promise((resolve, reject) => {
  ...
})</div>
              <p>非同期処理を表すPromiseオブジェクトを作成します。成功時は<code>resolve(値)</code>、失敗時は<code>reject(エラー)</code>を呼び出します。</p>
            </div>
            <div class="syntax-item">
              <h4>.then()</h4>
              <div class="syntax-pattern">promise.then(成功時の関数)</div>
              <p>Promiseが成功（resolve）したときに実行されるコールバック関数を登録します。戻り値は新しいPromiseになります。</p>
            </div>
            <div class="syntax-item">
              <h4>.catch()</h4>
              <div class="syntax-pattern">promise.catch(失敗時の関数)</div>
              <p>Promiseが失敗（reject）したとき、またはthen内でエラーが発生したときに実行されるコールバック関数を登録します。</p>
            </div>
            <div class="syntax-item">
              <h4>.finally()</h4>
              <div class="syntax-pattern">promise.finally(完了時の関数)</div>
              <p>成功・失敗に関わらず、Promise処理が完了したときに必ず実行されます。ローディング表示の解除などに使います。</p>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>Promiseチェーン</h3>
        <p><code>.then()</code>を連結することで、非同期処理を順番に実行できます。</p>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
Promiseチェーンで連続した非同期処理を実行

## 実装要件
- `then()`をチェーンで接続
- 各`then()`で次のPromiseを`return`
- ユーザー取得→注文一覧取得→注文詳細取得の順で実行
- `catch()`でエラーハンドリング

## 処理フロー
1. `fetchUser()` - ユーザー取得
2. `fetchOrders()` - 注文一覧取得
3. `fetchOrderDetails()` - 注文詳細取得</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">Promiseチェーン</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="method">fetchUser</span>(<span class="number">1</span>)
  .<span class="method">then</span>((<span class="variable">user</span>) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"ユーザー取得:"</span>, <span class="variable">user</span>.<span class="variable">name</span>);
    <span class="keyword">return</span> <span class="method">fetchOrders</span>(<span class="variable">user</span>.<span class="variable">id</span>);  <span class="comment">// 次のPromiseを返す</span>
  })
  .<span class="method">then</span>((<span class="variable">orders</span>) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"注文一覧:"</span>, <span class="variable">orders</span>);
    <span class="keyword">return</span> <span class="method">fetchOrderDetails</span>(<span class="variable">orders</span>[<span class="number">0</span>].<span class="variable">id</span>);
  })
  .<span class="method">then</span>((<span class="variable">details</span>) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"注文詳細:"</span>, <span class="variable">details</span>);
  })
  .<span class="method">catch</span>((<span class="variable">error</span>) => {
    <span class="variable">console</span>.<span class="method">error</span>(<span class="string">"エラー:"</span>, <span class="variable">error</span>);
  });</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>Promise.all と Promise.race</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
複数のPromiseを同時に処理

## 実装要件
- `Promise.all()` - 全てのPromiseが完了するまで待機
- `Promise.race()` - 最初に完了したPromiseの結果を取得
- 複数のAPIリクエストを並列実行

## 使用するAPI
- Promise.all([...])
- Promise.race([...])
- fetch()

## 違い
- `all`: 全完了待ち、1つでも失敗で全体失敗
- `race`: 最速の結果のみ取得</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">複数のPromiseを扱う</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">const</span> <span class="variable">promise1</span> = <span class="method">fetch</span>(<span class="string">'/api/users'</span>);
<span class="keyword">const</span> <span class="variable">promise2</span> = <span class="method">fetch</span>(<span class="string">'/api/products'</span>);
<span class="keyword">const</span> <span class="variable">promise3</span> = <span class="method">fetch</span>(<span class="string">'/api/orders'</span>);

<span class="comment">// Promise.all: 全て完了するまで待つ</span>
<span class="variable">Promise</span>.<span class="method">all</span>([<span class="variable">promise1</span>, <span class="variable">promise2</span>, <span class="variable">promise3</span>])
  .<span class="method">then</span>(([<span class="variable">users</span>, <span class="variable">products</span>, <span class="variable">orders</span>]) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"全て完了！"</span>);
  })
  .<span class="method">catch</span>((<span class="variable">error</span>) => {
    <span class="comment">// 1つでも失敗したらここに来る</span>
    <span class="variable">console</span>.<span class="method">error</span>(<span class="variable">error</span>);
  });

<span class="comment">// Promise.race: 最初に完了したものだけ</span>
<span class="variable">Promise</span>.<span class="method">race</span>([<span class="variable">promise1</span>, <span class="variable">promise2</span>, <span class="variable">promise3</span>])
  .<span class="method">then</span>((<span class="variable">fastest</span>) => {
    <span class="variable">console</span>.<span class="method">log</span>(<span class="string">"最速で完了:"</span>, <span class="variable">fastest</span>);
  });</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 9-3 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-3</span>
        <h2 class="section-title">async/await</h2>
      </div>

      <div class="intro-text">
        <p><code>async/await</code>は、Promiseをより簡潔に書くための構文です。同期処理のように見える書き方で非同期処理を記述できます。</p>
      </div>

      <div class="subsection">
        <h3>async/await の基本</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
async/awaitで非同期処理を同期的に記述

## 実装要件
- `async function`で非同期関数を定義
- `await`でPromiseの完了を待機
- アロー関数での`async`の使い方
- 戻り値は自動的にPromiseでラップ

## 使用する構文
- async function
- await
- const fn = async () => {}

## メリット
- 同期処理のように読みやすいコード
- try-catchでエラーハンドリング可能</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">async/await の使い方</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="comment">// async関数を定義</span>
<span class="keyword">async</span> <span class="keyword">function</span> <span class="method">fetchUserData</span>() {
  <span class="comment">// awaitでPromiseの完了を待つ</span>
  <span class="keyword">const</span> <span class="variable">user</span> = <span class="keyword">await</span> <span class="method">fetchUser</span>(<span class="number">1</span>);
  <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">user</span>);

  <span class="keyword">const</span> <span class="variable">orders</span> = <span class="keyword">await</span> <span class="method">fetchOrders</span>(<span class="variable">user</span>.<span class="variable">id</span>);
  <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">orders</span>);

  <span class="keyword">return</span> { <span class="variable">user</span>, <span class="variable">orders</span> };
}

<span class="comment">// async関数の呼び出し</span>
<span class="method">fetchUserData</span>().<span class="method">then</span>((<span class="variable">data</span>) => {
  <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">data</span>);
});

<span class="comment">// アロー関数でも使える</span>
<span class="keyword">const</span> <span class="variable">getData</span> = <span class="keyword">async</span> () => {
  <span class="keyword">const</span> <span class="variable">result</span> = <span class="keyword">await</span> <span class="method">someAsyncFunction</span>();
  <span class="keyword">return</span> <span class="variable">result</span>;
};</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="syntax-box">
          <div class="syntax-box-header">
            <span class="syntax-box-icon"><span class="material-icons">menu_book</span></span>
            <span class="syntax-box-title">構文説明</span>
          </div>
          <div class="syntax-box-content">
            <div class="syntax-item">
              <h4>async function</h4>
              <div class="syntax-pattern">async function 関数名() {
  ...
}</div>
              <p>非同期関数を定義します。この関数内では<code>await</code>が使えます。戻り値は自動的にPromiseでラップされます。</p>
            </div>
            <div class="syntax-item">
              <h4>await</h4>
              <div class="syntax-pattern">const 結果 = await Promise;</div>
              <p>Promiseの完了を待機し、resolve された値を返します。async関数の中でのみ使用できます。</p>
            </div>
            <div class="syntax-item">
              <h4>アロー関数での async</h4>
              <div class="syntax-pattern">const fn = async () => {
  ...
}</div>
              <p>アロー関数でも async を使用できます。<code>async</code>を<code>() =></code>の前に置きます。</p>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>try-catch でエラーハンドリング</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
async/awaitでのエラーハンドリング

## 実装要件
- `try`ブロックでメイン処理
- `fetch()`でAPIリクエスト
- `response.ok`でHTTPエラーをチェック
- `catch`ブロックでエラー処理
- `finally`ブロックでローディング状態を解除

## 使用する構文
- try-catch-finally
- async/await
- fetch()
- response.ok / response.status</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">エラーハンドリング</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">async</span> <span class="keyword">function</span> <span class="method">fetchData</span>() {
  <span class="keyword">try</span> {
    <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="string">'/api/data'</span>);

    <span class="comment">// HTTPエラーをチェック</span>
    <span class="keyword">if</span> (!<span class="variable">response</span>.<span class="variable">ok</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">`HTTP error: ${<span class="variable">response</span>.<span class="variable">status</span>}`</span>);
    }

    <span class="keyword">const</span> <span class="variable">data</span> = <span class="keyword">await</span> <span class="variable">response</span>.<span class="method">json</span>();
    <span class="keyword">return</span> <span class="variable">data</span>;

  } <span class="keyword">catch</span> (<span class="variable">error</span>) {
    <span class="variable">console</span>.<span class="method">error</span>(<span class="string">"エラー発生:"</span>, <span class="variable">error</span>.<span class="variable">message</span>);
    <span class="comment">// ユーザーに通知</span>
    <span class="method">showErrorMessage</span>(<span class="string">"データの取得に失敗しました"</span>);

  } <span class="keyword">finally</span> {
    <span class="comment">// 成功/失敗に関わらず実行</span>
    <span class="method">hideLoading</span>();
  }
}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="syntax-box">
          <div class="syntax-box-header">
            <span class="syntax-box-icon"><span class="material-icons">menu_book</span></span>
            <span class="syntax-box-title">構文説明</span>
          </div>
          <div class="syntax-box-content">
            <div class="syntax-item">
              <h4>try-catch-finally（非同期）</h4>
              <div class="syntax-pattern">try {
  await 処理
} catch (error) {
  ...
} finally {
  ...
}</div>
              <p>async関数内でawaitを使用する場合、try-catchでエラーをキャッチできます。Promiseの.catch()と同じ役割です。</p>
            </div>
            <div class="syntax-item">
              <h4>response.ok</h4>
              <div class="syntax-pattern">if (!response.ok) { throw new Error(...) }</div>
              <p>HTTPステータスコードが200-299の範囲ならtrue。fetch()はネットワークエラー以外（404など）ではエラーにならないため、手動でチェックが必要です。</p>
            </div>
            <div class="syntax-item">
              <h4>throw new Error()</h4>
              <div class="syntax-pattern">throw new Error("エラーメッセージ");</div>
              <p>エラーを明示的に発生させます。catchブロックで捕捉されます。</p>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>並列実行</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
複数の非同期処理を効率的に並列実行

## 実装要件
- 順番に実行する非効率なパターンを示す
- `Promise.all()`で並列実行する効率的なパターン
- 分割代入で結果を受け取る

## 比較
- 順番実行: `await A; await B;` - 遅い
- 並列実行: `await Promise.all([A, B])` - 速い

## 使用するAPI
- Promise.all()
- async/await
- 分割代入 `[a, b] = await ...`</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">Promise.all + await</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">async</span> <span class="keyword">function</span> <span class="method">fetchAllData</span>() {
  <span class="comment">// ❌ 順番に実行（遅い）</span>
  <span class="keyword">const</span> <span class="variable">users</span> = <span class="keyword">await</span> <span class="method">fetchUsers</span>();      <span class="comment">// 待つ</span>
  <span class="keyword">const</span> <span class="variable">products</span> = <span class="keyword">await</span> <span class="method">fetchProducts</span>();  <span class="comment">// 待つ</span>

  <span class="comment">// ✅ 並列実行（速い）</span>
  <span class="keyword">const</span> [<span class="variable">users</span>, <span class="variable">products</span>] = <span class="keyword">await</span> <span class="variable">Promise</span>.<span class="method">all</span>([
    <span class="method">fetchUsers</span>(),
    <span class="method">fetchProducts</span>()
  ]);

  <span class="keyword">return</span> { <span class="variable">users</span>, <span class="variable">products</span> };
}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="info-box">
          <div class="info-box-title"><span class="material-icons">lightbulb</span> 並列実行のポイント</div>
          <div class="info-box-content">
            <p>依存関係がない複数の非同期処理は、<code>Promise.all()</code>で並列実行すると高速になります。ただし、1つでも失敗すると全体が失敗するので注意。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 9-4 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-4</span>
        <h2 class="section-title">Fetch API</h2>
      </div>

      <div class="intro-text">
        <p>Fetch APIは、ネットワークリクエストを行うためのモダンなインターフェースです。Promiseベースで設計されており、async/awaitと相性が良いです。</p>
      </div>

      <div class="subsection">
        <h3>GET リクエスト</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
Fetch APIでGETリクエストを送信

## 実装要件
- `fetch()`でGETリクエスト
- `response.json()`でJSONをパース
- `URLSearchParams`でクエリパラメータを構築
- テンプレートリテラルでURLを組み立て

## 使用するAPI
- fetch(url)
- response.json()
- new URLSearchParams({ key: value })

## URL例
- 基本: `/api/users`
- パラメータ付き: `/api/users?name=value`</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">GETリクエストの基本</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="comment">// 基本的なGETリクエスト</span>
<span class="keyword">async</span> <span class="keyword">function</span> <span class="method">getUsers</span>() {
  <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="string">'https://jsonplaceholder.typicode.com/users'</span>);
  <span class="keyword">const</span> <span class="variable">users</span> = <span class="keyword">await</span> <span class="variable">response</span>.<span class="method">json</span>();
  <span class="variable">console</span>.<span class="method">log</span>(<span class="variable">users</span>);
  <span class="keyword">return</span> <span class="variable">users</span>;
}

<span class="comment">// クエリパラメータ付き</span>
<span class="keyword">async</span> <span class="keyword">function</span> <span class="method">searchUsers</span>(<span class="variable">name</span>) {
  <span class="keyword">const</span> <span class="variable">params</span> = <span class="keyword">new</span> <span class="class-name">URLSearchParams</span>({ <span class="variable">name</span> });
  <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="string">`/api/users?${<span class="variable">params</span>}`</span>);
  <span class="keyword">return</span> <span class="variable">response</span>.<span class="method">json</span>();
}</pre>
              </div>
            </div>
            <div class="demo-preview-section">
              <div class="demo-preview-header">
                <span class="demo-preview-label">デモ</span>
              </div>
              <div class="demo-preview-content">
                <button id="fetch-btn" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">ユーザー取得</button>
                <div id="fetch-result" style="margin-top: 12px; max-height: 150px; overflow-y: auto; font-size: 13px; background: #f1f5f9; padding: 12px; border-radius: 8px; display: none;"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="syntax-box">
          <div class="syntax-box-header">
            <span class="syntax-box-icon"><span class="material-icons">menu_book</span></span>
            <span class="syntax-box-title">構文説明</span>
          </div>
          <div class="syntax-box-content">
            <div class="syntax-item">
              <h4>fetch()</h4>
              <div class="syntax-pattern">fetch(URL, オプション)</div>
              <p>ネットワークリクエストを送信し、Responseオブジェクトを返すPromiseを返します。GETリクエストの場合、オプションは省略可能です。</p>
            </div>
            <div class="syntax-item">
              <h4>response.json()</h4>
              <div class="syntax-pattern">const data = await response.json();</div>
              <p>レスポンスボディをJSONとしてパースします。Promiseを返すため、awaitが必要です。</p>
            </div>
            <div class="syntax-item">
              <h4>URLSearchParams</h4>
              <div class="syntax-pattern">new URLSearchParams({ key: value })</div>
              <p>URLのクエリパラメータを構築するためのオブジェクト。オブジェクトを渡すと自動でエンコードされます。</p>
            </div>
          </div>
        </div>

        <script>
          document.getElementById('fetch-btn').addEventListener('click', async () => {
            const btn = document.getElementById('fetch-btn');
            const result = document.getElementById('fetch-result');
            btn.textContent = '読み込み中...';
            btn.disabled = true;

            try {
              const response = await fetch('https://jsonplaceholder.typicode.com/users?_limit=3');
              const users = await response.json();

              result.style.display = 'block';
              result.innerHTML = users.map(u => `<div style="margin-bottom: 8px;"><strong>${u.name}</strong><br><span style="color: #64748b;">${u.email}</span></div>`).join('');
            } catch (error) {
              result.style.display = 'block';
              result.textContent = 'エラー: ' + error.message;
            } finally {
              btn.textContent = 'ユーザー取得';
              btn.disabled = false;
            }
          });
        </script>
      </div>

      <div class="subsection">
        <h3>POST リクエスト</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
Fetch APIでPOSTリクエストを送信

## 実装要件
- `fetch()`の第2引数にオプションを指定
- `method: 'POST'`でPOSTリクエスト
- `headers`に`Content-Type: application/json`を設定
- `body`に`JSON.stringify()`でJSON文字列を設定
- `response.ok`でエラーチェック

## 使用するAPI
- fetch(url, options)
- JSON.stringify()
- response.ok / response.json()

## オプション構造
- method: 'POST'
- headers: { 'Content-Type': 'application/json' }
- body: JSON.stringify(data)</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">POSTリクエスト</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">async</span> <span class="keyword">function</span> <span class="method">createUser</span>(<span class="variable">userData</span>) {
  <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="string">'https://api.example.com/users'</span>, {
    <span class="variable">method</span>: <span class="string">'POST'</span>,
    <span class="variable">headers</span>: {
      <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,
    },
    <span class="variable">body</span>: <span class="variable">JSON</span>.<span class="method">stringify</span>(<span class="variable">userData</span>)
  });

  <span class="keyword">if</span> (!<span class="variable">response</span>.<span class="variable">ok</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'ユーザー作成に失敗'</span>);
  }

  <span class="keyword">return</span> <span class="variable">response</span>.<span class="method">json</span>();
}

<span class="comment">// 使用例</span>
<span class="method">createUser</span>({
  <span class="variable">name</span>: <span class="string">'田中太郎'</span>,
  <span class="variable">email</span>: <span class="string">'tanaka@example.com'</span>
}).<span class="method">then</span>(<span class="variable">user</span> => {
  <span class="variable">console</span>.<span class="method">log</span>(<span class="string">'作成成功:'</span>, <span class="variable">user</span>);
});</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>レスポンスの処理</h3>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>メソッド</th>
                <th>説明</th>
                <th>用途</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>response.json()</code></td>
                <td>JSONとしてパース</td>
                <td>APIからのJSON応答</td>
              </tr>
              <tr>
                <td><code>response.text()</code></td>
                <td>テキストとして取得</td>
                <td>HTML、プレーンテキスト</td>
              </tr>
              <tr>
                <td><code>response.blob()</code></td>
                <td>バイナリデータ</td>
                <td>画像、ファイル</td>
              </tr>
              <tr>
                <td><code>response.ok</code></td>
                <td>成功判定（200-299）</td>
                <td>エラーチェック</td>
              </tr>
              <tr>
                <td><code>response.status</code></td>
                <td>HTTPステータスコード</td>
                <td>詳細なエラー判定</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Section 9-5 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-5</span>
        <h2 class="section-title">エラーハンドリング</h2>
      </div>

      <div class="intro-text">
        <p>非同期処理では、ネットワークエラー、サーバーエラー、JSONパースエラーなど様々なエラーが発生する可能性があります。適切にハンドリングしましょう。</p>
      </div>

      <div class="subsection">
        <h3>包括的なエラーハンドリング</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
HTTPステータスコード別のエラーハンドリング

## 実装要件
- `response.ok`でHTTPエラーをチェック
- `switch`文でステータスコード別に処理
- 400: リクエストが不正
- 401: 認証が必要
- 404: データが見つからない
- 500: サーバーエラー
- `TypeError`でネットワークエラーを検出

## 使用するAPI
- response.ok
- response.status
- try-catch
- error.name === 'TypeError'</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">実践的なエラーハンドリング</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">async</span> <span class="keyword">function</span> <span class="method">fetchData</span>(<span class="variable">url</span>) {
  <span class="keyword">try</span> {
    <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="variable">url</span>);

    <span class="comment">// HTTPエラーのチェック</span>
    <span class="keyword">if</span> (!<span class="variable">response</span>.<span class="variable">ok</span>) {
      <span class="keyword">switch</span> (<span class="variable">response</span>.<span class="variable">status</span>) {
        <span class="keyword">case</span> <span class="number">400</span>:
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'リクエストが不正です'</span>);
        <span class="keyword">case</span> <span class="number">401</span>:
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'認証が必要です'</span>);
        <span class="keyword">case</span> <span class="number">404</span>:
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'データが見つかりません'</span>);
        <span class="keyword">case</span> <span class="number">500</span>:
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'サーバーエラーが発生しました'</span>);
        <span class="keyword">default</span>:
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">`エラー: ${<span class="variable">response</span>.<span class="variable">status</span>}`</span>);
      }
    }

    <span class="keyword">const</span> <span class="variable">data</span> = <span class="keyword">await</span> <span class="variable">response</span>.<span class="method">json</span>();
    <span class="keyword">return</span> <span class="variable">data</span>;

  } <span class="keyword">catch</span> (<span class="variable">error</span>) {
    <span class="comment">// ネットワークエラー（オフライン等）</span>
    <span class="keyword">if</span> (<span class="variable">error</span>.<span class="variable">name</span> === <span class="string">'TypeError'</span>) {
      <span class="variable">console</span>.<span class="method">error</span>(<span class="string">'ネットワークエラー'</span>);
    } <span class="keyword">else</span> {
      <span class="variable">console</span>.<span class="method">error</span>(<span class="variable">error</span>.<span class="variable">message</span>);
    }
    <span class="keyword">throw</span> <span class="variable">error</span>;  <span class="comment">// 呼び出し元に伝播</span>
  }
}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="subsection">
        <h3>ユーザーへのエラー表示</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
非同期処理のUI状態管理

## 実装要件
- ローディング表示の切り替え
- エラーメッセージの表示/非表示
- 正常時のデータ表示
- `try-catch-finally`で状態を管理

## UI状態
1. 開始時: ローディング表示ON、エラー非表示
2. 成功時: データを描画
3. 失敗時: エラーメッセージ表示
4. 完了時: ローディング表示OFF

## 使用するAPI
- element.style.display
- element.textContent
- try-catch-finally</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">エラー表示のパターン</span>
          </div>
          <div class="demo-body">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="keyword">async</span> <span class="keyword">function</span> <span class="method">loadUserData</span>() {
  <span class="keyword">const</span> <span class="variable">container</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'user-container'</span>);
  <span class="keyword">const</span> <span class="variable">loading</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'loading'</span>);
  <span class="keyword">const</span> <span class="variable">error</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'error'</span>);

  <span class="keyword">try</span> {
    <span class="comment">// ローディング表示</span>
    <span class="variable">loading</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'block'</span>;
    <span class="variable">error</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'none'</span>;

    <span class="keyword">const</span> <span class="variable">users</span> = <span class="keyword">await</span> <span class="method">fetchUsers</span>();
    <span class="method">renderUsers</span>(<span class="variable">users</span>);

  } <span class="keyword">catch</span> (<span class="variable">err</span>) {
    <span class="comment">// エラー表示</span>
    <span class="variable">error</span>.<span class="variable">textContent</span> = <span class="variable">err</span>.<span class="variable">message</span>;
    <span class="variable">error</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'block'</span>;

  } <span class="keyword">finally</span> {
    <span class="comment">// ローディング非表示</span>
    <span class="variable">loading</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'none'</span>;
  }
}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 9-6 実習 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">Section 9-6</span>
        <h2 class="section-title">実習：天気予報アプリ</h2>
      </div>

      <div class="intro-text">
        <p>Open-Meteo APIを使用して、天気予報アプリを作成します。都市名から天気情報を取得し、表示します。</p>
      </div>

      <div class="subsection">
        <h3>完成イメージ</h3>
        <div class="demo-area" style="padding: 20px;">
          <div style="max-width: 400px; margin: 0 auto; background: #667eea; padding: 30px; border-radius: 20px; color: white;">
            <h3 style="margin: 0 0 20px; text-align: center;">天気予報</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
              <input type="text" id="city-input" placeholder="都市名を入力" style="flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px;">
              <button id="search-btn" style="padding: 12px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 10px; cursor: pointer;">🔍</button>
            </div>
            <div id="weather-result" style="text-align: center; min-height: 150px; display: flex; flex-direction: column; justify-content: center;">
              <p style="opacity: 0.8;">都市名を入力して検索してください</p>
            </div>
          </div>
        </div>

        <script>
          const cities = {
            '東京': { lat: 35.6895, lon: 139.6917 },
            '大阪': { lat: 34.6937, lon: 135.5023 },
            '名古屋': { lat: 35.1815, lon: 136.9066 },
            '福岡': { lat: 33.5904, lon: 130.4017 },
            '札幌': { lat: 43.0618, lon: 141.3545 }
          };

          const weatherCodes = {
            0: { icon: '☀️', desc: '晴れ' },
            1: { icon: '🌤️', desc: '晴れ' },
            2: { icon: '⛅', desc: '曇り' },
            3: { icon: '☁️', desc: '曇り' },
            45: { icon: '🌫️', desc: '霧' },
            48: { icon: '🌫️', desc: '霧' },
            51: { icon: '🌧️', desc: '霧雨' },
            53: { icon: '🌧️', desc: '霧雨' },
            55: { icon: '🌧️', desc: '霧雨' },
            61: { icon: '🌧️', desc: '雨' },
            63: { icon: '🌧️', desc: '雨' },
            65: { icon: '🌧️', desc: '大雨' },
            71: { icon: '🌨️', desc: '雪' },
            73: { icon: '🌨️', desc: '雪' },
            75: { icon: '❄️', desc: '大雪' },
            95: { icon: '⛈️', desc: '雷雨' }
          };

          document.getElementById('search-btn').addEventListener('click', async () => {
            const cityName = document.getElementById('city-input').value.trim();
            const result = document.getElementById('weather-result');

            if (!cityName) {
              result.innerHTML = '<p style="color: #fca5a5;">都市名を入力してください</p>';
              return;
            }

            const city = cities[cityName];
            if (!city) {
              result.innerHTML = `<p style="color: #fca5a5;">${cityName}は対応していません。<br>対応都市: ${Object.keys(cities).join(', ')}</p>`;
              return;
            }

            result.innerHTML = '<p>読み込み中...</p>';

            try {
              const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`);
              const data = await res.json();
              const weather = data.current_weather;
              const info = weatherCodes[weather.weathercode] || { icon: '❓', desc: '不明' };

              result.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 10px;">${info.icon}</div>
                <div style="font-size: 48px; font-weight: bold;">${weather.temperature}°C</div>
                <div style="font-size: 18px; opacity: 0.9;">${info.desc}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 10px;">風速: ${weather.windspeed} km/h</div>
              `;
            } catch (error) {
              result.innerHTML = '<p style="color: #fca5a5;">エラーが発生しました</p>';
            }
          });
        </script>
      </div>

      <div class="subsection">
        <h3>実装コード</h3>

        <div class="prompt-box">
          <div class="prompt-box-header">
            <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
            <span class="prompt-box-title">プロンプト</span>
            <button class="prompt-copy-btn">コピー</button>
          </div>
          <div class="prompt-box-content">
            <pre>## 機能
天気予報アプリを作成

## 実装要件
- `async/await`と`fetch()`でAPIリクエスト
- Open-Meteo APIから天気情報を取得
- 都市名から緯度経度を取得して検索
- 検索履歴を`localStorage`に保存
- ローディング表示とエラーハンドリング

## 使用するAPI
- fetch()
- async/await
- localStorage.getItem() / setItem()
- JSON.parse() / JSON.stringify()

## データフロー
1. 都市名入力 → 座標取得
2. Open-Meteo APIリクエスト
3. 天気情報を画面に表示
4. 検索履歴を保存</pre>
            </div>
          </div>
        </div>

        <div class="demo-container">
          <div class="demo-header">
            <span class="demo-title">weather-app.html</span>
          </div>
          <div class="demo-body vertical">
            <div class="demo-code-section">
              <div class="demo-code-header">
                <span class="demo-code-lang">HTML + JavaScript</span>
                <button class="demo-copy-btn">コピー</button>
              </div>
              <pre class="demo-code-content"><code><span class="tag">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attr">lang</span>=<span class="value">"ja"</span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">charset</span>=<span class="value">"UTF-8"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">name</span>=<span class="value">"viewport"</span> <span class="attr">content</span>=<span class="value">"width=device-width, initial-scale=1.0"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;title&gt;</span>天気予報アプリ<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;style&gt;</span>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: sans-serif;
      min-height: 100vh;
      background: #667eea;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .app {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      color: white;
    }
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
    }
    .search-box button {
      padding: 12px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
    }
    .weather-card {
      text-align: center;
      padding: 20px;
    }
    .weather-icon { font-size: 80px; }
    .temperature { font-size: 48px; font-weight: bold; margin: 10px 0; }
    .description { font-size: 20px; opacity: 0.9; }
    .details { margin-top: 20px; display: flex; justify-content: center; gap: 30px; }
    .detail-item { text-align: center; }
    .detail-label { font-size: 12px; opacity: 0.7; }
    .detail-value { font-size: 18px; font-weight: bold; }
    .loading { text-align: center; padding: 40px; }
    .error { text-align: center; color: #fca5a5; padding: 20px; }
    .history { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; }
    .history-title { font-size: 14px; opacity: 0.7; margin-bottom: 10px; }
    .history-list { display: flex; gap: 8px; flex-wrap: wrap; }
    .history-item {
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
    }
  <span class="tag">&lt;/style&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>
  <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"app"</span><span class="tag">&gt;</span>
    <span class="tag">&lt;h1</span> <span class="attr">style</span>=<span class="value">"text-align: center; margin-bottom: 20px;"</span><span class="tag">&gt;</span>天気予報<span class="tag">&lt;/h1&gt;</span>

    <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"search-box"</span><span class="tag">&gt;</span>
      <span class="tag">&lt;input</span> <span class="attr">type</span>=<span class="value">"text"</span> <span class="attr">id</span>=<span class="value">"cityInput"</span> <span class="attr">placeholder</span>=<span class="value">"都市名を入力（例: 東京）"</span><span class="tag">&gt;</span>
      <span class="tag">&lt;button</span> <span class="attr">id</span>=<span class="value">"searchBtn"</span><span class="tag">&gt;</span>🔍<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attr">id</span>=<span class="value">"result"</span><span class="tag">&gt;</span>
      <span class="tag">&lt;p</span> <span class="attr">style</span>=<span class="value">"text-align: center; opacity: 0.8;"</span><span class="tag">&gt;</span>都市名を入力して検索<span class="tag">&lt;/p&gt;</span>
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"history"</span> <span class="attr">id</span>=<span class="value">"history"</span> <span class="attr">style</span>=<span class="value">"display: none;"</span><span class="tag">&gt;</span>
      <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"history-title"</span><span class="tag">&gt;</span>検索履歴<span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"history-list"</span> <span class="attr">id</span>=<span class="value">"historyList"</span><span class="tag">&gt;&lt;/div&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;script&gt;</span>
    <span class="comment">// 都市の座標データ</span>
    <span class="keyword">const</span> <span class="variable">CITIES</span> = {
      <span class="string">'東京'</span>: { <span class="variable">lat</span>: <span class="number">35.6895</span>, <span class="variable">lon</span>: <span class="number">139.6917</span> },
      <span class="string">'大阪'</span>: { <span class="variable">lat</span>: <span class="number">34.6937</span>, <span class="variable">lon</span>: <span class="number">135.5023</span> },
      <span class="string">'名古屋'</span>: { <span class="variable">lat</span>: <span class="number">35.1815</span>, <span class="variable">lon</span>: <span class="number">136.9066</span> },
      <span class="string">'福岡'</span>: { <span class="variable">lat</span>: <span class="number">33.5904</span>, <span class="variable">lon</span>: <span class="number">130.4017</span> },
      <span class="string">'札幌'</span>: { <span class="variable">lat</span>: <span class="number">43.0618</span>, <span class="variable">lon</span>: <span class="number">141.3545</span> },
    };

    <span class="comment">// 天気コードの変換</span>
    <span class="keyword">const</span> <span class="variable">WEATHER_CODES</span> = {
      <span class="number">0</span>: { <span class="variable">icon</span>: <span class="string">'☀️'</span>, <span class="variable">desc</span>: <span class="string">'快晴'</span> },
      <span class="number">1</span>: { <span class="variable">icon</span>: <span class="string">'🌤️'</span>, <span class="variable">desc</span>: <span class="string">'晴れ'</span> },
      <span class="number">2</span>: { <span class="variable">icon</span>: <span class="string">'⛅'</span>, <span class="variable">desc</span>: <span class="string">'曇り'</span> },
      <span class="number">3</span>: { <span class="variable">icon</span>: <span class="string">'☁️'</span>, <span class="variable">desc</span>: <span class="string">'曇り'</span> },
      <span class="number">61</span>: { <span class="variable">icon</span>: <span class="string">'🌧️'</span>, <span class="variable">desc</span>: <span class="string">'雨'</span> },
      <span class="number">71</span>: { <span class="variable">icon</span>: <span class="string">'🌨️'</span>, <span class="variable">desc</span>: <span class="string">'雪'</span> },
    };

    <span class="comment">// 検索履歴</span>
    <span class="keyword">let</span> <span class="variable">searchHistory</span> = <span class="variable">JSON</span>.<span class="method">parse</span>(<span class="variable">localStorage</span>.<span class="method">getItem</span>(<span class="string">'weatherHistory'</span>)) || [];

    <span class="comment">// 天気情報を取得</span>
    <span class="keyword">async</span> <span class="keyword">function</span> <span class="method">fetchWeather</span>(<span class="variable">cityName</span>) {
      <span class="keyword">const</span> <span class="variable">city</span> = <span class="variable">CITIES</span>[<span class="variable">cityName</span>];
      <span class="keyword">if</span> (!<span class="variable">city</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">`${<span class="variable">cityName</span>}は対応していません`</span>);
      }

      <span class="keyword">const</span> <span class="variable">url</span> = <span class="string">`https://api.open-meteo.com/v1/forecast?latitude=${<span class="variable">city</span>.<span class="variable">lat</span>}&longitude=${<span class="variable">city</span>.<span class="variable">lon</span>}&current_weather=true`</span>;
      <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="method">fetch</span>(<span class="variable">url</span>);

      <span class="keyword">if</span> (!<span class="variable">response</span>.<span class="variable">ok</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class-name">Error</span>(<span class="string">'天気情報の取得に失敗しました'</span>);
      }

      <span class="keyword">return</span> <span class="variable">response</span>.<span class="method">json</span>();
    }

    <span class="comment">// 結果を表示</span>
    <span class="keyword">function</span> <span class="method">displayWeather</span>(<span class="variable">data</span>, <span class="variable">cityName</span>) {
      <span class="keyword">const</span> <span class="variable">weather</span> = <span class="variable">data</span>.<span class="variable">current_weather</span>;
      <span class="keyword">const</span> <span class="variable">info</span> = <span class="variable">WEATHER_CODES</span>[<span class="variable">weather</span>.<span class="variable">weathercode</span>] || { <span class="variable">icon</span>: <span class="string">'❓'</span>, <span class="variable">desc</span>: <span class="string">'不明'</span> };

      <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'result'</span>).<span class="variable">innerHTML</span> = <span class="string">`
        &lt;div class="weather-card"&gt;
          &lt;div class="weather-icon"&gt;${<span class="variable">info</span>.<span class="variable">icon</span>}&lt;/div&gt;
          &lt;div class="temperature"&gt;${<span class="variable">weather</span>.<span class="variable">temperature</span>}°C&lt;/div&gt;
          &lt;div class="description"&gt;${<span class="variable">cityName</span>} - ${<span class="variable">info</span>.<span class="variable">desc</span>}&lt;/div&gt;
          &lt;div class="details"&gt;
            &lt;div class="detail-item"&gt;
              &lt;div class="detail-label"&gt;風速&lt;/div&gt;
              &lt;div class="detail-value"&gt;${<span class="variable">weather</span>.<span class="variable">windspeed</span>} km/h&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      `</span>;
    }

    <span class="comment">// 履歴を追加</span>
    <span class="keyword">function</span> <span class="method">addToHistory</span>(<span class="variable">cityName</span>) {
      <span class="variable">searchHistory</span> = [<span class="variable">cityName</span>, ...<span class="variable">searchHistory</span>.<span class="method">filter</span>(<span class="variable">c</span> => <span class="variable">c</span> !== <span class="variable">cityName</span>)].<span class="method">slice</span>(<span class="number">0</span>, <span class="number">5</span>);
      <span class="variable">localStorage</span>.<span class="method">setItem</span>(<span class="string">'weatherHistory'</span>, <span class="variable">JSON</span>.<span class="method">stringify</span>(<span class="variable">searchHistory</span>));
      <span class="method">renderHistory</span>();
    }

    <span class="comment">// 履歴を表示</span>
    <span class="keyword">function</span> <span class="method">renderHistory</span>() {
      <span class="keyword">const</span> <span class="variable">historyEl</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'history'</span>);
      <span class="keyword">const</span> <span class="variable">listEl</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'historyList'</span>);

      <span class="keyword">if</span> (<span class="variable">searchHistory</span>.<span class="variable">length</span> === <span class="number">0</span>) {
        <span class="variable">historyEl</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'none'</span>;
        <span class="keyword">return</span>;
      }

      <span class="variable">historyEl</span>.<span class="variable">style</span>.<span class="variable">display</span> = <span class="string">'block'</span>;
      <span class="variable">listEl</span>.<span class="variable">innerHTML</span> = <span class="variable">searchHistory</span>.<span class="method">map</span>(<span class="variable">city</span> =>
        <span class="string">`&lt;span class="history-item" data-city="${<span class="variable">city</span>}"&gt;${<span class="variable">city</span>}&lt;/span&gt;`</span>
      ).<span class="method">join</span>(<span class="string">''</span>);
    }

    <span class="comment">// 検索処理</span>
    <span class="keyword">async</span> <span class="keyword">function</span> <span class="method">search</span>(<span class="variable">cityName</span>) {
      <span class="keyword">const</span> <span class="variable">result</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'result'</span>);
      <span class="variable">result</span>.<span class="variable">innerHTML</span> = <span class="string">'&lt;div class="loading"&gt;読み込み中...&lt;/div&gt;'</span>;

      <span class="keyword">try</span> {
        <span class="keyword">const</span> <span class="variable">data</span> = <span class="keyword">await</span> <span class="method">fetchWeather</span>(<span class="variable">cityName</span>);
        <span class="method">displayWeather</span>(<span class="variable">data</span>, <span class="variable">cityName</span>);
        <span class="method">addToHistory</span>(<span class="variable">cityName</span>);
      } <span class="keyword">catch</span> (<span class="variable">error</span>) {
        <span class="variable">result</span>.<span class="variable">innerHTML</span> = <span class="string">`&lt;div class="error"&gt;${<span class="variable">error</span>.<span class="variable">message</span>}&lt;/div&gt;`</span>;
      }
    }

    <span class="comment">// イベント設定</span>
    <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'searchBtn'</span>).<span class="method">addEventListener</span>(<span class="string">'click'</span>, () => {
      <span class="keyword">const</span> <span class="variable">cityName</span> = <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'cityInput'</span>).<span class="variable">value</span>.<span class="method">trim</span>();
      <span class="keyword">if</span> (<span class="variable">cityName</span>) <span class="method">search</span>(<span class="variable">cityName</span>);
    });

    <span class="comment">// 履歴クリック</span>
    <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'historyList'</span>).<span class="method">addEventListener</span>(<span class="string">'click'</span>, (<span class="variable">e</span>) => {
      <span class="keyword">if</span> (<span class="variable">e</span>.<span class="variable">target</span>.<span class="variable">classList</span>.<span class="method">contains</span>(<span class="string">'history-item'</span>)) {
        <span class="keyword">const</span> <span class="variable">cityName</span> = <span class="variable">e</span>.<span class="variable">target</span>.<span class="variable">dataset</span>.<span class="variable">city</span>;
        <span class="variable">document</span>.<span class="method">getElementById</span>(<span class="string">'cityInput'</span>).<span class="variable">value</span> = <span class="variable">cityName</span>;
        <span class="method">search</span>(<span class="variable">cityName</span>);
      }
    });

    <span class="comment">// 初期化</span>
    <span class="method">renderHistory</span>();
  <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 練習問題 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">練習問題</span>
        <h2 class="section-title">Chapter 9 練習問題</h2>
      </div>

      <div class="exercise-list">
        <div class="exercise-item">
          <div class="exercise-number">Q1</div>
          <div class="exercise-content">
            <p>同期処理と非同期処理の違いを説明してください。</p>
          </div>
        </div>

        <div class="exercise-item">
          <div class="exercise-number">Q2</div>
          <div class="exercise-content">
            <p>以下のPromiseチェーンを、async/await構文で書き換えてください。</p>
            <div class="code-block">
              <div class="code-content">
<pre>fetchUser(1)
  .then(user => fetchOrders(user.id))
  .then(orders => console.log(orders))
  .catch(error => console.error(error));</pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="exercise-item">
          <div class="exercise-number">Q3</div>
          <div class="exercise-content">
            <p>JSONPlaceholder API (<code>https://jsonplaceholder.typicode.com/posts</code>) から投稿一覧を取得し、最初の5件のタイトルを表示するコードを書いてください。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 解答 -->
    <section class="section">
      <div class="section-header">
        <span class="section-number">解答</span>
        <h2 class="section-title">練習問題の解答</h2>
      </div>

      <div class="answer-list">
        <div class="answer-item">
          <div class="answer-header">Q1の解答</div>
          <div class="answer-content">
            <p><strong>同期処理</strong>：処理が順番に実行され、前の処理が終わるまで次の処理は待機する。シンプルだが、時間のかかる処理があると全体がブロックされる。</p>
            <p><strong>非同期処理</strong>：時間のかかる処理を待たずに次の処理を実行できる。処理が完了したらコールバック等で結果を受け取る。効率的だが、処理順序の制御が必要。</p>
          </div>
        </div>

        <div class="answer-item">
          <div class="answer-header">Q2の解答</div>
          <div class="answer-content">
            <div class="code-block">
              <div class="code-content">
<pre>async function getUserOrders() {
  try {
    const user = await fetchUser(1);
    const orders = await fetchOrders(user.id);
    console.log(orders);
  } catch (error) {
    console.error(error);
  }
}

getUserOrders();</pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="answer-item">
          <div class="answer-header">Q3の解答</div>
          <div class="answer-content">
            <div class="code-block">
              <div class="code-content">
<pre>async function displayPosts() {
  try {
    const response = await fetch('https://jsonplaceholder.typicode.com/posts');
    const posts = await response.json();

    const firstFive = posts.slice(0, 5);
    firstFive.forEach(post => {
      console.log(post.title);
    });
  } catch (error) {
    console.error('エラー:', error);
  }
}

displayPosts();</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ページナビゲーション -->
  <div class="page-nav">
    <a href="8js-forms.html" class="page-nav-btn prev">
      <div class="page-nav-label">前へ</div>
      <div class="page-nav-title">フォーム処理とバリデーション</div>
    </a>
    <a href="10js-animation.html" class="page-nav-btn next">
      <div class="page-nav-label">次へ</div>
      <div class="page-nav-title">アニメーション</div>
    </a>
  </div>

  <footer class="footer">
    <p>JavaScript入門 - 職業訓練校教材</p>
  </footer>

  <script src="../shared/demo.js"></script>
</body>
</html>
