<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第6章 環境変数とシークレット - GitHub Actions入門</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../shared/common.css">
    <style>
      :root {
        --primary: #2088FF;
        --primary-dark: #1A6FD6;
        --primary-light: #E8F1FF;
        --primary-lighter: #B3D4FF;
      }
      body { padding-top: 48px; }
      .nav-category-links { display: none; }
      .visual-diagram {
        margin: 28px 0; padding: 28px 20px;
        background: linear-gradient(135deg, #eef5ff 0%, #e8f1ff 100%);
        border-radius: 16px; border: 1px solid #b3d4ff;
      }
      .visual-diagram-title {
        text-align: center; font-size: 0.82rem; font-weight: 700;
        color: #2088FF; margin-bottom: 20px; letter-spacing: 0.05em;
      }
      .vd-flow {
        display: flex; align-items: center; justify-content: center;
        gap: 10px; flex-wrap: wrap;
      }
      .vd-box {
        background: white; border: 2px solid #2088FF; border-radius: 14px;
        padding: 16px 14px; text-align: center; min-width: 110px;
        box-shadow: 0 2px 8px rgba(32,136,255,0.08);
      }
      .vd-box.accent { background: #2088FF; color: white; }
      .vd-box .vd-icon { font-size: 1.6rem; display: block; margin-bottom: 4px; }
      .vd-box .vd-label { font-size: 0.78rem; font-weight: 700; display: block; }
      .vd-box .vd-sub { font-size: 0.68rem; opacity: 0.7; display: block; margin-top: 2px; }
      .vd-arrow { color: #2088FF; font-size: 1.3rem; font-weight: 700; }
      .vd-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
      .vd-card {
        background: white; border-radius: 12px; padding: 16px; text-align: center;
        border: 2px solid #e8f1ff; box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      }
      .vd-card .vd-icon { font-size: 1.8rem; display: block; margin-bottom: 6px; }
      .vd-card .vd-label { font-size: 0.78rem; font-weight: 700; display: block; color: #2088FF; }
      .vd-card .vd-sub { font-size: 0.68rem; color: #666; display: block; margin-top: 4px; }
      .vd-card.green { border-color: #a5d6a7; background: #f1f8e9; }
      .vd-card.red { border-color: #ef9a9a; background: #fce4ec; }
      .vd-card.blue { border-color: #90caf9; background: #e3f2fd; }
      .vd-card.amber { border-color: #ffe082; background: #fff8e1; }
      .vd-card.purple { border-color: #ce93d8; background: #f3e5f5; }
      .vd-bar {
        display: flex; border-radius: 12px; overflow: hidden; margin: 16px 0;
      }
      .vd-bar-seg {
        flex: 1; padding: 14px 8px; text-align: center; font-size: 0.72rem; font-weight: 600; color: white;
      }
      @media (max-width: 560px) {
        .vd-flow { flex-direction: column; }
        .vd-arrow { transform: rotate(90deg); }
        .vd-grid { grid-template-columns: repeat(2, 1fr); }
      }
    </style>
</head>
<body>
    <nav class="global-nav"></nav>
    <script src="../shared/js/nav-github-actions.js"></script>

    <div class="container">
        <header class="chapter-header">
            <div class="chapter-badge"><span class="material-icons">menu_book</span> Chapter</div>
            <div class="chapter-number">6</div>
            <h1 class="chapter-title">環境変数とシークレット</h1>
            <p class="chapter-lead">ワークフロー内で設定値や機密情報を安全に管理する方法を学びます。環境変数のスコープ、シークレットの設定、GITHUB_TOKEN、そしてデプロイ環境（Environments）の活用法を習得しましょう。</p>
        </header>

        <!-- セクション1: 環境変数の基礎 -->
        <section class="section" id="env-basics">
            <h2><span class="material-icons">settings</span> 環境変数の基礎</h2>

            <p>GitHub Actionsでは <code>env</code> キーワードを使って環境変数を定義できます。環境変数はワークフロー内でデータを受け渡すための基本的な仕組みであり、設定値の一元管理に役立ちます。</p>

            <h3>env キーワードとスコープ</h3>
            <p>環境変数は3つのレベル（スコープ）で設定でき、それぞれ影響範囲が異なります。</p>

            <div class="visual-diagram">
                <div class="visual-diagram-title">環境変数のスコープ階層</div>
                <div class="vd-flow">
                    <div class="vd-box accent" style="min-width: 200px;">
                        <span class="vd-icon">&#x1F30D;</span>
                        <span class="vd-label">ワークフローレベル</span>
                        <span class="vd-sub">全ジョブ・全ステップで参照可</span>
                    </div>
                    <div class="vd-arrow">&#x2283;</div>
                    <div class="vd-box" style="min-width: 200px;">
                        <span class="vd-icon">&#x1F4E6;</span>
                        <span class="vd-label">ジョブレベル</span>
                        <span class="vd-sub">該当ジョブの全ステップで参照可</span>
                    </div>
                    <div class="vd-arrow">&#x2283;</div>
                    <div class="vd-box" style="min-width: 200px;">
                        <span class="vd-icon">&#x1F527;</span>
                        <span class="vd-label">ステップレベル</span>
                        <span class="vd-sub">該当ステップのみで参照可</span>
                    </div>
                </div>
            </div>

            <h3>各レベルでの環境変数の定義例</h3>
            <pre><code># ワークフローレベル: 全ジョブ・全ステップで使用可能
name: Environment Variables Demo
on: push

env:
  APP_NAME: my-application
  NODE_ENV: production

jobs:
  build:
    runs-on: ubuntu-latest
    # ジョブレベル: このジョブの全ステップで使用可能
    env:
      BUILD_DIR: ./dist
      CACHE_DIR: .cache

    steps:
      - uses: actions/checkout@v4

      # ステップレベル: このステップのみで使用可能
      - name: Build application
        env:
          API_URL: https://api.example.com
          DEBUG: "false"
        run: |
          echo "App: $APP_NAME"          # ワークフローレベル
          echo "Build dir: $BUILD_DIR"    # ジョブレベル
          echo "API URL: $API_URL"        # ステップレベル

      - name: Test application
        run: |
          echo "App: $APP_NAME"          # ワークフローレベル ✅
          echo "Build dir: $BUILD_DIR"    # ジョブレベル ✅
          echo "API URL: $API_URL"        # 参照不可（空） ❌</code></pre>

            <h3>環境変数の参照方法</h3>
            <p>環境変数は2つの方法で参照できます。</p>

            <table>
                <thead>
                    <tr><th>方法</th><th>構文</th><th>使用場所</th></tr>
                </thead>
                <tbody>
                    <tr><td>シェル構文</td><td><code>$ENV_NAME</code></td><td><code>run:</code> ブロック内</td></tr>
                    <tr><td>式構文</td><td><code>${{ env.ENV_NAME }}</code></td><td>YAMLの任意の場所</td></tr>
                </tbody>
            </table>

            <pre><code>steps:
  - name: シェル構文での参照
    env:
      GREETING: Hello
    run: echo "$GREETING, World!"

  - name: 式構文での参照
    env:
      GREETING: Hello
    run: echo "${{ env.GREETING }}, World!"

  - name: 条件分岐での利用（式構文が必要）
    if: env.NODE_ENV == 'production'
    run: echo "本番環境です"</code></pre>

            <h3>GITHUB_ENV を使った動的な環境変数設定</h3>
            <p>実行中のステップから後続のステップに環境変数を渡すには、<code>GITHUB_ENV</code> ファイルに書き込みます。</p>

            <pre><code>steps:
  - name: バージョンを動的に設定
    run: |
      VERSION=$(cat package.json | jq -r '.version')
      echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
      echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

  - name: 設定された変数を利用
    run: |
      echo "Version: $APP_VERSION"
      echo "Build Date: $BUILD_DATE"</code></pre>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習1: 環境変数のスコープ
                </div>
                <div class="exercise-body">
                    <p>以下のワークフローで、各ステップの <code>echo</code> 出力結果を予測してください。</p>
                    <pre><code>name: Scope Test
on: push
env:
  COLOR: blue

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      SIZE: large
    steps:
      - name: Step A
        env:
          SHAPE: circle
        run: |
          echo "1: $COLOR"
          echo "2: $SIZE"
          echo "3: $SHAPE"

      - name: Step B
        run: |
          echo "4: $COLOR"
          echo "5: $SIZE"
          echo "6: $SHAPE"</code></pre>
                    <p><strong>問題:</strong> 1〜6の出力はそれぞれ何になりますか？6で値が出力されない理由を説明してください。</p>
                </div>
            </div>
        </section>

        <!-- セクション2: デフォルト環境変数 -->
        <section class="section" id="default-env">
            <h2><span class="material-icons">info</span> デフォルト環境変数</h2>

            <p>GitHub Actionsは、ワークフロー実行時に多数の環境変数を自動的に設定します。これらを活用することで、リポジトリやコミットの情報を簡単に取得できます。</p>

            <div class="visual-diagram">
                <div class="visual-diagram-title">主要なデフォルト環境変数一覧</div>
                <div class="vd-grid">
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x1F4DD;</span>
                        <span class="vd-label">GITHUB_SHA</span>
                        <span class="vd-sub">トリガーとなったコミットSHA</span>
                    </div>
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x1F33F;</span>
                        <span class="vd-label">GITHUB_REF</span>
                        <span class="vd-sub">ブランチ/タグの参照パス</span>
                    </div>
                    <div class="vd-card green">
                        <span class="vd-icon">&#x1F4C1;</span>
                        <span class="vd-label">GITHUB_REPOSITORY</span>
                        <span class="vd-sub">owner/repo 形式</span>
                    </div>
                    <div class="vd-card green">
                        <span class="vd-icon">&#x1F464;</span>
                        <span class="vd-label">GITHUB_ACTOR</span>
                        <span class="vd-sub">ワークフロー起動ユーザー</span>
                    </div>
                    <div class="vd-card amber">
                        <span class="vd-icon">&#x1F4BB;</span>
                        <span class="vd-label">RUNNER_OS</span>
                        <span class="vd-sub">Linux / macOS / Windows</span>
                    </div>
                    <div class="vd-card amber">
                        <span class="vd-icon">&#x1F3C3;</span>
                        <span class="vd-label">GITHUB_RUN_ID</span>
                        <span class="vd-sub">実行ごとのユニークID</span>
                    </div>
                    <div class="vd-card purple">
                        <span class="vd-icon">&#x1F504;</span>
                        <span class="vd-label">GITHUB_RUN_NUMBER</span>
                        <span class="vd-sub">ワークフロー実行の連番</span>
                    </div>
                    <div class="vd-card purple">
                        <span class="vd-icon">&#x1F3E0;</span>
                        <span class="vd-label">GITHUB_WORKSPACE</span>
                        <span class="vd-sub">ワーキングディレクトリパス</span>
                    </div>
                </div>
            </div>

            <h3>デフォルト環境変数の活用例</h3>
            <pre><code>name: Default Variables Demo
on: push

jobs:
  info:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリ情報を表示
        run: |
          echo "リポジトリ: $GITHUB_REPOSITORY"
          echo "ブランチ: $GITHUB_REF_NAME"
          echo "コミットSHA: $GITHUB_SHA"
          echo "実行者: $GITHUB_ACTOR"
          echo "OS: $RUNNER_OS"
          echo "実行ID: $GITHUB_RUN_ID"
          echo "実行番号: $GITHUB_RUN_NUMBER"

      - name: コミットSHAをビルドタグに利用
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          echo "イメージタグ: myapp:$SHORT_SHA"
          echo "ビルド番号: build-$GITHUB_RUN_NUMBER"

      - name: ブランチに応じた処理分岐
        run: |
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "本番環境にデプロイします"
          elif [ "$GITHUB_REF_NAME" = "develop" ]; then
            echo "ステージング環境にデプロイします"
          else
            echo "テストのみ実行します"
          fi</code></pre>

            <h3>GITHUB_REF の形式</h3>
            <table>
                <thead>
                    <tr><th>トリガー</th><th>GITHUB_REF の値</th><th>GITHUB_REF_NAME</th></tr>
                </thead>
                <tbody>
                    <tr><td>ブランチへのpush</td><td><code>refs/heads/main</code></td><td><code>main</code></td></tr>
                    <tr><td>タグのpush</td><td><code>refs/tags/v1.0.0</code></td><td><code>v1.0.0</code></td></tr>
                    <tr><td>Pull Request</td><td><code>refs/pull/123/merge</code></td><td><code>123/merge</code></td></tr>
                </tbody>
            </table>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習2: デフォルト変数の活用
                </div>
                <div class="exercise-body">
                    <p>以下の要件を満たすワークフローを作成してください。</p>
                    <ol>
                        <li>pushイベントで起動する</li>
                        <li>最初のステップでリポジトリ名、コミットSHA（先頭7文字）、実行者名を表示する</li>
                        <li>2番目のステップで <code>GITHUB_REF_NAME</code> を使い、<code>main</code> ブランチの場合のみ「Production deploy ready」と表示する</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- セクション3: シークレットの管理 -->
        <section class="section" id="secrets">
            <h2><span class="material-icons">lock</span> シークレットの管理</h2>

            <p>APIキーやパスワードなどの機密情報は、環境変数に直接書くのではなく、<strong>シークレット</strong>として安全に管理します。シークレットは暗号化されて保存され、ワークフローのログにもマスクされます。</p>

            <h3>シークレットの種類</h3>

            <div class="visual-diagram">
                <div class="visual-diagram-title">シークレットの種類と適用範囲</div>
                <div class="vd-flow">
                    <div class="vd-box accent" style="min-width: 180px;">
                        <span class="vd-icon">&#x1F3E2;</span>
                        <span class="vd-label">Organization secrets</span>
                        <span class="vd-sub">組織内の全リポジトリ</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="min-width: 180px;">
                        <span class="vd-icon">&#x1F4C2;</span>
                        <span class="vd-label">Repository secrets</span>
                        <span class="vd-sub">1つのリポジトリ内</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="min-width: 180px; border-color: #4CAF50;">
                        <span class="vd-icon">&#x1F30D;</span>
                        <span class="vd-label">Environment secrets</span>
                        <span class="vd-sub">特定の環境のみ</span>
                    </div>
                </div>
            </div>

            <h3>リポジトリシークレットの設定方法</h3>
            <ol>
                <li>リポジトリの <strong>Settings</strong> タブを開く</li>
                <li>左メニューから <strong>Secrets and variables</strong> &gt; <strong>Actions</strong> を選択</li>
                <li><strong>New repository secret</strong> ボタンをクリック</li>
                <li>Name（例: <code>API_KEY</code>）と Value を入力</li>
                <li><strong>Add secret</strong> をクリック</li>
            </ol>

            <h3>シークレットの使用例</h3>
            <pre><code>name: Deploy with Secrets
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: APIにデプロイ
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          curl -X POST https://api.example.com/deploy \
            -H "Authorization: Bearer $API_KEY" \
            -H "X-Deploy-Token: $DEPLOY_TOKEN" \
            -d '{"version": "latest"}'

      - name: Docker Hub にログイン
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | \
            docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin</code></pre>

            <div class="tip">
                <span class="material-icons">warning</span>
                <strong>重要:</strong> シークレットの値はログに出力されると自動的に <code>***</code> にマスクされます。ただし、値を加工（Base64エンコードなど）して出力すると、マスクされない場合があるため注意が必要です。
            </div>

            <h3>シークレットの制約</h3>
            <table>
                <thead>
                    <tr><th>制約項目</th><th>上限</th></tr>
                </thead>
                <tbody>
                    <tr><td>リポジトリシークレット数</td><td>100個</td></tr>
                    <tr><td>組織シークレット数</td><td>1,000個</td></tr>
                    <tr><td>環境シークレット数</td><td>100個</td></tr>
                    <tr><td>シークレットの最大サイズ</td><td>48 KB</td></tr>
                </tbody>
            </table>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習3: シークレットの実践
                </div>
                <div class="exercise-body">
                    <p>以下の条件でワークフローを作成してください。</p>
                    <ol>
                        <li>リポジトリに <code>SLACK_WEBHOOK_URL</code> というシークレットを設定する想定</li>
                        <li>ワークフロー完了時にSlackに通知を送るステップを作成</li>
                        <li>通知にはリポジトリ名とコミットSHAを含める</li>
                    </ol>
                    <pre><code># ヒント: curl を使ったSlack通知
curl -X POST "$SLACK_WEBHOOK_URL" \
  -H "Content-Type: application/json" \
  -d '{"text": "メッセージ"}'</code></pre>
                </div>
            </div>
        </section>

        <!-- セクション4: GITHUB_TOKEN -->
        <section class="section" id="github-token">
            <h2><span class="material-icons">vpn_key</span> GITHUB_TOKEN</h2>

            <p><code>GITHUB_TOKEN</code> は、ワークフロー実行時にGitHubが自動的に生成する一時的なアクセストークンです。リポジトリに対するAPI操作（Issue作成、PRへのコメント、パッケージの公開など）に使用できます。</p>

            <h3>GITHUB_TOKEN の特徴</h3>
            <ul>
                <li>ワークフロー実行ごとに自動生成される</li>
                <li>実行完了後に自動的に失効する</li>
                <li>別途シークレットを設定する必要がない</li>
                <li><code>${{ secrets.GITHUB_TOKEN }}</code> または <code>${{ github.token }}</code> で参照</li>
            </ul>

            <h3>permissions キーワードによる権限制御</h3>
            <p>セキュリティのため、GITHUB_TOKEN の権限を必要最小限に設定することが推奨されています。</p>

            <pre><code>name: PR Comment
on:
  pull_request:
    types: [opened]

# ワークフローレベルで最小権限を設定
permissions:
  pull-requests: write
  contents: read

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: PRにコメントを投稿
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'レビューをお願いします！'
            })</code></pre>

            <h3>主要なパーミッション一覧</h3>

            <div class="visual-diagram">
                <div class="visual-diagram-title">GITHUB_TOKEN パーミッション設定</div>
                <div class="vd-grid">
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x1F4C4;</span>
                        <span class="vd-label">contents</span>
                        <span class="vd-sub">リポジトリの内容の読み書き</span>
                    </div>
                    <div class="vd-card green">
                        <span class="vd-icon">&#x1F500;</span>
                        <span class="vd-label">pull-requests</span>
                        <span class="vd-sub">PRの作成・コメント</span>
                    </div>
                    <div class="vd-card amber">
                        <span class="vd-icon">&#x1F6A8;</span>
                        <span class="vd-label">issues</span>
                        <span class="vd-sub">Issueの作成・編集</span>
                    </div>
                    <div class="vd-card purple">
                        <span class="vd-icon">&#x1F4E6;</span>
                        <span class="vd-label">packages</span>
                        <span class="vd-sub">パッケージの公開</span>
                    </div>
                    <div class="vd-card red">
                        <span class="vd-icon">&#x1F680;</span>
                        <span class="vd-label">deployments</span>
                        <span class="vd-sub">デプロイの作成・管理</span>
                    </div>
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x2705;</span>
                        <span class="vd-label">checks</span>
                        <span class="vd-sub">チェックランの作成</span>
                    </div>
                </div>
            </div>

            <pre><code># ジョブレベルでのパーミッション設定
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # リリース作成に必要
      packages: write    # パッケージ公開に必要
    steps:
      - uses: actions/checkout@v4

      - name: GitHub Releaseを作成
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v1.0.0 \
            --title "Release v1.0.0" \
            --notes "初回リリース"</code></pre>

            <div class="tip">
                <span class="material-icons">lightbulb</span>
                <strong>ベストプラクティス:</strong> ワークフローレベルで <code>permissions: {}</code>（空）を設定し、各ジョブで必要な権限のみを明示的に付与する方法が最も安全です。
            </div>
        </section>

        <!-- セクション5: Environments -->
        <section class="section" id="environments">
            <h2><span class="material-icons">cloud</span> Environments（デプロイ環境）</h2>

            <p>GitHub Actionsの <strong>Environments</strong> 機能を使うと、デプロイ先の環境（本番、ステージングなど）ごとにシークレットや保護ルールを設定できます。</p>

            <h3>Environment の設定方法</h3>
            <ol>
                <li>リポジトリの <strong>Settings</strong> &gt; <strong>Environments</strong> を開く</li>
                <li><strong>New environment</strong> をクリック</li>
                <li>環境名（例: <code>production</code>, <code>staging</code>）を入力</li>
                <li>保護ルールや環境固有のシークレットを設定</li>
            </ol>

            <div class="visual-diagram">
                <div class="visual-diagram-title">Environments の構成例</div>
                <div class="vd-flow">
                    <div class="vd-box" style="min-width: 160px; border-color: #66BB6A;">
                        <span class="vd-icon">&#x1F6E0;</span>
                        <span class="vd-label">development</span>
                        <span class="vd-sub">保護ルール: なし</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="min-width: 160px; border-color: #FFA726;">
                        <span class="vd-icon">&#x1F9EA;</span>
                        <span class="vd-label">staging</span>
                        <span class="vd-sub">保護ルール: ブランチ制限</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box accent" style="min-width: 160px;">
                        <span class="vd-icon">&#x1F680;</span>
                        <span class="vd-label">production</span>
                        <span class="vd-sub">保護ルール: 承認必須 + 待機</span>
                    </div>
                </div>
            </div>

            <h3>Environment をワークフローで使用する</h3>
            <pre><code>name: Deploy Pipeline
on:
  push:
    branches: [main]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.example.com
    steps:
      - uses: actions/checkout@v4
      - name: ステージングにデプロイ
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}  # staging環境のシークレット
        run: |
          echo "Deploying to staging..."
          ./deploy.sh staging

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://www.example.com
    steps:
      - uses: actions/checkout@v4
      - name: 本番にデプロイ
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}  # production環境のシークレット
        run: |
          echo "Deploying to production..."
          ./deploy.sh production</code></pre>

            <h3>保護ルールの種類</h3>
            <table>
                <thead>
                    <tr><th>保護ルール</th><th>説明</th><th>主な用途</th></tr>
                </thead>
                <tbody>
                    <tr><td>Required reviewers</td><td>指定した承認者の承認が必要</td><td>本番デプロイの承認フロー</td></tr>
                    <tr><td>Wait timer</td><td>指定時間の待機後にデプロイ</td><td>ロールバック猶予の確保</td></tr>
                    <tr><td>Deployment branches</td><td>特定ブランチのみデプロイ許可</td><td>mainブランチ限定デプロイ</td></tr>
                </tbody>
            </table>

            <h3>環境固有のシークレット</h3>
            <pre><code># 同じ secrets.DEPLOY_KEY でも環境ごとに異なる値
jobs:
  deploy-staging:
    environment: staging
    steps:
      - run: echo "Using staging key"
        env:
          KEY: ${{ secrets.DEPLOY_KEY }}  # staging 用の値

  deploy-production:
    environment: production
    steps:
      - run: echo "Using production key"
        env:
          KEY: ${{ secrets.DEPLOY_KEY }}  # production 用の値（異なる値）</code></pre>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習4: 環境の設計
                </div>
                <div class="exercise-body">
                    <p>以下の要件を満たすデプロイパイプラインを設計してください（YAMLを記述）。</p>
                    <ol>
                        <li><code>staging</code> と <code>production</code> の2つの環境を使用</li>
                        <li><code>staging</code> は <code>develop</code> ブランチへのpushで自動デプロイ</li>
                        <li><code>production</code> は <code>main</code> ブランチへのpushで、staging成功後にデプロイ</li>
                        <li>各環境固有の <code>API_URL</code> シークレットを使用</li>
                        <li><code>production</code> には承認者が必要（Environment設定で対応）</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- ページナビゲーション -->
        <nav class="chapter-nav">
            <a href="5actions-steps-actions.html" class="prev"><span class="material-icons">arrow_back</span> 前の章</a>
            <a href="index.html" class="home"><span class="material-icons">home</span> 目次</a>
            <a href="7actions-cache-artifacts.html" class="next">次の章 <span class="material-icons">arrow_forward</span></a>
        </nav>
    </div>

    <footer class="global-footer"></footer>
    <script src="../shared/footer.js"></script>
</body>
</html>