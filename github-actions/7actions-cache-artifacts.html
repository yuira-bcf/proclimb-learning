<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第7章 キャッシュとアーティファクト - GitHub Actions入門</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../shared/common.css">
    <style>
      :root {
        --primary: #2088FF;
        --primary-dark: #1A6FD6;
        --primary-light: #E8F1FF;
        --primary-lighter: #B3D4FF;
      }
      body { padding-top: 48px; }
      .nav-category-links { display: none; }
      .visual-diagram {
        margin: 28px 0; padding: 28px 20px;
        background: linear-gradient(135deg, #eef5ff 0%, #e8f1ff 100%);
        border-radius: 16px; border: 1px solid #b3d4ff;
      }
      .visual-diagram-title {
        text-align: center; font-size: 0.82rem; font-weight: 700;
        color: #2088FF; margin-bottom: 20px; letter-spacing: 0.05em;
      }
      .vd-flow {
        display: flex; align-items: center; justify-content: center;
        gap: 10px; flex-wrap: wrap;
      }
      .vd-box {
        background: white; border: 2px solid #2088FF; border-radius: 14px;
        padding: 16px 14px; text-align: center; min-width: 110px;
        box-shadow: 0 2px 8px rgba(32,136,255,0.08);
      }
      .vd-box.accent { background: #2088FF; color: white; }
      .vd-box .vd-icon { font-size: 1.6rem; display: block; margin-bottom: 4px; }
      .vd-box .vd-label { font-size: 0.78rem; font-weight: 700; display: block; }
      .vd-box .vd-sub { font-size: 0.68rem; opacity: 0.7; display: block; margin-top: 2px; }
      .vd-arrow { color: #2088FF; font-size: 1.3rem; font-weight: 700; }
      .vd-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
      .vd-card {
        background: white; border-radius: 12px; padding: 16px; text-align: center;
        border: 2px solid #e8f1ff; box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      }
      .vd-card .vd-icon { font-size: 1.8rem; display: block; margin-bottom: 6px; }
      .vd-card .vd-label { font-size: 0.78rem; font-weight: 700; display: block; color: #2088FF; }
      .vd-card .vd-sub { font-size: 0.68rem; color: #666; display: block; margin-top: 4px; }
      .vd-card.green { border-color: #a5d6a7; background: #f1f8e9; }
      .vd-card.red { border-color: #ef9a9a; background: #fce4ec; }
      .vd-card.blue { border-color: #90caf9; background: #e3f2fd; }
      .vd-card.amber { border-color: #ffe082; background: #fff8e1; }
      .vd-card.purple { border-color: #ce93d8; background: #f3e5f5; }
      .vd-bar {
        display: flex; border-radius: 12px; overflow: hidden; margin: 16px 0;
      }
      .vd-bar-seg {
        flex: 1; padding: 14px 8px; text-align: center; font-size: 0.72rem; font-weight: 600; color: white;
      }
      @media (max-width: 560px) {
        .vd-flow { flex-direction: column; }
        .vd-arrow { transform: rotate(90deg); }
        .vd-grid { grid-template-columns: repeat(2, 1fr); }
      }
    </style>
</head>
<body>
    <nav class="global-nav"></nav>
    <script src="../shared/js/nav-github-actions.js"></script>

    <div class="container">
        <header class="chapter-header">
            <div class="chapter-badge"><span class="material-icons">menu_book</span> Chapter</div>
            <div class="chapter-number">7</div>
            <h1 class="chapter-title">キャッシュとアーティファクト</h1>
            <p class="chapter-lead">ワークフローの実行速度を劇的に向上させるキャッシュ機能と、ジョブ間でデータを受け渡すアーティファクト機能を学びます。依存関係の再ダウンロードを防ぎ、ビルド成果物を効率的に管理しましょう。</p>
        </header>

        <!-- セクション1: キャッシュの概念 -->
        <section class="section" id="cache-concept">
            <h2><span class="material-icons">speed</span> キャッシュの概念</h2>

            <p>GitHub Actionsのランナーは毎回クリーンな仮想環境で起動するため、依存関係のインストールが毎回発生します。キャッシュを利用すると、以前のワークフロー実行でダウンロードしたファイルを再利用でき、<strong>ビルド時間を大幅に短縮</strong>できます。</p>

            <div class="visual-diagram">
                <div class="visual-diagram-title">キャッシュなし vs キャッシュあり のビルド時間比較</div>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div style="flex: 1; min-width: 200px;">
                        <p style="text-align: center; font-weight: 700; font-size: 0.8rem; color: #e53935; margin-bottom: 8px;">キャッシュなし</p>
                        <div class="vd-bar">
                            <div class="vd-bar-seg" style="background: #e53935; flex: 3;">Checkout<br>10秒</div>
                            <div class="vd-bar-seg" style="background: #c62828; flex: 8;">npm install<br>45秒</div>
                            <div class="vd-bar-seg" style="background: #b71c1c; flex: 4;">Build<br>20秒</div>
                        </div>
                        <p style="text-align: center; font-size: 0.75rem; font-weight: 700; color: #e53935;">合計: 約75秒</p>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <p style="text-align: center; font-weight: 700; font-size: 0.8rem; color: #43A047; margin-bottom: 8px;">キャッシュあり</p>
                        <div class="vd-bar">
                            <div class="vd-bar-seg" style="background: #43A047; flex: 3;">Checkout<br>10秒</div>
                            <div class="vd-bar-seg" style="background: #2E7D32; flex: 1;">Cache復元<br>3秒</div>
                            <div class="vd-bar-seg" style="background: #1B5E20; flex: 4;">Build<br>20秒</div>
                        </div>
                        <p style="text-align: center; font-size: 0.75rem; font-weight: 700; color: #43A047;">合計: 約33秒 (56%短縮!)</p>
                    </div>
                </div>
            </div>

            <h3>キャッシュの仕組み</h3>
            <ul>
                <li><strong>キャッシュキー</strong>: 一意のキー文字列でキャッシュを識別する</li>
                <li><strong>キャッシュヒット</strong>: キーが一致するキャッシュが見つかった状態</li>
                <li><strong>キャッシュミス</strong>: キーに一致するキャッシュがない状態（初回実行時など）</li>
                <li><strong>リストアキー</strong>: 完全一致しない場合の部分一致でフォールバック</li>
            </ul>

            <div class="visual-diagram">
                <div class="visual-diagram-title">キャッシュの動作フロー</div>
                <div class="vd-flow">
                    <div class="vd-box">
                        <span class="vd-icon">&#x1F50D;</span>
                        <span class="vd-label">キーで検索</span>
                        <span class="vd-sub">key + restore-keys</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="border-color: #4CAF50;">
                        <span class="vd-icon">&#x2705;</span>
                        <span class="vd-label">ヒット?</span>
                        <span class="vd-sub">キャッシュが見つかった</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box accent">
                        <span class="vd-icon">&#x1F4E5;</span>
                        <span class="vd-label">復元</span>
                        <span class="vd-sub">pathに展開</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="border-color: #FF9800;">
                        <span class="vd-icon">&#x1F3C3;</span>
                        <span class="vd-label">ジョブ実行</span>
                        <span class="vd-sub">キャッシュ利用で高速化</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box">
                        <span class="vd-icon">&#x1F4BE;</span>
                        <span class="vd-label">保存</span>
                        <span class="vd-sub">ミスの場合のみ保存</span>
                    </div>
                </div>
            </div>

            <h3>キャッシュの制限事項</h3>
            <table>
                <thead>
                    <tr><th>項目</th><th>制限値</th></tr>
                </thead>
                <tbody>
                    <tr><td>リポジトリあたりの合計キャッシュサイズ</td><td>10 GB</td></tr>
                    <tr><td>個別キャッシュエントリの最大サイズ</td><td>制限なし（合計に収まる範囲）</td></tr>
                    <tr><td>キャッシュの保持期間</td><td>7日間アクセスがないと自動削除</td></tr>
                    <tr><td>ブランチスコープ</td><td>同じブランチ + デフォルトブランチ</td></tr>
                </tbody>
            </table>
        </section>

        <!-- セクション2: actions/cache -->
        <section class="section" id="actions-cache">
            <h2><span class="material-icons">cached</span> actions/cache の使い方</h2>

            <p><code>actions/cache</code> はGitHub公式のキャッシュアクションで、依存関係やビルド成果物のキャッシュに最もよく使われます。</p>

            <h3>基本的な使い方</h3>
            <pre><code>- name: Cache node modules
  uses: actions/cache@v4
  with:
    # キャッシュするディレクトリ
    path: ~/.npm
    # キャッシュの識別キー
    key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
    # 完全一致しない場合のフォールバックキー
    restore-keys: |
      ${{ runner.os }}-npm-</code></pre>

            <h3>主要パラメータ</h3>
            <table>
                <thead>
                    <tr><th>パラメータ</th><th>必須</th><th>説明</th></tr>
                </thead>
                <tbody>
                    <tr><td><code>path</code></td><td>はい</td><td>キャッシュするファイル/ディレクトリのパス</td></tr>
                    <tr><td><code>key</code></td><td>はい</td><td>キャッシュを一意に識別するキー文字列</td></tr>
                    <tr><td><code>restore-keys</code></td><td>いいえ</td><td>部分一致で検索するフォールバックキーのリスト</td></tr>
                </tbody>
            </table>

            <h3>各言語のキャッシュ設定例</h3>

            <h4>Node.js（npm）</h4>
            <pre><code>- name: Cache npm dependencies
  uses: actions/cache@v4
  with:
    path: ~/.npm
    key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
    restore-keys: |
      ${{ runner.os }}-npm-

- run: npm ci</code></pre>

            <h4>Node.js（node_modules直接キャッシュ）</h4>
            <pre><code>- name: Cache node_modules
  id: cache-node-modules
  uses: actions/cache@v4
  with:
    path: node_modules
    key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

- name: Install dependencies
  if: steps.cache-node-modules.outputs.cache-hit != 'true'
  run: npm ci</code></pre>

            <h4>Python（pip）</h4>
            <pre><code>- name: Cache pip packages
  uses: actions/cache@v4
  with:
    path: ~/.cache/pip
    key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    restore-keys: |
      ${{ runner.os }}-pip-

- run: pip install -r requirements.txt</code></pre>

            <h4>Java（Maven）</h4>
            <pre><code>- name: Cache Maven packages
  uses: actions/cache@v4
  with:
    path: ~/.m2/repository
    key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
    restore-keys: |
      ${{ runner.os }}-maven-

- run: mvn install -DskipTests</code></pre>

            <h4>Java（Gradle）</h4>
            <pre><code>- name: Cache Gradle packages
  uses: actions/cache@v4
  with:
    path: |
      ~/.gradle/caches
      ~/.gradle/wrapper
    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
    restore-keys: |
      ${{ runner.os }}-gradle-

- run: ./gradlew build</code></pre>

            <div class="visual-diagram">
                <div class="visual-diagram-title">言語別キャッシュ対象ディレクトリ</div>
                <div class="vd-grid">
                    <div class="vd-card green">
                        <span class="vd-icon">&#x1F7E2;</span>
                        <span class="vd-label">Node.js</span>
                        <span class="vd-sub">~/.npm または node_modules</span>
                    </div>
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x1F40D;</span>
                        <span class="vd-label">Python</span>
                        <span class="vd-sub">~/.cache/pip</span>
                    </div>
                    <div class="vd-card red">
                        <span class="vd-icon">&#x2615;</span>
                        <span class="vd-label">Maven</span>
                        <span class="vd-sub">~/.m2/repository</span>
                    </div>
                    <div class="vd-card amber">
                        <span class="vd-icon">&#x1F418;</span>
                        <span class="vd-label">Gradle</span>
                        <span class="vd-sub">~/.gradle/caches</span>
                    </div>
                    <div class="vd-card purple">
                        <span class="vd-icon">&#x1F48E;</span>
                        <span class="vd-label">Ruby</span>
                        <span class="vd-sub">vendor/bundle</span>
                    </div>
                    <div class="vd-card blue">
                        <span class="vd-icon">&#x1F500;</span>
                        <span class="vd-label">Go</span>
                        <span class="vd-sub">~/go/pkg/mod</span>
                    </div>
                </div>
            </div>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習1: npm キャッシュの設定
                </div>
                <div class="exercise-body">
                    <p>以下の要件を満たすワークフローを作成してください。</p>
                    <ol>
                        <li><code>node_modules</code> ディレクトリを直接キャッシュする</li>
                        <li>キャッシュキーには OS と <code>package-lock.json</code> のハッシュを含める</li>
                        <li>キャッシュヒット時は <code>npm ci</code> をスキップする</li>
                        <li>キャッシュミス時のフォールバックキーを設定する</li>
                        <li>キャッシュ復元後にテストを実行する</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- セクション3: アーティファクトの概念 -->
        <section class="section" id="artifact-concept">
            <h2><span class="material-icons">inventory_2</span> アーティファクトの概念</h2>

            <p>アーティファクト（Artifacts）は、ワークフロー実行中に生成されたファイルを保存し、ダウンロードできるようにする機能です。キャッシュとは異なり、ビルド成果物やテストレポートなどの<strong>出力ファイル</strong>の保存に使います。</p>

            <h3>キャッシュとアーティファクトの違い</h3>

            <div class="visual-diagram">
                <div class="visual-diagram-title">キャッシュ vs アーティファクト 比較表</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="vd-card blue" style="text-align: left; padding: 20px;">
                        <span class="vd-icon" style="text-align: center;">&#x26A1;</span>
                        <span class="vd-label" style="text-align: center; font-size: 0.9rem; margin-bottom: 12px;">キャッシュ (Cache)</span>
                        <ul style="font-size: 0.75rem; color: #333; margin: 0; padding-left: 16px;">
                            <li>依存関係の再利用</li>
                            <li>同じワークフロー間で共有</li>
                            <li>7日間で自動削除</li>
                            <li>キーベースの検索</li>
                            <li>ダウンロード不可</li>
                        </ul>
                    </div>
                    <div class="vd-card green" style="text-align: left; padding: 20px;">
                        <span class="vd-icon" style="text-align: center;">&#x1F4E6;</span>
                        <span class="vd-label" style="text-align: center; font-size: 0.9rem; margin-bottom: 12px;">アーティファクト (Artifact)</span>
                        <ul style="font-size: 0.75rem; color: #333; margin: 0; padding-left: 16px;">
                            <li>ビルド成果物の保存</li>
                            <li>ジョブ間でデータ共有</li>
                            <li>最大90日間保持可能</li>
                            <li>名前で指定</li>
                            <li>UIからダウンロード可能</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h3>アーティファクトの主な用途</h3>
            <ul>
                <li><strong>ビルド成果物</strong>: コンパイル済みバイナリ、パッケージファイル</li>
                <li><strong>テストレポート</strong>: JUnit XML、HTMLレポート、スクリーンショット</li>
                <li><strong>ログファイル</strong>: デバッグ用のログ出力</li>
                <li><strong>カバレッジレポート</strong>: コードカバレッジのHTMLレポート</li>
                <li><strong>ジョブ間のデータ共有</strong>: ビルドジョブ → デプロイジョブ</li>
            </ul>

            <h3>アーティファクトの保持期間</h3>
            <table>
                <thead>
                    <tr><th>プラン</th><th>デフォルト保持期間</th><th>最大保持期間</th></tr>
                </thead>
                <tbody>
                    <tr><td>GitHub Free</td><td>90日</td><td>90日</td></tr>
                    <tr><td>GitHub Pro</td><td>90日</td><td>90日</td></tr>
                    <tr><td>GitHub Enterprise</td><td>90日</td><td>400日</td></tr>
                </tbody>
            </table>
        </section>

        <!-- セクション4: upload/download-artifact -->
        <section class="section" id="upload-download">
            <h2><span class="material-icons">cloud_upload</span> upload / download-artifact</h2>

            <p>アーティファクトのアップロードとダウンロードには、GitHub公式の <code>actions/upload-artifact</code> と <code>actions/download-artifact</code> を使用します。</p>

            <h3>アーティファクトのアップロード</h3>
            <pre><code>- name: Build project
  run: npm run build

- name: Upload build artifacts
  uses: actions/upload-artifact@v4
  with:
    name: build-output        # アーティファクト名
    path: dist/               # アップロードするパス
    retention-days: 30         # 保持日数（省略可）
    if-no-files-found: error   # ファイルがない場合の動作</code></pre>

            <h3>アーティファクトのダウンロード</h3>
            <pre><code>- name: Download build artifacts
  uses: actions/download-artifact@v4
  with:
    name: build-output         # ダウンロードするアーティファクト名
    path: ./downloaded-build   # 展開先パス</code></pre>

            <h3>ジョブ間でのデータ共有</h3>
            <p>アーティファクトを使って、ビルドジョブの成果物をデプロイジョブに渡す実践的な例を見てみましょう。</p>

            <pre><code>name: Build and Deploy
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and Build
        run: |
          npm ci
          npm run build

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: webapp-build
          path: dist/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build    # build ジョブの完了を待つ
    steps:
      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: webapp-build
          path: ./dist

      - name: Deploy to server
        run: |
          echo "Deploying files from ./dist"
          ls -la ./dist</code></pre>

            <h3>テストレポートの保存</h3>
            <pre><code>jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests with coverage
        run: |
          npm ci
          npm run test -- --coverage --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_DIR: ./reports

      - name: Upload test report
        if: always()    # テスト失敗時もアップロード
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            ./reports/
            ./coverage/

      - name: Upload coverage HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov-report/</code></pre>

            <div class="tip">
                <span class="material-icons">lightbulb</span>
                <strong>ポイント:</strong> <code>if: always()</code> を設定すると、前のステップが失敗してもアーティファクトがアップロードされます。テストレポートは失敗時こそ重要なので、必ず設定しましょう。
            </div>

            <div class="visual-diagram">
                <div class="visual-diagram-title">アーティファクトを使ったジョブ間連携フロー</div>
                <div class="vd-flow">
                    <div class="vd-box accent">
                        <span class="vd-icon">&#x1F3D7;</span>
                        <span class="vd-label">Build Job</span>
                        <span class="vd-sub">npm run build</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="border-color: #FF9800;">
                        <span class="vd-icon">&#x2B06;</span>
                        <span class="vd-label">Upload</span>
                        <span class="vd-sub">dist/ をアップロード</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box" style="border-color: #4CAF50;">
                        <span class="vd-icon">&#x2B07;</span>
                        <span class="vd-label">Download</span>
                        <span class="vd-sub">dist/ をダウンロード</span>
                    </div>
                    <div class="vd-arrow">&rarr;</div>
                    <div class="vd-box accent">
                        <span class="vd-icon">&#x1F680;</span>
                        <span class="vd-label">Deploy Job</span>
                        <span class="vd-sub">サーバーにデプロイ</span>
                    </div>
                </div>
            </div>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習2: テストレポートの保存
                </div>
                <div class="exercise-body">
                    <p>以下の要件を満たすワークフローを作成してください。</p>
                    <ol>
                        <li>テストを実行し、JUnit形式のレポートを <code>./test-results/</code> に出力する</li>
                        <li>テスト結果（成功/失敗問わず）をアーティファクトとしてアップロードする</li>
                        <li>カバレッジレポートも別のアーティファクト名でアップロードする</li>
                        <li>アーティファクトの保持期間を14日間に設定する</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- セクション5: 実践：キャッシュ戦略 -->
        <section class="section" id="cache-strategy">
            <h2><span class="material-icons">tune</span> 実践: キャッシュ戦略</h2>

            <p>キャッシュの効果を最大限に引き出すには、適切なキー設計とキャッシュ対象の選定が重要です。ここでは、実践的なキャッシュ戦略を解説します。</p>

            <h3>ハッシュキー設計のベストプラクティス</h3>

            <pre><code># 悪い例: 固定キー（ロックファイル変更時にも古いキャッシュを使い続ける）
key: my-cache

# 良い例: OS + ロックファイルのハッシュ
key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

# より良い例: 段階的フォールバック
key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
restore-keys: |
  ${{ runner.os }}-npm-</code></pre>

            <h3>複数のキャッシュを組み合わせる</h3>
            <pre><code>name: Optimized Build
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # キャッシュ1: npm依存関係
      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      # キャッシュ2: Next.jsビルドキャッシュ
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - run: npm ci
      - run: npm run build</code></pre>

            <h3>setup-* アクションの組み込みキャッシュ</h3>
            <p>多くの <code>setup-*</code> アクションにはキャッシュ機能が組み込まれており、<code>actions/cache</code> を個別に設定する必要がありません。</p>

            <pre><code># Node.js の組み込みキャッシュ
- uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'    # npm, yarn, pnpm を指定可能

# Python の組み込みキャッシュ
- uses: actions/setup-python@v5
  with:
    python-version: '3.12'
    cache: 'pip'    # pip, pipenv, poetry を指定可能

# Java の組み込みキャッシュ
- uses: actions/setup-java@v4
  with:
    distribution: 'temurin'
    java-version: '17'
    cache: 'maven'  # maven, gradle, sbt を指定可能</code></pre>

            <h3>キャッシュヒット率の確認とモニタリング</h3>
            <pre><code>- name: Cache dependencies
  id: cache-deps
  uses: actions/cache@v4
  with:
    path: node_modules
    key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

- name: Check cache status
  run: |
    if [ "${{ steps.cache-deps.outputs.cache-hit }}" = "true" ]; then
      echo "✅ キャッシュヒット! インストールをスキップします"
    else
      echo "❌ キャッシュミス: 依存関係をインストールします"
      npm ci
    fi</code></pre>

            <div class="visual-diagram">
                <div class="visual-diagram-title">キャッシュキー設計のフォールバック戦略</div>
                <div class="vd-flow">
                    <div class="vd-box accent" style="min-width: 240px;">
                        <span class="vd-icon">&#x1F3AF;</span>
                        <span class="vd-label">完全一致キー</span>
                        <span class="vd-sub">Linux-npm-abc123def</span>
                    </div>
                    <div class="vd-arrow">miss &rarr;</div>
                    <div class="vd-box" style="min-width: 200px; border-color: #FF9800;">
                        <span class="vd-icon">&#x1F50D;</span>
                        <span class="vd-label">フォールバック1</span>
                        <span class="vd-sub">Linux-npm-</span>
                    </div>
                    <div class="vd-arrow">miss &rarr;</div>
                    <div class="vd-box" style="min-width: 160px; border-color: #e53935;">
                        <span class="vd-icon">&#x274C;</span>
                        <span class="vd-label">キャッシュなし</span>
                        <span class="vd-sub">フルインストール実行</span>
                    </div>
                </div>
            </div>

            <h3>完全なキャッシュ最適化ワークフロー</h3>
            <pre><code>name: Optimized CI Pipeline
on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/package-lock.json') }}

      - name: Run unit tests
        run: npm test

      - name: Run E2E tests
        run: npx cypress run

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots/
          retention-days: 7</code></pre>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習3: キャッシュ戦略の設計
                </div>
                <div class="exercise-body">
                    <p>以下のプロジェクト構成に対して、最適なキャッシュ戦略を設計してください。</p>
                    <ul>
                        <li>フロントエンド: React（npm）</li>
                        <li>バックエンド: Python Flask（pip）</li>
                        <li>E2Eテスト: Cypress</li>
                    </ul>
                    <p><strong>要件:</strong></p>
                    <ol>
                        <li>npm、pip、Cypressバイナリの3つのキャッシュを設定する</li>
                        <li>各キャッシュに適切なキーとフォールバックキーを設計する</li>
                        <li>キャッシュヒット状況をログに出力する</li>
                        <li>テスト失敗時のスクリーンショットをアーティファクトとして保存する</li>
                    </ol>
                </div>
            </div>

            <div class="exercise">
                <div class="exercise-header">
                    <span class="material-icons">fitness_center</span> 演習4: ビルドパイプラインの構築
                </div>
                <div class="exercise-body">
                    <p>キャッシュとアーティファクトを組み合わせた2ジョブのワークフローを作成してください。</p>
                    <ol>
                        <li><strong>buildジョブ</strong>: 依存関係をキャッシュし、ビルドを実行。成果物をアーティファクトとしてアップロード</li>
                        <li><strong>testジョブ</strong>: buildジョブのアーティファクトをダウンロードし、テストを実行。結果をアーティファクトとして保存</li>
                        <li>testジョブはbuildジョブの完了後に実行される</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- ページナビゲーション -->
        <nav class="chapter-nav">
            <a href="6actions-env-secrets.html" class="prev"><span class="material-icons">arrow_back</span> 前の章</a>
            <a href="index.html" class="home"><span class="material-icons">home</span> 目次</a>
            <a href="8actions-ci-testing.html" class="next">次の章 <span class="material-icons">arrow_forward</span></a>
        </nav>
    </div>

    <footer class="global-footer"></footer>
    <script src="../shared/footer.js"></script>
</body>
</html>