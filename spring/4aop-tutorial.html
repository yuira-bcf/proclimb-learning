<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>第4章 Spring Frameworkのコア機能（AOP）を知ろう</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="../shared/common.css" />
        <style>
            :root {
                --primary: #34C759;
                --primary-dark: #2AA648;
                --primary-light: #f0fdf4;
                --primary-lighter: #BBF7D0;
            }
            .nav-category-links { display: none; }
        </style>
    </head>
    <body>
        <!-- グローバルナビゲーション -->
        <nav class="global-nav"></nav>
        <script src="../shared/js/nav-spring.js"></script>

        <div class="container">
            <!-- ヘッダー -->
            <header class="chapter-header">
                <div class="chapter-badge">📘 Chapter</div>
                <div class="chapter-number">4</div>
                <h1 class="chapter-title">Spring Frameworkのコア機能（AOP）を知ろう</h1>
            </header>

            <!-- 目次 -->
            <nav class="toc">
                <h2 class="toc-title">📑 この章で学ぶこと</h2>
                <ul class="toc-list">
                    <li class="toc-item">
                        <span class="toc-number">4-1</span>
                        <span>AOP（アスペクト指向プログラミング）の基礎を知ろう</span>
                    </li>
                    <li class="toc-item">
                        <span class="toc-number">4-2</span>
                        <span>AOPのプログラムを作成しよう</span>
                    </li>
                    <li class="toc-item">
                        <span class="toc-number">4-3</span>
                        <span>Spring Frameworkが提供するAOP機能を理解しよう</span>
                    </li>
                </ul>
            </nav>

            <!-- セクション 4-1 -->
            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 4-1</span>
                    <h2 class="section-title">AOP（アスペクト指向プログラミング）の基礎を知ろう</h2>
                </div>

                <div class="intro-text">
                    <p>
                        「3-1 Spring Frameworkのコア機能の概要」で「Aspect Oriented
                        Programming：アスペクト指向プログラミング」略して「AOP」について簡単に説明しました。ここではAOPについて、もう少し詳しくデータベースへのアクセス処理プログラムを例に説明します。
                    </p>
                </div>

                <h3>AOPは実際どんな場面で使われる？</h3>
                <p>
                    AOPの概念を学ぶ前に、まず「実際の開発現場ではどのような場面でAOPが使われるのか」を知っておきましょう。これを理解しておくことで、AOPの必要性がより明確になります。
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ユースケース</th>
                                <th>説明</th>
                                <th>具体例</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>トランザクション管理</strong></td>
                                <td>データベース操作の一貫性を保証する処理。複数の処理をまとめて成功または失敗させる</td>
                                <td>銀行の振込処理（引き落としと入金を両方成功させる）</td>
                            </tr>
                            <tr>
                                <td><strong>例外処理</strong></td>
                                <td>エラー発生時の共通的なハンドリング処理</td>
                                <td>全てのController/Serviceで発生する例外を一箇所でキャッチしてログ出力</td>
                            </tr>
                            <tr>
                                <td><strong>ロギング</strong></td>
                                <td>メソッドの実行状況や引数・戻り値を記録する処理</td>
                                <td>どのメソッドがいつ呼ばれたかを自動的にログファイルに記録</td>
                            </tr>
                            <tr>
                                <td><strong>セキュリティ</strong></td>
                                <td>認証・認可のチェック処理</td>
                                <td>管理者権限が必要なメソッドの実行前に権限チェックを自動実行</td>
                            </tr>
                            <tr>
                                <td><strong>パフォーマンス計測</strong></td>
                                <td>処理時間の計測やボトルネックの特定</td>
                                <td>各メソッドの実行時間を自動計測して遅い処理を発見</td>
                            </tr>
                            <tr>
                                <td><strong>キャッシュ処理</strong></td>
                                <td>データベースアクセスを減らすためのキャッシュ制御</td>
                                <td>同じ検索条件での2回目以降はキャッシュから結果を返す</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="point-box">
                    <div class="point-box-title">💡 なぜAOPが必要なのか？</div>
                    <p style="margin: 0;">
                        上記の処理は、アプリケーション内の<strong>多くのクラス・メソッドで共通して必要</strong>になります。もしAOPを使わなければ、すべてのメソッドに同じコードをコピー＆ペーストする必要があり、保守が困難になります。AOPを使えば、これらの共通処理を<strong>一箇所で定義</strong>し、必要な場所に<strong>自動的に適用</strong>できます。
                    </p>
                </div>

                <p>
                    Spring Frameworkでは、これらの機能の多くが最初からAOPとして組み込まれており、<code>@Transactional</code>や<code>@Secured</code>などのアノテーションを付けるだけで利用できます。次のセクションから、AOPの仕組みを具体的に見ていきましょう。
                </p>

                <h3>AOPの例（データベースアクセス）</h3>
                <p>
                    データベースアクセス処理には例外発生時の対応処理を必ず含める必要があります。例外処理を記述しないと、プログラムが停止しますし、Javaの場合は例外処理をプログラムに含めないとコンパイルもできません。
                </p>

                <!-- データベースアクセス図 -->
                <div class="diagram-container">
                    <div class="diagram-title">図4.1 データベースへのアクセス処理</div>
                    <svg class="diagram-svg" viewBox="0 0 600 200" width="600" height="200">
                        <!-- 正常パターン -->
                        <g transform="translate(0, 20)">
                            <rect x="40" y="20" width="100" height="50" rx="8" fill="var(--primary)" />
                            <text x="90" y="50" text-anchor="middle" fill="white" font-size="14" font-weight="bold">
                                プログラム
                            </text>

                            <line
                                x1="140"
                                y1="45"
                                x2="200"
                                y2="45"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrowhead)"
                            />
                            <text x="170" y="35" text-anchor="middle" fill="var(--text-muted)" font-size="11">
                                問い合わせ
                            </text>

                            <!-- データベース -->
                            <ellipse
                                cx="260"
                                cy="45"
                                rx="40"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="260"
                                y="50"
                                text-anchor="middle"
                                fill="var(--primary-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                データベース
                            </text>

                            <line x1="260" y1="70" x2="260" y2="90" stroke="var(--primary)" stroke-width="2" />
                            <text x="300" y="85" text-anchor="start" fill="var(--text-muted)" font-size="11">
                                問い合わせ結果の取得
                            </text>
                        </g>

                        <!-- 例外パターン -->
                        <g transform="translate(0, 110)">
                            <rect x="40" y="20" width="100" height="50" rx="8" fill="var(--primary)" />
                            <text x="90" y="50" text-anchor="middle" fill="white" font-size="14" font-weight="bold">
                                プログラム
                            </text>

                            <line
                                x1="140"
                                y1="45"
                                x2="200"
                                y2="45"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrowhead)"
                            />
                            <text x="170" y="35" text-anchor="middle" fill="var(--text-muted)" font-size="11">
                                問い合わせ
                            </text>

                            <!-- データベース（エラー） -->
                            <ellipse
                                cx="260"
                                cy="45"
                                rx="40"
                                ry="25"
                                fill="#fee2e2"
                                stroke="#ef4444"
                                stroke-width="2"
                            />
                            <text x="260" y="42" text-anchor="middle" fill="#dc2626" font-size="12" font-weight="bold">
                                データベース
                            </text>
                            <text x="260" y="56" text-anchor="middle" fill="#dc2626" font-size="10">例外</text>

                            <!-- 問題発生 -->
                            <rect x="320" y="30" width="80" height="30" rx="4" fill="#ef4444" />
                            <text x="360" y="50" text-anchor="middle" fill="white" font-size="11" font-weight="bold">
                                問題発生
                            </text>
                        </g>

                        <!-- 矢印マーカー -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary)" />
                            </marker>
                        </defs>
                    </svg>
                </div>

                <p>
                    多数のデータベースアクセス処理を作成すると、例外処理の内容はいつも同じですが、例外処理は必要なため常に作成しなければなりません。例外処理を含めるとプログラムコードは増え、複雑になってしまいます。「実現したいプログラム」は「データベースへのアクセス処理」であり、「例外処理」は「実現したいプログラムに付随する」プログラムになります。
                </p>
                <p>
                    「実現したいプログラム＝<strong>中心的関心事</strong>」、「付随するプログラム＝<strong>横断的関心事</strong>」を分離してプログラムを作成できないでしょうか。
                </p>

                <!-- 中心的関心事と横断的関心事の図 -->
                <div class="diagram-container">
                    <div class="diagram-title">
                        図4.2 データベースへのアクセス処理での「中心的関心事」と「横断的関心事」
                    </div>
                    <svg class="diagram-svg" viewBox="0 0 700 320" width="700" height="320">
                        <!-- 凡例 -->
                        <g transform="translate(20, 10)">
                            <rect x="0" y="0" width="120" height="24" rx="4" fill="var(--primary-light)" />
                            <text x="60" y="16" text-anchor="middle" fill="var(--primary)" font-size="11">
                                アクセス処理 ＝ 中心的関心事
                            </text>
                        </g>
                        <g transform="translate(160, 10)">
                            <rect x="0" y="0" width="120" height="24" rx="4" fill="#ffedd5" />
                            <text x="60" y="16" text-anchor="middle" fill="var(--accent)" font-size="11">
                                例外処理 ＝ 横断的関心事
                            </text>
                        </g>

                        <!-- 左側：データベースアクセスクラス群 -->
                        <g transform="translate(30, 60)">
                            <text
                                x="100"
                                y="0"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="13"
                                font-weight="bold"
                            >
                                データベースアクセスクラス
                            </text>

                            <!-- メソッドA -->
                            <rect
                                x="20"
                                y="20"
                                width="160"
                                height="70"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="100"
                                y="40"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                メソッドA()
                            </text>
                            <rect x="30" y="50" width="140" height="16" rx="4" fill="var(--primary-light)" />
                            <text x="100" y="62" text-anchor="middle" fill="var(--primary)" font-size="10">
                                アクセス処理
                            </text>
                            <rect x="30" y="70" width="140" height="16" rx="4" fill="#ffedd5" />
                            <text x="100" y="82" text-anchor="middle" fill="var(--accent)" font-size="10">
                                例外処理
                            </text>

                            <!-- メソッドB -->
                            <rect
                                x="20"
                                y="100"
                                width="160"
                                height="70"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="100"
                                y="120"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                メソッドB()
                            </text>
                            <rect x="30" y="130" width="140" height="16" rx="4" fill="var(--primary-light)" />
                            <text x="100" y="142" text-anchor="middle" fill="var(--primary)" font-size="10">
                                アクセス処理
                            </text>
                            <rect x="30" y="150" width="140" height="16" rx="4" fill="#ffedd5" />
                            <text x="100" y="162" text-anchor="middle" fill="var(--accent)" font-size="10">
                                例外処理
                            </text>
                        </g>

                        <!-- 中央：データベース -->
                        <g transform="translate(280, 100)">
                            <!-- 矢印（左から） -->
                            <line
                                x1="0"
                                y1="30"
                                x2="50"
                                y2="30"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrow2)"
                            />
                            <line
                                x1="0"
                                y1="100"
                                x2="50"
                                y2="100"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrow2)"
                            />

                            <!-- データベース -->
                            <ellipse
                                cx="100"
                                cy="65"
                                rx="45"
                                ry="50"
                                fill="#e0f2fe"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="100"
                                y="70"
                                text-anchor="middle"
                                fill="var(--primary-dark)"
                                font-size="13"
                                font-weight="bold"
                            >
                                データベース
                            </text>

                            <!-- 矢印（右へ） -->
                            <line
                                x1="150"
                                y1="30"
                                x2="200"
                                y2="30"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrow2)"
                            />
                            <line
                                x1="150"
                                y1="100"
                                x2="200"
                                y2="100"
                                stroke="var(--primary)"
                                stroke-width="2"
                                marker-end="url(#arrow2)"
                            />
                        </g>

                        <!-- 右側：データベースアクセスクラス群 -->
                        <g transform="translate(480, 60)">
                            <text
                                x="100"
                                y="0"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="13"
                                font-weight="bold"
                            >
                                データベースアクセスクラス
                            </text>

                            <!-- メソッドC -->
                            <rect
                                x="20"
                                y="20"
                                width="160"
                                height="70"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="100"
                                y="40"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                メソッドC()
                            </text>
                            <rect x="30" y="50" width="140" height="16" rx="4" fill="var(--primary-light)" />
                            <text x="100" y="62" text-anchor="middle" fill="var(--primary)" font-size="10">
                                アクセス処理
                            </text>
                            <rect x="30" y="70" width="140" height="16" rx="4" fill="#ffedd5" />
                            <text x="100" y="82" text-anchor="middle" fill="var(--accent)" font-size="10">
                                例外処理
                            </text>

                            <!-- メソッドD -->
                            <rect
                                x="20"
                                y="100"
                                width="160"
                                height="70"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="100"
                                y="120"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                メソッドD()
                            </text>
                            <rect x="30" y="130" width="140" height="16" rx="4" fill="var(--primary-light)" />
                            <text x="100" y="142" text-anchor="middle" fill="var(--primary)" font-size="10">
                                アクセス処理
                            </text>
                            <rect x="30" y="150" width="140" height="16" rx="4" fill="#ffedd5" />
                            <text x="100" y="162" text-anchor="middle" fill="var(--accent)" font-size="10">
                                例外処理
                            </text>
                        </g>

                        <defs>
                            <marker id="arrow2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary)" />
                            </marker>
                        </defs>
                    </svg>
                </div>

                <h3>AOP固有用語</h3>
                <p>
                    Spring
                    Frameworkが提供しているAOP機能を利用することで「中心的関心事」と「横断的関心事」を分離してプログラムを簡単に作成できます。具体的な使用方法の説明に入る前にAOPの固有用語について説明します。
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>用語</th>
                                <th>内容</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Advice</strong><br />「アドバイス」</td>
                                <td>
                                    特定のタイミング（例えば、メソッドが呼び出される前や後）で実行されるコードです。つまり「横断的関心事」を具体的にコードで表現したもの（メソッド）です。
                                </td>
                            </tr>
                            <tr>
                                <td><strong>JoinPoint</strong><br />「ジョインポイント」</td>
                                <td>アドバイスが実行される具体的な場所です。</td>
                            </tr>
                            <tr>
                                <td><strong>Pointcut</strong><br />「ポイントカット」</td>
                                <td>
                                    どのジョインポイント（場所）でアドバイス（コード）が実行されるかを指定するための表現やパターン、つまりは条件です。
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Aspect</strong><br />「アスペクト」</td>
                                <td>
                                    アドバイス（何をするか）とポイントカット（いつ実行するか）を組み合わせたもの（クラス）です。つまり「横断的関心事」を「どのように」かつ「どこで」実行するかを定義したものです。
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Interceptor</strong><br />「インターセプタ」</td>
                                <td>
                                    インターセプタは、特定の操作（通常はメソッド呼び出し）を「捕捉」して、その前後で何らかの処理を行うオブジェクトです。
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Target</strong><br />「ターゲット」</td>
                                <td>ターゲットは、アスペクトが適用される対象です。</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- AOP用語のイメージ図 -->
                <div class="diagram-container">
                    <div class="diagram-title">図4.3 AOP固有用語のイメージ</div>
                    <svg class="diagram-svg" viewBox="0 0 650 280" width="650" height="280">
                        <!-- Aspect（クラス） -->
                        <g transform="translate(20, 40)">
                            <rect
                                x="0"
                                y="0"
                                width="150"
                                height="200"
                                rx="12"
                                fill="var(--primary-light)"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="75"
                                y="-10"
                                text-anchor="middle"
                                fill="var(--primary)"
                                font-size="13"
                                font-weight="bold"
                            >
                                アスペクト（クラス）
                            </text>

                            <!-- Advice（メソッド） -->
                            <rect
                                x="15"
                                y="30"
                                width="120"
                                height="50"
                                rx="8"
                                fill="var(--success)"
                                stroke="#16a34a"
                                stroke-width="2"
                            />
                            <text x="75" y="50" text-anchor="middle" fill="white" font-size="11" font-weight="bold">
                                アドバイス
                            </text>
                            <text x="75" y="68" text-anchor="middle" fill="white" font-size="10">（メソッド）</text>
                        </g>

                        <!-- ターゲット -->
                        <g transform="translate(420, 20)">
                            <text x="100" y="0" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">
                                ターゲット
                            </text>

                            <!-- メソッド群 -->
                            <rect
                                x="30"
                                y="20"
                                width="140"
                                height="40"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text x="100" y="45" text-anchor="middle" fill="var(--text-dark)" font-size="12">
                                Aメソッド
                            </text>

                            <rect
                                x="30"
                                y="70"
                                width="140"
                                height="40"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text x="100" y="95" text-anchor="middle" fill="var(--text-dark)" font-size="12">
                                Bメソッド
                            </text>

                            <rect
                                x="30"
                                y="120"
                                width="140"
                                height="40"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text x="100" y="145" text-anchor="middle" fill="var(--text-dark)" font-size="12">
                                Cメソッド
                            </text>
                        </g>

                        <!-- ジョインポイント説明 -->
                        <g transform="translate(210, 30)">
                            <rect
                                x="0"
                                y="0"
                                width="180"
                                height="70"
                                rx="8"
                                fill="#fef3c7"
                                stroke="var(--warning)"
                                stroke-width="2"
                            />
                            <text x="90" y="20" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">
                                ジョインポイント
                            </text>
                            <text x="90" y="38" text-anchor="middle" fill="#78350f" font-size="10">
                                メソッドの実行前にアドバイスを
                            </text>
                            <text x="90" y="52" text-anchor="middle" fill="#78350f" font-size="10">
                                実行するなどの挿入タイミング
                            </text>
                        </g>

                        <!-- ポイントカット説明 -->
                        <g transform="translate(210, 130)">
                            <rect
                                x="0"
                                y="0"
                                width="180"
                                height="60"
                                rx="8"
                                fill="#dbeafe"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="90"
                                y="20"
                                text-anchor="middle"
                                fill="var(--primary-dark)"
                                font-size="11"
                                font-weight="bold"
                            >
                                ポイントカット
                            </text>
                            <text x="90" y="40" text-anchor="middle" fill="var(--primary-dark)" font-size="10">
                                アドバイスを挿入する条件
                            </text>
                        </g>

                        <!-- 矢印 -->
                        <line
                            x1="170"
                            y1="100"
                            x2="210"
                            y2="65"
                            stroke="var(--warning)"
                            stroke-width="2"
                            stroke-dasharray="5,3"
                        />
                        <line
                            x1="170"
                            y1="100"
                            x2="210"
                            y2="160"
                            stroke="var(--primary)"
                            stroke-width="2"
                            stroke-dasharray="5,3"
                        />
                        <line
                            x1="390"
                            y1="100"
                            x2="420"
                            y2="60"
                            stroke="var(--text-muted)"
                            stroke-width="2"
                            marker-end="url(#arrow3)"
                        />
                        <line
                            x1="390"
                            y1="100"
                            x2="420"
                            y2="110"
                            stroke="var(--text-muted)"
                            stroke-width="2"
                            marker-end="url(#arrow3)"
                        />
                        <line
                            x1="390"
                            y1="100"
                            x2="420"
                            y2="160"
                            stroke="var(--text-muted)"
                            stroke-width="2"
                            marker-end="url(#arrow3)"
                        />

                        <defs>
                            <marker id="arrow3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="var(--text-muted)" />
                            </marker>
                        </defs>
                    </svg>
                </div>

                <p>
                    Spring
                    Frameworkでは「インターセプタ」という仕組みを使って横断的関心事（Advice）を中心的関心事（Target）に挿入しているように見せることができます。
                </p>

                <!-- 呼び出しイメージ図 -->
                <div class="diagram-container">
                    <div class="diagram-title">図4.4 「中心的関心事」と「横断的関心事」の分離</div>
                    <svg class="diagram-svg" viewBox="0 0 650 360" width="650" height="360">
                        <!-- Before: 分離前 -->
                        <g transform="translate(20, 30)">
                            <text
                                x="250"
                                y="0"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="14"
                                font-weight="bold"
                            >
                                ▼ 分離前
                            </text>

                            <!-- クラスA -->
                            <rect
                                x="0"
                                y="20"
                                width="100"
                                height="50"
                                rx="8"
                                fill="var(--primary-light)"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="50"
                                y="35"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                クラスA
                            </text>
                            <text x="50" y="55" text-anchor="middle" fill="var(--text-muted)" font-size="10">
                                メソッドX呼び出し
                            </text>

                            <!-- 矢印 -->
                            <line
                                x1="100"
                                y1="45"
                                x2="160"
                                y2="45"
                                stroke="var(--text-muted)"
                                stroke-width="2"
                                stroke-dasharray="5,3"
                            />

                            <!-- クラスB -->
                            <rect
                                x="160"
                                y="20"
                                width="160"
                                height="100"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="240"
                                y="40"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                クラスB
                            </text>
                            <rect x="170" y="50" width="140" height="30" rx="6" fill="var(--primary-light)" />
                            <text x="240" y="70" text-anchor="middle" fill="var(--primary)" font-size="11">
                                メソッドX
                            </text>
                            <rect x="190" y="85" width="100" height="20" rx="4" fill="#e0f2fe" />
                            <text x="240" y="100" text-anchor="middle" fill="var(--primary-dark)" font-size="10">
                                中心的関心事
                            </text>
                            <rect x="190" y="107" width="100" height="20" rx="4" fill="#ffedd5" />
                            <text x="240" y="122" text-anchor="middle" fill="var(--accent)" font-size="10">
                                横断的関心事
                            </text>
                        </g>

                        <!-- 矢印：下向き -->
                        <g transform="translate(300, 165)">
                            <polygon points="0,0 20,0 10,30" fill="var(--primary)" />
                        </g>

                        <!-- After: 分離後 -->
                        <g transform="translate(20, 200)">
                            <text
                                x="300"
                                y="0"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="14"
                                font-weight="bold"
                            >
                                ▼ 分離後
                            </text>

                            <!-- クラスA -->
                            <rect
                                x="0"
                                y="20"
                                width="100"
                                height="50"
                                rx="8"
                                fill="var(--primary-light)"
                                stroke="var(--primary)"
                                stroke-width="2"
                            />
                            <text
                                x="50"
                                y="35"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                クラスA
                            </text>
                            <text x="50" y="55" text-anchor="middle" fill="var(--text-muted)" font-size="10">
                                メソッドX呼び出し
                            </text>

                            <!-- 矢印 -->
                            <line
                                x1="100"
                                y1="45"
                                x2="160"
                                y2="45"
                                stroke="var(--text-muted)"
                                stroke-width="2"
                                stroke-dasharray="5,3"
                            />

                            <!-- クラスB（中心的関心事のみ） -->
                            <rect
                                x="160"
                                y="20"
                                width="140"
                                height="70"
                                rx="8"
                                fill="white"
                                stroke="var(--border-light)"
                                stroke-width="2"
                            />
                            <text
                                x="230"
                                y="40"
                                text-anchor="middle"
                                fill="var(--text-dark)"
                                font-size="12"
                                font-weight="bold"
                            >
                                クラスB
                            </text>
                            <rect x="170" y="50" width="120" height="30" rx="6" fill="var(--primary-light)" />
                            <text x="230" y="70" text-anchor="middle" fill="var(--primary)" font-size="11">
                                メソッドX
                            </text>
                            <text x="230" y="100" text-anchor="middle" fill="var(--primary-dark)" font-size="10">
                                中心的関心事
                            </text>

                            <!-- Aspect -->
                            <rect
                                x="400"
                                y="10"
                                width="140"
                                height="100"
                                rx="8"
                                fill="#dcfce7"
                                stroke="var(--success)"
                                stroke-width="2"
                            />
                            <text x="470" y="30" text-anchor="middle" fill="#166534" font-size="12" font-weight="bold">
                                Aspect
                            </text>
                            <rect x="410" y="40" width="120" height="30" rx="6" fill="var(--success)" />
                            <text x="470" y="60" text-anchor="middle" fill="white" font-size="11" font-weight="bold">
                                Advice
                            </text>
                            <text x="470" y="95" text-anchor="middle" fill="#166534" font-size="10">
                                横断的関心事を分離
                            </text>
                        </g>
                    </svg>
                </div>

                <h3>Adviceの種類</h3>
                <p>AOPでよく使われるSpring Frameworkが用意するアドバイス（Advice）の種類と説明です。</p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Advice</th>
                                <th>内容</th>
                                <th>例</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Before Advice</strong><br />（@Before）</td>
                                <td>中心的関心事が「始まる前」に、追加の処理（横断的関心事）を行います</td>
                                <td>ログインチェック、権限チェックなど</td>
                            </tr>
                            <tr>
                                <td><strong>After Returning Advice</strong><br />（@AfterReturning）</td>
                                <td>中心的関心事が「正常に終了した後」に、追加の処理を行います</td>
                                <td>データベーストランザクションのコミット、成功メッセージの表示など</td>
                            </tr>
                            <tr>
                                <td><strong>After Throwing Advice</strong><br />（@AfterThrowing）</td>
                                <td>中心的関心事で「例外が発生した場合」、追加の処理を行います</td>
                                <td>エラーログの記録、ユーザーへのエラーメッセージ表示など</td>
                            </tr>
                            <tr>
                                <td><strong>After Advice</strong><br />（@After）</td>
                                <td>中心的関心事が「終了した後」に、成功か失敗かに関わらず、追加の処理を行います</td>
                                <td>リソースの解放、後処理など</td>
                            </tr>
                            <tr>
                                <td><strong>Around Advice</strong><br />（@Around）</td>
                                <td>
                                    中心的関心事の「前後」で、追加の処理を行います。このタイプは最も柔軟性があります
                                </td>
                                <td>処理時間の計測、トランザクションの制御など</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <p>
                    これらのアドバイスは、特定のタイミングで追加の処理（横断的関心事）を挿入するために使用されます。これにより、コードの再利用性とメンテナンス性が向上します。
                </p>

                <h3>Pointcut式</h3>
                <p>
                    自分でAdviceを作成する場合（具体的な作成方法は、「4-2
                    AOPのプログラムを作成しよう」で説明します）、パッケージ、クラス、メソッド等、Advice挿入対象を条件で指定できます。指定する条件方法にはPointcut式を使用します。Pointcut式は数種類ありますが、本書では「execution」指示子を説明します。
                </p>

                <div class="point-box">
                    <div class="point-box-title">💡 execution指示子の構文</div>
                    <code
                        style="
                            font-size: 14px;
                            background: white;
                            padding: 12px 16px;
                            border-radius: 8px;
                            display: block;
                        "
                    >
                        execution(戻り値の型　パッケージ.クラス.メソッド(引数))
                    </code>
                </div>

                <p>Pointcut式は以下に示すワイルドカードを利用することで、柔軟に適用範囲を指定することができます。</p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ワイルドカード</th>
                                <th>用途</th>
                                <th>説明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>*</strong>（アスタリスク）</td>
                                <td>パッケージ</td>
                                <td>任意の1階層のパッケージを表します</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>メソッドの引数</td>
                                <td>1つの任意の引数を表します</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>戻り値</td>
                                <td>任意の型の戻り値を表します</td>
                            </tr>
                            <tr>
                                <td><strong>..</strong>（ドット2文字）</td>
                                <td>パッケージ</td>
                                <td>0個以上の任意のパッケージを表します</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>メソッドの引数</td>
                                <td>0個以上の任意の引数を表します</td>
                            </tr>
                            <tr>
                                <td><strong>+</strong>（プラス）</td>
                                <td>クラス名の後</td>
                                <td>
                                    クラス名の後に記述すると、そのクラスとそのサブクラスや実装クラスすべてを表します
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4>execution指示子の記述例</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>記述例</th>
                                <th>内容</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>execution(* com.example.service.DemoService.*(..))</code></td>
                                <td>DemoServiceクラスのメソッドにAdviceを適用します</td>
                            </tr>
                            <tr>
                                <td><code>execution(* com.example.DemoService.select*(..))</code></td>
                                <td>DemoServiceクラスのselectで始まるメソッドにAdviceを適用します</td>
                            </tr>
                            <tr>
                                <td><code>execution(String com.example.service.DemoService.*(..))</code></td>
                                <td>DemoServiceクラスの戻り値がString型のメソッドにAdviceを適用します</td>
                            </tr>
                            <tr>
                                <td><code>execution(* com.example.service.DemoService.*(String,..))</code></td>
                                <td>DemoServiceクラスの最初の引数がString型のメソッドにAdviceを適用します</td>
                            </tr>
                            <tr>
                                <td><code>execution(* com.example.service.*.*(..))</code></td>
                                <td>
                                    指定されたパッケージ下のすべてのクラスのメソッドにAdviceを適用します（サブパッケージは含みません）
                                </td>
                            </tr>
                            <tr>
                                <td><code>execution(* com.example.service..*.*(..))</code></td>
                                <td>
                                    com.example.serviceパッケージおよびそのサブパッケージに存在するすべてのクラスのメソッドにAdviceを適用します
                                </td>
                            </tr>
                            <tr>
                                <td><code>execution(* com.example.service.DemoService.*(*))</code></td>
                                <td>DemoServiceクラスの引数が1つの任意の型であるメソッドにAdviceを適用します</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- コラム -->
                <div class="column">
                    <div class="column-header">
                        <span class="column-badge">Column</span>
                        <span class="column-title">現実世界の例でAOPをイメージする</span>
                    </div>

                    <h4 style="margin-top: 0; border: none; padding: 0">🏠 中心的関心事</h4>
                    <p>
                        「どの部屋を掃除するか」に当たります。つまり、キッチンを掃除する、リビングを片付ける、バスルームを磨くなど、それぞれの部屋での特有のタスクです。これがプログラミングで言う「中心的関心事」、つまりアプリケーションの主な機能や目的です。
                    </p>

                    <h4 style="border: none; padding: 0">🧹 横断的関心事</h4>
                    <p>
                        家の掃除で言うところの「ほうきやモップを使う」や「ゴミを拾う」など、どの部屋を掃除する時にも共通して必要になる作業です。プログラミングにおいては、ログの記録、セキュリティのチェック、エラーのハンドリングなど、多くの機能や部分に共通して影響を与える作業や処理がこれに当たります。
                    </p>

                    <h4 style="border: none; padding: 0">🎯 AOPの役割</h4>
                    <p>
                        AOPは、これら「横断的関心事」を「中心的関心事」から分離し、一箇所で管理します。掃除の例で言えば、どの部屋を掃除するにしても「ほうきやモップを使う」というルールを一箇所で定めておき、どの部屋を掃除する時もそのルールに従って作業を進めるようにすることです。
                    </p>

                    <p>
                        つまり、AOPを使うと、共通の作業（横断的関心事）を一箇所で管理し、それぞれの特定のタスク（中心的関心事）に集中できるようになり、全体として効率的でわかりやすいプログラムを作ることができるのです。
                    </p>
                </div>
            </section>

            <!-- セクション 4-2 -->
            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 4-2</span>
                    <h2 class="section-title">AOPのプログラムを作成しよう</h2>
                </div>

                <div class="intro-text">
                    <p>
                        自分でAdvice「アドバイス」を作成し、Pointcut式でAdvice「アドバイス」挿入場所を指定して、AOPの動きを確認できるプログラムを作成してみましょう。
                    </p>
                </div>

                <h3>プロジェクトの作成とAOP使用の準備</h3>
                <p>
                    eclipseを起動し、メニューの左上から「ファイル」→「新規」→「Springスターター・プロジェクト」を選択します。「新規Springスターター・プロジェクト」画面で、以下のように入力後「次へ」ボタンを押します。
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>設定項目</th>
                                <th>値</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>名前</td>
                                <td>AOPSample</td>
                            </tr>
                            <tr>
                                <td>タイプ</td>
                                <td>Gradle-Groovy</td>
                            </tr>
                            <tr>
                                <td>パッケージング</td>
                                <td>Jar</td>
                            </tr>
                            <tr>
                                <td>Javaバージョン</td>
                                <td>21</td>
                            </tr>
                            <tr>
                                <td>言語</td>
                                <td>Java</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <p>
                    依存関係で「Spring Boot
                    DevTools（開発者ツール）」を選択後「完了」ボタンを押すと、プロジェクトが作成されます。
                </p>
                <p>
                    AOPを使用するために作成したプロジェクト内、「Gradle」の設定ファイル「build.gradle」に<code
                        >implementation 'org.springframework.boot:spring-boot-starter-aop'</code
                    >を追記します。
                </p>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">build.gradle</span>
                    </div>
                    <div class="code-content">
                        <pre>dependencies {
    <span class="code-comment">// AOPを使用するために追加</span>
    <span class="code-method">implementation</span> <span class="code-string">'org.springframework.boot:spring-boot-starter-aop'</span>
    <span class="code-method">implementation</span> <span class="code-string">'org.springframework.boot:spring-boot-starter'</span>
    <span class="code-method">developmentOnly</span> <span class="code-string">'org.springframework.boot:spring-boot-devtools'</span>
    <span class="code-method">testImplementation</span> <span class="code-string">'org.springframework.boot:spring-boot-starter-test'</span>
}</pre>
                    </div>
                </div>

                <h3>Target「ターゲット」の作成</h3>
                <p>
                    「AOPSample」の「src/main/java」フォルダを選択し、マウスを右クリックし、「新規」→「クラス」を選択します。クラス設定画面にて以下の「設定内容」を記述後、「完了」ボタンを押します。
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>設定項目</th>
                                <th>値</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>パッケージ</td>
                                <td>com.example.demo.service</td>
                            </tr>
                            <tr>
                                <td>名前</td>
                                <td>TargetService</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="prompt-box">
                    <div class="prompt-box-header">
                        <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
                        <span class="prompt-box-title">プロンプト</span>
                        <button class="prompt-copy-btn">コピー</button>
                    </div>
                    <div class="prompt-box-content">
                        <pre><code>## 機能
AOPのターゲットとなるサービスクラスの作成

## 実装要件
- パッケージは「com.example.demo.service」
- クラス名は「TargetService」
- @Serviceアノテーションを付与（DIコンテナ登録）
- sayHello(String name)メソッドで挨拶を出力
- sayGoodbye(String name)メソッドで別れの挨拶を出力

## 使用するSpring構文/アノテーション
- @Service（サービス層のステレオタイプアノテーション）
- このクラスのメソッドがAOPのポイントカット対象となる</code></pre>
                    </div>
                </div>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">TargetService.java</span>
                    </div>
                    <div class="code-content">
                        <pre><span class="code-keyword">package</span> com.example.demo.service;

<span class="code-keyword">import</span> org.springframework.stereotype.Service;

<span class="code-annotation">@Service</span>
<span class="code-keyword">public class</span> <span class="code-class">TargetService</span> {

    <span class="code-keyword">public void</span> <span class="code-method">sayHello</span>(String name) {
        System.out.println(<span class="code-string">"ハロー, "</span> + name + <span class="code-string">"!"</span>);
    }

    <span class="code-keyword">public void</span> <span class="code-method">sayGoodbye</span>(String name) {
        System.out.println(<span class="code-string">"グッバイ, "</span> + name + <span class="code-string">"!"</span>);
    }
}</pre>
                    </div>
                </div>

                <p>5行目「@Service」でステレオタイプアノテーションを付与して、インスタンス生成対象にしています。</p>

                <h3>Aspect「アスペクト」の作成</h3>
                <p>
                    「AOPSample」の「src/main/java」フォルダを選択し、マウスを右クリックし、「新規」→「クラス」を選択します。クラス設定画面にて以下の「設定内容」を記述後、「完了」ボタンを押します。
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>設定項目</th>
                                <th>値</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>パッケージ</td>
                                <td>com.example.demo.aop</td>
                            </tr>
                            <tr>
                                <td>名前</td>
                                <td>LoggingAspect</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="prompt-box">
                    <div class="prompt-box-header">
                        <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
                        <span class="prompt-box-title">プロンプト</span>
                        <button class="prompt-copy-btn">コピー</button>
                    </div>
                    <div class="prompt-box-content">
                        <pre><code>## 機能
AOPでログ出力を行うアスペクトクラスの作成

## 実装要件
- パッケージは「com.example.demo.aop」
- クラス名は「LoggingAspect」
- @Aspectと@Componentアノテーションを付与
- beforeAdvice()メソッドで@Before実行前処理
- afterAdvice()メソッドで@After実行後処理
- aroundAdvice()メソッドで@Around前後処理
- ポイントカットはTargetServiceクラスの全メソッド

## 使用するSpring構文/アノテーション
- @Aspect（アスペクトクラスの宣言）
- @Component（DIコンテナへのBean登録）
- @Before（メソッド実行前のアドバイス）
- @After（メソッド実行後のアドバイス）
- @Around（メソッド実行前後のアドバイス）
- JoinPoint（実行中のメソッド情報取得）
- ProceedingJoinPoint（対象メソッドの実行制御）
- execution() ポイントカット式</code></pre>
                    </div>
                </div>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">LoggingAspect.java</span>
                    </div>
                    <div class="code-content">
                        <pre><span class="code-keyword">package</span> com.example.demo.aop;

<span class="code-keyword">import</span> java.time.LocalDateTime;
<span class="code-keyword">import</span> java.time.format.DateTimeFormatter;

<span class="code-keyword">import</span> org.aspectj.lang.JoinPoint;
<span class="code-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="code-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="code-keyword">import</span> org.springframework.stereotype.Component;

<span class="code-annotation">@Aspect</span>
<span class="code-annotation">@Component</span>
<span class="code-keyword">public class</span> <span class="code-class">LoggingAspect</span> {

    <span class="code-comment">// @Before("execution(* com.example.demo.service.TargetService.*(..))")</span>
    <span class="code-keyword">public void</span> <span class="code-method">beforeAdvice</span>(JoinPoint joinPoint) {
        LocalDateTime startTime = LocalDateTime.now(); <span class="code-comment">// 現在の日時を取得</span>
        String formattedTime = startTime.format(DateTimeFormatter.
            ofPattern(<span class="code-string">"HH:mm:ss:SSS"</span>));
        System.out.println(<span class="code-string">"------- [@Before] -------"</span>);
        System.out.println(<span class="code-string">"Before method:"</span> + joinPoint.getSignature());
        System.out.println(<span class="code-string">"メソッド開始: "</span> + formattedTime);
    }

    <span class="code-comment">// @After("execution(* com.example.demo.service.TargetService.*(..))")</span>
    <span class="code-keyword">public void</span> <span class="code-method">afterAdvice</span>(JoinPoint joinPoint) {
        LocalDateTime endTime = LocalDateTime.now(); <span class="code-comment">// 現在の日時を取得</span>
        String formattedTime = endTime.format(DateTimeFormatter.
            ofPattern(<span class="code-string">"HH:mm:ss:SSS"</span>));
        System.out.println(<span class="code-string">"------- [@After ] -------"</span>);
        System.out.println(<span class="code-string">"After  method:"</span> + joinPoint.getSignature());
        System.out.println(<span class="code-string">"メソッド終了: "</span> + formattedTime);
    }

    <span class="code-comment">// @Around("execution(* com.example.demo.service.TargetService.*(..))")</span>
    <span class="code-keyword">public</span> Object <span class="code-method">aroundAdvice</span>(ProceedingJoinPoint joinPoint) <span class="code-keyword">throws</span> Throwable {
        <span class="code-keyword">long</span> startTime = System.currentTimeMillis();
        System.out.println(<span class="code-string">"===== [@Around：前] ====="</span>);
        System.out.println(<span class="code-string">"■Target"</span>);
        System.out.println(<span class="code-string">"  クラス  :"</span> + joinPoint.getSignature().
            getDeclaringTypeName());
        System.out.println(<span class="code-string">"  メソッド:"</span> + joinPoint.getSignature().getName());

        Object result = joinPoint.proceed(); <span class="code-comment">// 実行メソッドを呼び出す</span>

        System.out.println(<span class="code-string">"===== [@Around：後] ====="</span>);
        <span class="code-keyword">long</span> elapsedTime = System.currentTimeMillis() - startTime;
        System.out.println(<span class="code-string">"Method execution time: "</span> + elapsedTime + <span class="code-string">"milliseconds."</span>);
        <span class="code-keyword">return</span> result;
    }
}</pre>
                    </div>
                </div>

                <p>
                    アドバイスを記述するクラスには、11行目「@Aspect」を付与し、そしてインスタンス生成のステレオタイプアノテーション12行目「@Component」を付与します。
                </p>
                <p>
                    15行目「@Before」は、指定されたPointcut式に一致するメソッドが呼び出される前に実行されるアドバイスを定義します。<code
                        >execution(* com.example.demo.service.TargetService.*(..))</code
                    >はPointcut式で、com.example.demo.service.TargetServiceクラスの任意のメソッドが呼び出される「前」にこのアドバイスが実行されることを指定します。
                </p>
                <p>
                    16行目「JoinPoint」は、アドバイスが適用される対象のメソッドやフィールドに関する情報を提供するオブジェクトです。
                </p>

                <div class="point-box">
                    <div class="point-box-title">💡 @Aroundが他のAdviceと違う点</div>
                    <ul style="margin: 0; padding-left: 20px">
                        <li>引数には「ProceedingJoinPoint」インターフェース型の引数を指定する</li>
                        <li>
                            Advice中で「ProceedingJoinPoint」インターフェースのproceed()メソッドを呼び出すことで、Targetのメソッドを呼び出せるため、前後で様々な処理を記述可能
                        </li>
                        <li>戻り値を返す必要がある場合は「Object型」の戻り値で値を返す</li>
                    </ul>
                </div>

                <h3>起動クラスの作成と動作確認</h3>
                <p>
                    デフォルトで作成される「com.example.demo」パッケージにある「AopSampleApplication」クラスの内容を以下のように修正します。
                </p>

                <div class="prompt-box">
                    <div class="prompt-box-header">
                        <span class="prompt-box-icon"><span class="material-icons">chat</span></span>
                        <span class="prompt-box-title">プロンプト</span>
                        <button class="prompt-copy-btn">コピー</button>
                    </div>
                    <div class="prompt-box-content">
                        <pre><code>## 機能
AOPサンプルを実行するSpring Boot起動クラスの作成

## 実装要件
- パッケージは「com.example.demo」
- クラス名は「AopSampleApplication」
- @SpringBootApplicationアノテーションを付与
- TargetServiceを@Autowiredで注入
- exe()メソッドでsayHello()とsayGoodbye()を呼び出す

## 使用するSpring構文/アノテーション
- @SpringBootApplication（Spring Boot起動クラス）
- @Autowired（DIコンテナからインスタンスを注入）
- SpringApplication.run()（アプリケーション起動）
- getBean()（DIコンテナからBeanを取得）</code></pre>
                    </div>
                </div>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">AopSampleApplication.java</span>
                    </div>
                    <div class="code-content">
                        <pre><span class="code-keyword">package</span> com.example.demo;

<span class="code-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="code-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="code-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="code-keyword">import</span> com.example.demo.service.TargetService;

<span class="code-annotation">@SpringBootApplication</span>
<span class="code-keyword">public class</span> <span class="code-class">AopSampleApplication</span> {
    <span class="code-comment">/** 起動 */</span>
    <span class="code-keyword">public static void</span> <span class="code-method">main</span>(String[] args) {
        SpringApplication.run(AopSampleApplication.<span class="code-keyword">class</span>, args)
            .getBean(AopSampleApplication.<span class="code-keyword">class</span>).exe();
    }

    <span class="code-comment">/** DI */</span>
    <span class="code-annotation">@Autowired</span>
    <span class="code-keyword">private</span> TargetService service;

    <span class="code-comment">/** 実行 */</span>
    <span class="code-keyword">private void</span> <span class="code-method">exe</span>() {
        service.sayHello(<span class="code-string">"太郎"</span>);
        <span class="code-comment">// わかりやすいように区切りを表示</span>
        System.out.println(<span class="code-string">"■□■□■□■□■□"</span>);
        service.sayGoodbye(<span class="code-string">"花子"</span>);
    }
}</pre>
                    </div>
                </div>

                <h4>@Beforeの確認</h4>
                <p>
                    LoggingAspectクラスの「@Before」のコメントを解除後、Javaファイル「AopSampleApplication」を選択し、マウスを右クリックし、「実行」→「Spring
                    Bootアプリケーション」を選択します。
                </p>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">@Before実行結果</span>
                    </div>
                    <div class="code-content">
                        <pre>
------- [@Before] -------
Before method: void com.example.demo.service.TargetService.sayHello(String)
メソッド開始: 08:44:05:115
ハロー, 太郎!
■□■□■□■□■□
------- [@Before] -------
Before method: void com.example.demo.service.TargetService.sayGoodbye(String)
メソッド開始: 08:44:05:117
グッバイ, 花子!</pre
                        >
                    </div>
                </div>

                <p>
                    Targetが呼ばれる「前」にAdviceが適応されることを確認できます。再度「@Before」をコメントアウトします。
                </p>

                <h4>@Afterの確認</h4>
                <p>LoggingAspectクラスの「@After」のコメントを解除後、同様に実行します。</p>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">@After実行結果</span>
                    </div>
                    <div class="code-content">
                        <pre>
ハロー, 太郎!
------- [@After ] -------
After  method: void com.example.demo.service.TargetService.sayHello(String)
メソッド終了: 08:45:23:809
■□■□■□■□■□
グッバイ, 花子!
------- [@After ] -------
After  method: void com.example.demo.service.TargetService.sayGoodbye(String)
メソッド終了: 08:45:23:810</pre
                        >
                    </div>
                </div>

                <p>
                    Targetが呼ばれる「後」にAdviceが適応されることを確認できます。再度「@After」をコメントアウトします。
                </p>

                <h4>@Aroundの確認</h4>
                <p>LoggingAspectクラスの「@Around」のコメントを解除後、同様に実行します。</p>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">@Around実行結果</span>
                    </div>
                    <div class="code-content">
                        <pre>
===== [@Around：前] =====
■Target
  クラス  : com.example.demo.service.TargetService
  メソッド: sayHello
ハロー, 太郎!
===== [@Around：後] =====
Method execution time: 1 milliseconds.
■□■□■□■□■□
===== [@Around：前] =====
■Target
  クラス  : com.example.demo.service.TargetService
  メソッド: sayGoodbye
グッバイ, 花子!
===== [@Around：後] =====
Method execution time: 0 milliseconds.</pre
                        >
                    </div>
                </div>

                <p>
                    Targetが呼ばれる「前後」にAdviceが適応されることを確認できます。なお、「After Returning
                    Advice」と「After Throwing Advice」も作り方は同じため今回は作成を割愛します。
                </p>
            </section>

            <!-- セクション 4-3 -->
            <section class="section">
                <div class="section-header">
                    <span class="section-number">Section 4-3</span>
                    <h2 class="section-title">Spring Frameworkが提供するAOP機能を理解しよう</h2>
                </div>

                <div class="intro-text">
                    <p>
                        Spring
                        Frameworkは様々な共通機能をAOPで提供しています。提供される機能は「アノテーション」をクラスやメソッドに付与することで利用できます。ここでは本書で後述するSpring
                        Frameworkが提供するAOPの1つ「トランザクション管理機能」について紹介します。
                    </p>
                </div>

                <h3>トランザクション管理</h3>
                <p>
                    トランザクション管理には「@Transactional」を使用します。「@Transactional」をメソッドに付与することで、データベースアクセス処理メソッドが正常終了したらトランザクションをコミットし、例外がスローされた場合はロールバックを行います。「@Transactional」アノテーションの具体的な説明は、使用方法含め後の章で説明しますので少々お待ちください。
                </p>

                <!-- トランザクション図 -->
<div class="diagram-container">
    <div class="diagram-title">図4.11 @Transactionalのメソッドへの付与</div>
    <svg class="diagram-svg" viewBox="0 0 550 200" width="550" height="200">
        <!-- 左側：トランザクション開始 -->
        <g transform="translate(20, 80)">
            <rect x="0" y="0" width="130" height="40" rx="6" fill="#22c55e"/>
            <text x="65" y="17" text-anchor="middle" fill="white" font-size="11" font-weight="bold">トランザクションの</text>
            <text x="65" y="32" text-anchor="middle" fill="white" font-size="11" font-weight="bold">開始</text>
        </g>
        
        <!-- 矢印：開始からメソッドへ -->
        <line x1="150" y1="100" x2="180" y2="100" stroke="#64748b" stroke-width="2" marker-end="url(#arrow4)"/>
        
        <!-- 中央：メソッド（@Transactional付き） -->
        <g transform="translate(190, 15)">
            <!-- アノテーション -->
            <rect x="0" y="40" width="140" height="30" rx="6" fill="#fbbf24"/>
            <text x="70" y="60" text-anchor="middle" fill="white" font-size="13" font-weight="bold">@Transactional</text>
            
            <!-- メソッド本体 -->
            <rect x="0" y="75" width="140" height="100" rx="8" fill="white" stroke="#0ea5e9" stroke-width="2"/>
            <text x="70" y="100" text-anchor="middle" fill="#1e293b" font-size="12" font-weight="bold">メソッド() {</text>
            <text x="70" y="125" text-anchor="middle" fill="#64748b" font-size="11">...</text>
            <text x="70" y="150" text-anchor="middle" fill="#64748b" font-size="11">...</text>
            <text x="70" y="168" text-anchor="middle" fill="#1e293b" font-size="12" font-weight="bold">}</text>
        </g>
        
        <!-- 矢印：メソッドからコミットへ -->
        <line x1="330" y1="100" x2="360" y2="100" stroke="#64748b" stroke-width="2" marker-end="url(#arrow4)"/>
        
        <!-- 右側：トランザクションコミット -->
        <g transform="translate(370, 80)">
            <rect x="0" y="0" width="130" height="40" rx="6" fill="#0ea5e9"/>
            <text x="65" y="17" text-anchor="middle" fill="white" font-size="11" font-weight="bold">トランザクションの</text>
            <text x="65" y="32" text-anchor="middle" fill="white" font-size="11" font-weight="bold">コミット</text>
        </g>
        
        <!-- 矢印マーカー定義 -->
        <defs>
            <marker id="arrow4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
            </marker>
        </defs>
    </svg>
</div>

                <h3>AOPのイメージ</h3>
                <p>最後にAOPの考え方をストーリーで説明します。AOPの理解に繋がるきっかけになれば幸いです。</p>
                <p>
                    例えば、プログラムの開発中に動作状況をチェックする「自分用の確認ログ」を多数のクラスに「System.out.println」文を書いて出力したいとします。これはものすごく面倒くさいやり方です。多数のクラスがあったら、それぞれのクラスのそれぞれのメソッドに「System.out.println」文を書かないといけません。
                </p>
                <p>
                    更にプログラムが完成したら、すべての「自分用の確認ログ」を削除しないといけないのです。こういう「多数のクラスにわたって共通して必要となる処理」が「<strong>横断的関心事</strong>」です。
                </p>
                <p>
                    もしも、さまざまなクラスの中にあるメソッドに「System.out.println」文を自動的に挿入できる機能があったら、これはかなり便利ですね。そして必要なくなった時にすべて自動的に削除できたら、これこそが「AOPの考え方」なのです。
                </p>

                <div class="comparison-box">
                    <div class="comparison-item primary">
                        <span class="comparison-label">中心的関心事</span>
                        <p>
                            アプリケーションが実現すべき主要な機能やビジネスロジックを指します。例えば、ユーザー認証、データベースのCRUD操作などがこれに該当します。
                        </p>
                    </div>
                    <div class="comparison-item secondary">
                        <span class="comparison-label">横断的関心事</span>
                        <p>
                            複数のコンポーネントや関数で共通して必要とされるが、主要なビジネスロジックとは直接関係ない機能を指します。例えば、ロギング、セキュリティ、トランザクション管理などです。
                        </p>
                    </div>
                </div>

                <p>
                    AOPの主な目的は、横断的関心事を「分離」し、コードの再利用性と保守性を高めることです。具体的には、Aspectと呼ばれるモジュールに横断的関心事をまとめ、既存のコード（中心的関心事）に影響を与えずにこれを適用します。
                </p>
                <p>
                    Spring
                    Frameworkは、AOPを用いて多くの「共通機能（トランザクション管理、セキュリティ、ロギングなど）」を提供しています。これにより、開発者はビジネスロジックに集中でき、コードの品質も向上します。
                </p>

                <!-- AOPのメリット -->
                <div class="merit-box">
                    <div class="diagram-title">図4.12 AOPのメリット</div>
                    <div class="merit-items">
                        <div class="merit-item">
                            <div class="merit-icon">🔄</div>
                            <div class="merit-text">コードの繰り返しが減る</div>
                        </div>
                        <div class="merit-item">
                            <div class="merit-icon">🎯</div>
                            <div class="merit-text">本質に集中できる</div>
                        </div>
                        <div class="merit-item">
                            <div class="merit-icon">🛠️</div>
                            <div class="merit-text">メンテナンスが楽になる</div>
                        </div>
                    </div>
                </div>

                <!-- 学習のワンポイント -->
                <div class="column">
                    <div class="column-header">
                        <span class="column-badge">Column</span>
                        <span class="column-title">学習のワンポイント</span>
                    </div>
                    <p>
                        プログラミングを学ぶ時、「ただコードを書く」のではなく、「どうやっていいコードを作るか」を考えることがすごく重要です。この考え方を学ぶのは、ちょうど建築ていい家を建てるために設計図を学ぶのと似ています。
                    </p>
                    <p>
                        <strong>DI（依存性の注入）</strong
                        >とAOP（アスペクト指向プログラミング）は、Springフレームワークでよく聞く言葉かもしれませんが、実はどんなプログラミング言語やフレームワークにも役立つ普遍的な概念です。
                    </p>
                    <p>
                        DIは、プログラムの一部が他の部分にどう依存しているかを上手に管理する方法です。AOPは、プログラムのあちこちで必要になる共通機能を、管理する方法です。
                    </p>
                    <p>
                        上記のようなソフトウェア設計の原則やパターンを学ぶことで、将来プログラムに変更や追加が必要になった時にもスムーズに対応できるようになります。つまり、変化に強く、長く使える「設計図」を作るスキルを身につけることができるわけです。これは、プログラミングの世界で長く生きていく上で、とても価値のある投資になります。
                    </p>
                </div>
            </section>
        </div>

        <footer class="footer">
            <p>Spring Framework 入門チュートリアル</p>
        </footer>

        <div class="page-nav">
            <a href="3di-tutorial.html" class="page-nav-btn prev">
                <span>←</span>
                <div>
                    <div class="page-nav-label">前の章</div>
                    <div class="page-nav-title">第3章</div>
                </div>
            </a>

            <a href="5mvc-tutorial.html" class="page-nav-btn next">
                <div>
                    <div class="page-nav-label">次の章</div>
                    <div class="page-nav-title">第5章</div>
                </div>
                <span>→</span>
            </a>
        </div>

        <script>
            function toggleMenu() {
                const toggle = document.querySelector(".nav-toggle");
                const menu = document.querySelector(".nav-menu");
                toggle.classList.toggle("active");
                menu.classList.toggle("active");
            }

            document.addEventListener("click", function (e) {
                const nav = document.querySelector(".global-nav");
                const toggle = document.querySelector(".nav-toggle");
                const menu = document.querySelector(".nav-menu");

                if (!nav.contains(e.target) && menu.classList.contains("active")) {
                    toggle.classList.remove("active");
                    menu.classList.remove("active");
                }
            });

            window.addEventListener("resize", function () {
                if (window.innerWidth >= 1024) {
                    const toggle = document.querySelector(".nav-toggle");
                    const menu = document.querySelector(".nav-menu");
                    toggle.classList.remove("active");
                    menu.classList.remove("active");
                }
            });
        </script>
    </body>
</html>
